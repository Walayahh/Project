<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StudyBuddy</title>

  <!-- Original Google API loader -->
  <script src="https://apis.google.com/js/api.js" defer></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Three.js & Vanta.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.dots.min.js" defer></script>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js" defer></script>

  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  defer
></script>

  <style>
    /* Enhanced CSS Styling for StudyBuddy */
/* Add these styles to the existing CSS */

/* Improved map styling */
#map {
  width: 100%;
  height: 500px;
  border-radius: var(--rad-m);
  margin-bottom: 1.5rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: var(--shadow-s);
  position: relative;
  z-index: 1;
}

/* Custom Leaflet styling */
.leaflet-container {
  background: #1e1e1e;
  font-family: 'Inter', sans-serif;
}

.leaflet-popup-content-wrapper {
  background: var(--bg-2);
  color: var(--txt-1);
  border-radius: var(--rad-m);
  padding: 0;
  box-shadow: var(--shadow-s);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.leaflet-popup-tip {
  background: var(--bg-2);
  box-shadow: var(--shadow-s);
}

.leaflet-popup-content {
  margin: 8px;
  width: auto !important;
}

.leaflet-control {
  margin: 10px !important;
}

.leaflet-bar a {
  background: var(--bg-2);
  color: var(--txt-1);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.leaflet-bar a:hover {
  background: var(--bg-3);
  color: var(--ac-1);
}

.leaflet-control-attribution {
  background: rgba(30, 30, 30, 0.7) !important;
  color: var(--txt-2) !important;
  backdrop-filter: blur(5px);
  padding: 3px 8px;
  border-radius: 4px;
}

.leaflet-control-attribution a {
  color: var(--ac-1) !important;
}

/* Enhanced study planner styling */
#plannerAdvice h3 {
  margin-top: 20px;
  margin-bottom: 10px;
  color: var(--ac-1);
  border-bottom: 1px solid var(--ac-1);
  padding-bottom: 5px;
}

#plannerAdvice div {
  line-height: 1.5;
}

#plannerAdvice strong {
  color: var(--ac-1);
}

/* Download button for study plan */
#downloadPlan {
  margin: 15px auto;
  display: block;
}

/* Enhanced forms */
#reviewForm, #plannerForm {
  background: var(--bg-3);
  padding: 15px;
  border-radius: var(--rad-m);
  margin-bottom: 20px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

#reviewForm input, #reviewForm select, #reviewForm textarea,
#plannerForm input, #plannerForm select, #plannerForm textarea {
  background: var(--bg-2);
  transition: all 0.2s ease;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

#reviewForm input:focus, #reviewForm select:focus, #reviewForm textarea:focus,
#plannerForm input:focus, #plannerForm select:focus, #plannerForm textarea:focus {
  border-color: var(--ac-1);
  box-shadow: 0 0 0 2px rgba(140, 103, 255, 0.2);
}

/* Better form layout for reviews */
#reviewForm {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

#reviewForm div:first-child {
  grid-column: span 2;
}

#reviewForm textarea {
  grid-column: span 2;
}

#reviewForm button {
  grid-column: span 2;
  margin-top: 0.5rem;
}

/* Enhanced cafe review cards */
.cafe-review-card {
  background: var(--bg-2);
  border-radius: var(--rad-m);
  padding: 1.25rem;
  box-shadow: var(--shadow-s);
  border: 1px solid rgba(255, 255, 255, 0.05);
  transition: all 0.3s ease;
  position: relative;
}

.cafe-review-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-l);
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.review-body {
  margin-bottom: 0.5rem;
  line-height: 1.5;
}

.review-rating {
  color: var(--ac-warn);
  font-size: 1.1rem;
}

.review-footer {
  font-size: 0.8rem;
  color: var(--txt-2);
  display: flex;
  justify-content: space-between;
  margin-top: 0.8rem;
  padding-top: 0.5rem;
  border-top: 1px solid rgba(255, 255, 255, 0.05);
}

/* Better styling for the review name input with datalist */
#reviewName {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255, 255, 255, 0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: 10px center;
  padding-left: 2.5rem;
}

/* Add smooth animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in {
  animation: fadeIn 0.4s ease forwards;
}

/* Add some visual flare to the study planner */
#planList .card {
  position: relative;
  overflow: hidden;
}

#planList .card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--ac-1), var(--ac-3));
  border-radius: var(--rad-s) 0 0 var(--rad-s);
}

#planList .card h4 {
  margin-left: 8px;
}

/* Enhanced planner button */
#planStudy {
  background: linear-gradient(135deg, var(--ac-1), var(--ac-2));
  padding: 0.8rem 1.6rem;
  font-weight: 600;
  letter-spacing: 0.5px;
  transition: all 0.3s ease;
  margin-bottom: 1rem;
}

#planStudy:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(140, 103, 255, 0.3);
}

/* Make loading indicators consistent */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(140, 103, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--ac-1);
  animation: spin 1s linear infinite;
  margin-right: 8px;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Add responsive improvements */
@media (max-width: 768px) {
  header {
    padding: 0.8rem 1rem;
  }
  
  .logo {
    font-size: 1.2rem;
  }
  
  main {
    padding: 1rem;
  }
  
  nav button {
    padding: 0.4rem 0.7rem;
    font-size: 0.9rem;
  }
  
  #map {
    height: 350px;
  }
  
  #reviewForm {
    display: block;
  }
  
  #timerDisplay {
    font-size: 2rem;
  }
  
  #tasksBoard {
    flex-direction: column;
  }
  
  .column {
    margin-bottom: 1rem;
  }
  
  #quotes {
    grid-template-columns: 1fr;
  }
}

/* Improve dark mode legibility */
::placeholder {
  color: rgba(176, 176, 176, 0.6);
}

select option {
  background-color: var(--bg-3);
}

/* Touch-specific enhancements */
.touch-device .task {
  position: relative;
}

.touch-device .task-buttons {
  position: absolute;
  right: 10px;
  display: flex;
  gap: 5px;
}

/* Focus styles for accessibility */
button:focus, input:focus, select:focus, textarea:focus {
  outline: 2px solid var(--ac-1);
  outline-offset: 2px;
}

/* Dark scrollbars for better aesthetics */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-1);
}

::-webkit-scrollbar-thumb {
  background: var(--bg-3);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--ac-1);
}

    :root {
      --bg-1:#121212; --bg-2:#1e1e1e; --bg-3:#2d2d2d;
      --txt-1:#fafafa; --txt-2:#b0b0b0;
      --ac-1:#8c67ff; --ac-2:#4f46e5; --ac-3:#ff6f91; --ac-warn:#f2c94c;
      --rad-s:6px; --rad-m:12px; --rad-l:20px;
      --shadow-s:0 4px 20px rgba(0,0,0,.15);
      --shadow-l:0 8px 30px rgba(0,0,0,.35);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
    body{background:var(--bg-1);color:var(--txt-1);min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;}
    a{color:var(--ac-1);text-decoration:none;transition:all .2s ease;}a:hover{text-decoration:underline;}
    #background{position:fixed;inset:0;z-index:-1;}
    header{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;padding:1rem 2rem;background:rgba(30,30,30,.85);backdrop-filter:blur(10px);box-shadow:var(--shadow-s);z-index:10;}
    .logo-container{display:flex;align-items:center;gap:.6rem;}
    .logo-icon{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--ac-1),var(--ac-2));display:grid;place-content:center;color:#fff;font-weight:700;}
    .logo{font-size:1.5rem;font-weight:700;background:linear-gradient(90deg,var(--ac-1),var(--ac-3));-webkit-background-clip:text;color:transparent;}
    nav{display:flex;gap:.3rem;flex-wrap:wrap;}
    nav button{background:none;border:none;color:var(--txt-2);padding:.55rem .95rem;border-radius:var(--rad-s);cursor:pointer;transition:all .2s ease;position:relative;}
    nav button:hover, nav button.active{background:rgba(140,103,255,.12);color:var(--txt-1);}
    nav button.active::after{content:'';position:absolute;left:50%;bottom:0;transform:translateX(-50%);width:22px;height:3px;background:var(--ac-1);border-radius:5px;}
    main{flex:1;max-width:1400px;margin:0 auto;padding:2rem;}
    section{display:none;animation:fade .35s ease-in-out;}section.active{display:block;}
    @keyframes fade{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
    h2.section-title{font-size:1.75rem;margin-bottom:1.4rem;}
    .card{background:var(--bg-2);padding:1.25rem;border-radius:var(--rad-m);box-shadow:var(--shadow-s);border:1px solid rgba(255,255,255,.05);transition:all .3s ease;position:relative;}
    .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-l);}
    .btn{display:inline-flex;align-items:center;gap:.45rem;border:none;cursor:pointer;padding:.7rem 1.4rem;font-weight:500;border-radius:var(--rad-s);box-shadow:0 2px 6px rgba(0,0,0,.2);transition:all .2s ease;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.3);}
    .btn-primary{background:var(--ac-1);color:#fff;} .btn-secondary{background:rgba(255,255,255,.1);color:var(--txt-1);} .btn-small{padding:.3rem .6rem;font-size:.8rem;}
    input,textarea,select{background:var(--bg-3);border:1px solid rgba(255,255,255,.1);color:var(--txt-1);padding:.75rem;border-radius:var(--rad-s);width:100%;margin-bottom:1rem;transition:border-color .2s ease;}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--ac-1);}
    /* Quotes */
    #quotes{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem;}
    #quotes .card{font-style:italic;text-align:center;color:var(--txt-2);}
    /* Pomodoro */
    #timerDisplay{font-size:2.5rem;text-align:center;margin:1rem 0;}
    #timerControls{display:flex;justify-content:center;gap:1rem;}
    /* Tasks */
    #tasksBoard{display:flex;gap:1rem;margin-top:1rem;}
    .column{background:var(--bg-2);flex:1;min-width:240px;padding:1rem;border-radius:var(--rad-m);position:relative;}
    .column h3{margin-bottom:.8rem;color:var(--txt-2);}
    .task{background:var(--bg-3);padding:.6rem 1rem;border-radius:var(--rad-s);margin-bottom:.6rem;display:flex;align-items:center;justify-content:space-between;}
    .task-buttons button{margin-left:.5rem;}
    /* Map */
    #map{width:100%;height:350px;border-radius:var(--rad-m);margin-bottom:1rem;}
    /* Reviews */
    .delete-review{position:absolute;top:4px;right:8px;cursor:pointer;color:var(--ac-warn);font-weight:bold;}
    .delete-review:hover{color:var(--ac-3);}
    /* Games */
    #gameSelect{margin-bottom:1rem;}
    /* Make iframe much bigger */
    #gameFrame{width:100%;height:80vh;border:none;border-radius:var(--rad-m);margin-top:1rem;box-shadow:var(--shadow-s);}
    /* Planner */
    #planList .card{margin-bottom:1rem;padding-right:2.5rem;}
    #plannerAdvice{margin-top:1rem;background:var(--bg-3);padding:1rem;border-radius:var(--rad-s);max-height:300px;overflow-y:auto;white-space:pre-wrap;line-height:1.5;}
    .delete-plan{position:absolute;top:10px;right:10px;cursor:pointer;color:var(--ac-warn);font-weight:bold;font-size:1.2rem;}
    .delete-plan:hover{color:var(--ac-3);}
    /* Chat */
    #chatToggle{position:fixed;bottom:1rem;right:1rem;width:56px;height:56px;border-radius:50%;background:var(--ac-1);color:#fff;font-size:1.5rem;border:none;cursor:pointer;box-shadow:var(--shadow-l);z-index:20;transition:transform 0.3s ease,box-shadow 0.3s ease;}
    #chatToggle:hover{transform:scale(1.1);box-shadow:0 10px 40px rgba(140,103,255,.4);}
    #chatWidget{position:fixed;bottom:1.5rem;right:1.5rem;width:340px;height:400px;background:var(--bg-2);border-radius:var(--rad-l);box-shadow:var(--shadow-l);display:flex;flex-direction:column;overflow:hidden;z-index:20;opacity:0;transform:translateY(20px) scale(0.8);pointer-events:none;transition:opacity .3s ease,transform .3s ease;}
    #chatWidget.open{opacity:1;transform:translateY(0) scale(1);pointer-events:all;}
    #chatHeader{background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;border-top-left-radius:var(--rad-l);border-top-right-radius:var(--rad-l);}
    #chatClose{background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;transition:transform .2s ease;}
    #chatClose:hover{transform:rotate(90deg);}
    #chatBody{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.7rem;scroll-behavior:smooth;background:rgba(18,18,18,.3);}
    .row{display:flex;}
    .row.me{justify-content:flex-end;}
    .row p{padding:.75rem 1rem;border-radius:18px;max-width:80%;font-size:.88rem;line-height:1.5;}
    .me p{background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;border-bottom-right-radius:6px;}
    .bot p{background:var(--bg-3);color:var(--txt-1);border-bottom-left-radius:6px;}
    #chatInput{display:flex;border-top:1px solid rgba(255,255,255,.06);}
    #chatInput input{flex:1;border:none;background:var(--bg-3);color:var(--txt-1);padding:.75rem 1rem;border-radius:var(--rad-s);margin:.5rem;outline:none;}
    #chatInput button{width:42px;height:42px;margin:.5rem;border-radius:50%;background:var(--ac-1);border:none;color:#fff;transition:all .2s ease;cursor:pointer;}
    #chatInput button:hover{transform:scale(1.1);background:var(--ac-2);}
    /* Celebration */
    #celebrationPopup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;padding:2rem;border-radius:var(--rad-l);text-align:center;z-index:100;box-shadow:var(--shadow-l);animation:popIn .5s cubic-bezier(.175,.885,.32,1.275) forwards;}
    #celebrationPopup .emoji{font-size:4rem;margin-bottom:1rem;display:block;}
    #celebrationPopup h2{font-size:2rem;margin-bottom:1rem;}
    #celebrationPopup button{margin-top:1rem;background:rgba(255,255,255,.2);border:none;color:#fff;padding:.5rem 1.5rem;border-radius:var(--rad-s);cursor:pointer;transition:all .2s ease;}
    #celebrationPopup button:hover{background:rgba(255,255,255,.3);}
    @keyframes popIn{0%{transform:translate(-50%,-50%) scale(.8);opacity:0;}100%{transform:translate(-50%,-50%) scale(1);opacity:1;}}
    :root {
      --bg-1: #121212;
      --bg-2: #1e1e1e;
      --bg-3: #2d2d2d;
      --txt-1: #fafafa;
      --txt-2: #b0b0b0;
      --ac-1: #8c67ff;
      --ac-2: #4f46e5;
      --ac-3: #ff6f91;
      --ac-warn: #f2c94c;
      --rad-s: 6px;
      --rad-m: 12px;
      --rad-l: 20px;
      --shadow-s: 0 4px 20px rgba(0, 0, 0, .15);
      --shadow-l: 0 8px 30px rgba(0, 0, 0, .35);
    }
  
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
  
    body {
      background: var(--bg-1);
      color: var(--txt-1);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }
  
    a {
      color: var(--ac-1);
      text-decoration: none;
      transition: all .2s ease;
    }
    a:hover {
      text-decoration: underline;
    }
  
    #background {
      position: fixed;
      inset: 0;
      z-index: -1;
    }
  
    header {
      position: sticky;
      top: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      background: rgba(30, 30, 30, .85);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-s);
      z-index: 10;
    }
  
    .logo-container {
      display: flex;
      align-items: center;
      gap: .6rem;
    }
  
    .logo-icon {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--ac-1), var(--ac-2));
      display: grid;
      place-content: center;
      color: #fff;
      font-weight: 700;
    }
  
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--ac-1), var(--ac-3));
      -webkit-background-clip: text;
      color: transparent;
    }
  
    nav {
      display: flex;
      gap: .3rem;
      flex-wrap: wrap;
    }
  
    nav button {
      background: none;
      border: none;
      color: var(--txt-2);
      padding: .55rem .95rem;
      border-radius: var(--rad-s);
      cursor: pointer;
      transition: all .2s ease;
      position: relative;
    }
    nav button:hover,
    nav button.active {
      background: rgba(140, 103, 255, .12);
      color: var(--txt-1);
    }
    #map {
      width: 100%;
      height: 500px;
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-s);
    }
  
    /* Improved cafe review styling */
    #reviewForm {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
  
    #reviewForm textarea {
      grid-column: span 2;
    }
  
    #reviewForm button {
      margin-top: 0.5rem;
    }
  
    /* Search input styling */
    .search-control input {
      background: var(--bg-3);
      color: var(--txt-1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.6rem;
      border-radius: var(--rad-s);
      width: 220px;
      box-shadow: var(--shadow-s);
      margin-bottom: 0 !important;
    }
  
    .search-control input:focus {
      outline: none;
      border-color: var(--ac-1);
    }
  
    /* Loading indicator */
    .loading-indicator span {
      background: rgba(30, 30, 30, 0.8);
      color: var(--txt-1);
      padding: 8px 12px;
      border-radius: var(--rad-s);
      font-size: 0.9rem;
      display: inline-block;
      box-shadow: var(--shadow-s);
    }
  
    /* Marker cluster styling */
    .marker-cluster {
      background-color: rgba(140, 103, 255, 0.6);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
  
    /* Leaflet popup styling */
    .leaflet-popup-content-wrapper {
      background: var(--bg-2);
      color: var(--txt-1);
      border-radius: var(--rad-m);
      padding: 0.5rem;
      box-shadow: var(--shadow-s);
    }
  
    .leaflet-popup-tip {
      background: var(--bg-2);
    }
  
    .leaflet-popup-content {
      margin: 0.5rem;
    }
  
    /* Enhanced review form */
    #cafeReviews {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
  
    .cafe-review-card {
      background: var(--bg-2);
      border-radius: var(--rad-m);
      padding: 1rem;
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }
  
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
  
    .review-body {
      margin-bottom: 0.5rem;
    }
  
    .review-footer {
      font-size: 0.8rem;
      color: var(--txt-2);
    }
    
    /* DataList enhancement */
    #reviewName {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255, 255, 255, 0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 2.5rem;
    }
    nav button.active::after {
      content: '';
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 22px;
      height: 3px;
      background: var(--ac-1);
      border-radius: 5px;
    }
  
    main {
      flex: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
  
    section {
      display: none;
      animation: fade .35s ease-in-out;
    }
    section.active {
      display: block;
    }
  
    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  
    h2.section-title {
      font-size: 1.75rem;
      margin-bottom: 1.4rem;
    }
  
    .card {
      background: var(--bg-2);
      padding: 1.25rem;
      border-radius: var(--rad-m);
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, .05);
      transition: all .3s ease;
      position: relative;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-l);
    }
  
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      border: none;
      cursor: pointer;
      padding: .7rem 1.4rem;
      font-weight: 500;
      border-radius: var(--rad-s);
      box-shadow: 0 2px 6px rgba(0, 0, 0, .2);
      transition: all .2s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, .3);
    }
  
    .btn-primary {
      background: var(--ac-1);
      color: #fff;
    }
    .btn-secondary {
      background: rgba(255, 255, 255, .1);
      color: var(--txt-1);
    }
    .btn-small {
      padding: .3rem .6rem;
      font-size: .8rem;
    }
  
    /* Inputs */
    input,
    textarea,
    select {
      background: var(--bg-3);
      border: 1px solid rgba(255, 255, 255, .1);
      color: var(--txt-1);
      padding: .75rem;
      border-radius: var(--rad-s);
      width: 100%;
      margin-bottom: 1rem;
      transition: border-color .2s ease;
    }
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--ac-1);
    }
  
    /* Quotes */
    #quotes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    #quotes .card {
      font-style: italic;
      text-align: center;
      color: var(--txt-2);
    }
  
    /* Pomodoro Timer */
    #timerDisplay {
      font-size: 2.5rem;
      text-align: center;
      margin: 1rem 0;
    }
    #timerControls {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
  
    /* Tasks Board */
    #tasksBoard {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    .column {
      background: var(--bg-2);
      flex: 1;
      min-width: 240px;
      padding: 1rem;
      border-radius: var(--rad-m);
      position: relative;
    }
    .column h3 {
      margin-bottom: .8rem;
      color: var(--txt-2);
    }
    .task {
      background: var(--bg-3);
      padding: .6rem 1rem;
      border-radius: var(--rad-s);
      margin-bottom: .6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .task-buttons button {
      margin-left: .5rem;
    }
  
    /* Map (Leaflet) */
    #map {
      width: 100%;
      height: 350px;
      border-radius: var(--rad-m);
      margin-bottom: 1rem;
    }
  
    /* Reviews */
    .delete-review {
      position: absolute;
      top: 4px;
      right: 8px;
      cursor: pointer;
      color: var(--ac-warn);
      font-weight: bold;
    }
    .delete-review:hover {
      color: var(--ac-3);
    }
  
    /* Games */
    #gameSelect {
      margin-bottom: 1rem;
    }
    #gameFrame {
      width: 100%;
      height: 80vh;
      border: none;
      border-radius: var(--rad-m);
      margin-top: 1rem;
      box-shadow: var(--shadow-s);
    }
  </style>
</head>
<body>
  <div id="background"></div>
  <header>
    <div class="logo-container"><div class="logo-icon">S</div><span class="logo">StudyBuddy</span></div>
    <nav>
      <button class="active" data-target="dashboard">Dashboard</button>
      <button data-target="cafes">CafÃ©s</button>
      <button data-target="games">Play</button>
      <button data-target="sessions">Sessions</button>
      <button data-target="planner">Planner</button>
    </nav>
  </header>

  <main>
    <!-- Dashboard -->
    <section id="dashboard" class="active">
      <h2 class="section-title">Dashboard</h2>
      <div id="quotes"></div>
      <button id="refreshQuotes" class="btn btn-small btn-primary">Refresh Quotes</button>

      <div class="card">
        <h3>Pomodoro Timer</h3>
        <div id="timerDisplay">25:00</div>
        <div id="timerControls">
          <button id="startTimer" class="btn btn-primary">Start</button>
          <button id="pauseTimer" class="btn btn-secondary">Pause</button>
          <button id="resetTimer" class="btn btn-secondary">Reset</button>
        </div>
      </div>

      <div class="card">
        <h3>Tasks</h3>
        <form id="newTaskForm">
          <input id="newTaskInput" type="text" placeholder="New taskâ€¦ (Enter or click Add)" required/>
          <button type="submit" class="btn btn-primary btn-small">Add</button>
        </form>
        <div id="tasksBoard">
          <div class="column" data-status="todo"><h3>To Do</h3></div>
          <div class="column" data-status="inprogress"><h3>In Progress</h3></div>
          <div class="column" data-status="completed"><h3>Completed</h3></div>
        </div>
      </div>
    </section>

    <!-- CafÃ©s -->
<!-- CafÃ©s -->
<section id="cafes">
  <h2 class="section-title">Study CafÃ©s</h2>
  <div id="map"></div>
  
  <div class="card">
    <h3>Add CafÃ© Review</h3>
    <form id="reviewForm">
      <div style="position: relative; grid-column: span 2;">
        <input id="reviewName" list="cafeList" type="text" placeholder="Choose a cafe or type a name..." required/>
        <datalist id="cafeList"></datalist>
      </div>
      <select id="reviewRating" required>
        <option value="">Select Rating...</option>
        <option value="1">â˜… (Poor)</option>
        <option value="2">â˜…â˜… (Fair)</option>
        <option value="3">â˜…â˜…â˜… (Good)</option>
        <option value="4">â˜…â˜…â˜…â˜… (Very Good)</option>
        <option value="5">â˜…â˜…â˜…â˜…â˜… (Excellent)</option>
      </select>
      <select id="reviewCategory" required>
        <option value="">Best For...</option>
        <option value="studying">Studying</option>
        <option value="reading">Reading</option>
        <option value="meetings">Meetings</option>
        <option value="relaxing">Relaxing</option>
        <option value="food">Food & Drinks</option>
      </select>
      <textarea id="reviewText" rows="3" placeholder="Share your experience... Were the tables good for studying? How was the WiFi? Was it quiet?" required></textarea>
      <button class="btn btn-primary" type="submit">Save Review</button>
    </form>
  </div>
  
  <div id="cafeReviews"></div>
</section>
    <!-- Games -->
    <section id="games">
      <h2 class="section-title">Take a Break</h2>
      <select id="gameSelect"></select>
      <iframe id="gameFrame"></iframe>
    </section>

    <!-- Sessions -->
    <section id="sessions">
      <h2 class="section-title">Study Sessions</h2>
      <div class="card">
        <h3>New Session</h3>
        <form id="sessionForm" class="grid two-col">
          <div><label>Topic</label><input id="sessionTopic" type="text" required/></div>
          <div><label>Date</label><input id="sessionDate" type="date" required/></div>
          <div><label>Duration</label><input id="sessionDuration" type="number" required/></div>
          <div style="grid-column:1/-1;"><button class="btn btn-primary" type="submit">Add</button></div>
        </form>
      </div>
      <ul id="sessionList"></ul>
    </section>

    <!-- Planner -->
    <section id="planner">
      <h2 class="section-title">Study Planner</h2>
      <div class="card">
        <h3>Add Planner Task</h3>
        <form id="plannerForm">
          <input id="planTitle" type="text" placeholder="Titleâ€¦" required style="width:48%;display:inline-block;margin-right:2%;"/>
          <select id="planCat" style="width:48%;display:inline-block;" required>
            <option value="">Categoryâ€¦</option><option>Homework</option><option>Reading</option><option>Project</option><option>Review</option>
          </select>
          <textarea id="planDesc" rows="2" placeholder="Descriptionâ€¦"></textarea>
          <input id="planDate" type="date" required/>
          <button class="btn btn-primary" type="submit">Add Task</button>
        </form>
      </div>
      <div id="planList"></div>
      <button id="planStudy" class="btn btn-primary">Plan My Study</button>
      <div id="plannerAdvice"></div>
    </section>
  </main>

  <!-- Chat -->
  <button id="chatToggle">ðŸ’¬</button>
  <div id="chatWidget">
    <div id="chatHeader">
      StudyBuddy AI
      <button id="chatClose">âœ•</button>
    </div>
    <div id="chatBody"></div>
    <form id="chatInput">
      <input type="text" placeholder="Ask a questionâ€¦" autocomplete="off" required/>
      <button type="submit">âž¤</button>
    </form>
  </div>

  <!-- Celebration -->
  <div id="celebrationPopup">
    <span class="emoji">ðŸŽ‰</span>
    <h2>Great Job!</h2>
    <p>You've completed a task!</p>
    <button id="closeCelebration">Continue</button>
  </div>

  <script>
    // StudyBuddy Clean Fix
// This script fixes the map initialization errors and review submission issues
// No fallbacks, no sample data - just pure fixes for the actual errors

(function() {
  console.log("StudyBuddy Clean Fix - Starting...");
  
  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function() {
    // ===== FIX MAP INITIALIZATION =====
    function fixMap() {
      console.log("Fixing map initialization...");
      
      const mapContainer = document.getElementById('map');
      if (!mapContainer) {
        console.log("Map container not found");
        return;
      }
      
      // Clean up any existing Leaflet instances to prevent "already initialized" error
      function cleanupExistingLeaflet() {
        // Remove any existing Leaflet containers
        document.querySelectorAll('.leaflet-container, .leaflet-control-container').forEach(el => {
          el.remove();
        });
        
        // Reset map container
        mapContainer.innerHTML = '';
        
        // Remove global references
        if (window.cafeMap) {
          try {
            window.cafeMap.remove();
          } catch(e) {
            console.log("Error removing existing map:", e);
          }
          window.cafeMap = null;
        }
      }
      
      // Clean up before initializing
      cleanupExistingLeaflet();
      
      // Function to initialize the map properly
      function initializeMap() {
        // Check if Leaflet is already loaded
        if (typeof L === 'undefined') {
          // If not, load Leaflet first
          console.log("Loading Leaflet library...");
          
          // Add Leaflet CSS
          const leafletCSS = document.createElement('link');
          leafletCSS.rel = 'stylesheet';
          leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
          document.head.appendChild(leafletCSS);
          
          // Add Leaflet JS with proper loading callback
          const leafletScript = document.createElement('script');
          leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
          leafletScript.onload = createMap;
          document.head.appendChild(leafletScript);
        } else {
          // Leaflet already loaded, create map directly
          createMap();
        }
      }
      
      // Function to create the actual map
      function createMap() {
        console.log("Creating map...");
        
        try {
          // Set loading indicator
          mapContainer.innerHTML = '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(30,30,30,0.7);"><div>Loading map...</div></div>';
          
          // Get user location with a fallback
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              // Success callback
              position => {
                setupMapWithCoordinates(position.coords.latitude, position.coords.longitude);
              },
              // Error callback
              error => {
                console.warn("Geolocation error:", error);
                // Use fallback coordinates (New York City)
                setupMapWithCoordinates(40.7128, -74.0060);
              },
              // Options
              { timeout: 5000, maximumAge: 60000 }
            );
          } else {
            // Geolocation not supported
            setupMapWithCoordinates(40.7128, -74.0060);
          }
        } catch (error) {
          console.error("Error in createMap:", error);
          mapContainer.innerHTML = '<div style="padding:20px;text-align:center;">Error loading map. Please refresh the page.</div>';
        }
      }
      
      // Function to setup map with coordinates
      function setupMapWithCoordinates(lat, lng) {
        try {
          // Clear container
          mapContainer.innerHTML = '';
          
          // Create map instance
          const map = L.map('map', {
            center: [lat, lng],
            zoom: 13,
            attributionControl: true,
            zoomControl: true
          });
          
          // Store reference
          window.cafeMap = map;
          
          // Add tile layer (dark theme)
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 19
          }).addTo(map);
          
          // Add user location marker
          const userMarker = L.marker([lat, lng], {
            title: 'Your Location'
          }).addTo(map);
          
          userMarker.bindPopup("Your Location").openPopup();
          
          // Add search radius circle
          const radiusCircle = L.circle([lat, lng], {
            radius: 2000, // 2km default radius
            color: 'rgba(140, 103, 255, 0.7)',
            fillColor: 'rgba(140, 103, 255, 0.1)',
            fillOpacity: 0.2,
            weight: 2
          }).addTo(map);
          
          // Fetch cafe data
          fetchCafes(map, lat, lng, 2000);
          
          console.log("Map created successfully");
        } catch (error) {
          console.error("Error setting up map:", error);
          mapContainer.innerHTML = '<div style="padding:20px;text-align:center;">Error initializing map. Please refresh the page.</div>';
        }
      }
      
      // Fetch cafes using Overpass API
      function fetchCafes(map, lat, lng, radius = 2000) {
        console.log(`Fetching cafes within ${radius}m of [${lat}, ${lng}]...`);
        
        // Query for cafes and study places
        const query = `
          [out:json][timeout:15];
          (
            node["amenity"="cafe"](around:${radius},${lat},${lng});
            node["amenity"="library"](around:${radius},${lat},${lng});
            node["shop"="coffee"](around:${radius},${lat},${lng});
          );
          out body;
        `;
        
        // Create loading indicator
        const loadingEl = document.createElement('div');
        loadingEl.style.cssText = 'position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(30,30,30,0.7);color:white;padding:5px 10px;border-radius:4px;z-index:1000;';
        loadingEl.textContent = 'Finding nearby cafes...';
        mapContainer.appendChild(loadingEl);
        
        // Fetch data with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'data=' + encodeURIComponent(query),
          signal: controller.signal
        })
        .then(response => {
          clearTimeout(timeoutId);
          return response.json();
        })
        .then(data => {
          // Remove loading indicator
          loadingEl.remove();
          
          if (data && data.elements && data.elements.length > 0) {
            // Process results
            addCafesToMap(map, data.elements);
            updateCafeList(data.elements);
          } else {
            console.log("No cafes found nearby");
          }
        })
        .catch(error => {
          clearTimeout(timeoutId);
          loadingEl.remove();
          console.error("Error fetching cafes:", error);
        });
      }
      
      // Add cafes to map
      function addCafesToMap(map, elements) {
        console.log(`Adding ${elements.length} locations to map`);
        
        // Define marker types
        const types = {
          cafe: { color: '#8c67ff', icon: 'â˜•' },
          library: { color: '#4f46e5', icon: 'ðŸ“š' },
          coffee: { color: '#8c67ff', icon: 'â˜•' },
          default: { color: '#8c67ff', icon: 'ðŸ“' }
        };
        
        // Process each location
        elements.forEach(element => {
          if (element.type !== 'node' || !element.lat || !element.lon) return;
          
          // Determine type
          let type = 'default';
          if (element.tags) {
            if (element.tags.amenity === 'cafe') type = 'cafe';
            else if (element.tags.amenity === 'library') type = 'library';
            else if (element.tags.shop === 'coffee') type = 'coffee';
          }
          
          // Get name
          const name = element.tags?.name || `Study Spot #${element.id.toString().slice(-4)}`;
          
          // Create marker with icon
          const marker = L.marker([element.lat, element.lon], {
            icon: L.divIcon({
              html: `<div style="background:${types[type].color};color:white;width:25px;height:25px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;">${types[type].icon}</div>`,
              className: '',
              iconSize: [25, 25],
              iconAnchor: [12, 12]
            }),
            title: name
          }).addTo(map);
          
          // Create popup content
          let address = '';
          if (element.tags) {
            const parts = [];
            if (element.tags['addr:housenumber']) parts.push(element.tags['addr:housenumber']);
            if (element.tags['addr:street']) parts.push(element.tags['addr:street']);
            if (element.tags['addr:city']) parts.push(element.tags['addr:city']);
            address = parts.join(', ');
          }
          
          const popupContent = `
            <div style="width:200px;">
              <h3 style="margin:0 0 5px;color:${types[type].color}">${name}</h3>
              ${address ? `<p style="margin:5px 0;font-size:12px;"><strong>Address:</strong> ${address}</p>` : ''}
              ${element.tags?.opening_hours ? `<p style="margin:5px 0;font-size:12px;"><strong>Hours:</strong> ${element.tags.opening_hours}</p>` : ''}
              <button onclick="selectCafeForReview('${name.replace(/'/g, "\\'")}')" 
                style="width:100%;margin-top:5px;background:${types[type].color};color:white;border:none;padding:5px;border-radius:4px;cursor:pointer;">
                Add Review
              </button>
            </div>
          `;
          
          marker.bindPopup(popupContent);
        });
      }
      
      // Update cafe list in datalist
      function updateCafeList(elements) {
        const cafeList = document.getElementById('cafeList');
        if (!cafeList) return;
        
        // Get unique names
        const names = elements
          .filter(el => el.tags && el.tags.name)
          .map(el => el.tags.name);
          
        // Sort and make unique
        const uniqueNames = [...new Set(names)].sort();
        
        // Update datalist
        cafeList.innerHTML = '';
        uniqueNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          cafeList.appendChild(option);
        });
        
        console.log(`Added ${uniqueNames.length} cafes to selection list`);
      }
      
      // Initialize map
      initializeMap();
    }
    
    // ===== FIX REVIEW FORM =====
    function fixReviewForm() {
      console.log("Fixing review form submission...");
      
      const reviewForm = document.getElementById('reviewForm');
      if (!reviewForm) {
        console.log("Review form not found");
        return;
      }
      
      // Ensure cafe selection from map works
      window.selectCafeForReview = function(cafeName) {
        console.log(`Selected cafe: ${cafeName}`);
        const reviewNameInput = document.getElementById('reviewName');
        if (reviewNameInput) {
          reviewNameInput.value = cafeName;
          
          // Scroll to form
          reviewForm.scrollIntoView({ behavior: 'smooth' });
          
          // Focus rating next
          setTimeout(() => {
            document.getElementById('reviewRating')?.focus();
          }, 300);
        }
      };
      
      // Replace existing handler with fixed one
      // First, clone the form to remove existing listeners
      const newForm = reviewForm.cloneNode(true);
      reviewForm.parentNode.replaceChild(newForm, reviewForm);
      
      // Now add our fixed handler
      newForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form values
        const name = document.getElementById('reviewName')?.value?.trim();
        const rating = document.getElementById('reviewRating')?.value;
        const category = document.getElementById('reviewCategory')?.value;
        const text = document.getElementById('reviewText')?.value?.trim();
        
        console.log("Review submission:", { name, rating, category, text });
        
        // Validate (without alerts)
        let isValid = true;
        let firstInvalidField = null;
        
        // Clear existing error styling
        ['reviewName', 'reviewRating', 'reviewCategory', 'reviewText'].forEach(id => {
          const field = document.getElementById(id);
          if (field) field.style.border = '';
        });
        
        // Check each field
        if (!name) {
          isValid = false;
          markInvalid('reviewName');
          firstInvalidField = firstInvalidField || 'reviewName';
        }
        
        if (!rating) {
          isValid = false;
          markInvalid('reviewRating');
          firstInvalidField = firstInvalidField || 'reviewRating';
        }
        
        if (!category) {
          isValid = false;
          markInvalid('reviewCategory');
          firstInvalidField = firstInvalidField || 'reviewCategory';
        }
        
        if (!text) {
          isValid = false;
          markInvalid('reviewText');
          firstInvalidField = firstInvalidField || 'reviewText';
        }
        
        // If invalid, focus first invalid field and show error message
        if (!isValid) {
          if (firstInvalidField) {
            document.getElementById(firstInvalidField)?.focus();
          }
          showMessage("Please fill in all required fields", "error");
          return;
        }
        
        // Save the review data
        try {
          // Get existing reviews
          let reviews = [];
          try {
            const existingReviews = localStorage.getItem('sb-reviews');
            if (existingReviews) {
              reviews = JSON.parse(existingReviews);
              if (!Array.isArray(reviews)) {
                console.warn("Stored reviews is not an array, resetting");
                reviews = [];
              }
            }
          } catch (e) {
            console.error("Error parsing stored reviews:", e);
            reviews = [];
          }
          
          // Create review object
          const review = {
            name: name,
            rating: parseInt(rating),
            category: category,
            text: text,
            date: new Date().toISOString().split('T')[0]
          };
          
          // Add to array
          reviews.push(review);
          
          // Save to localStorage
          localStorage.setItem('sb-reviews', JSON.stringify(reviews));
          
          console.log("Review saved successfully:", review);
          
          // Reset form
          newForm.reset();
          
          // Show success message
          showMessage("Review added successfully!", "success");
          
          // Call renderReviews if it exists
          if (typeof renderReviews === 'function') {
            try {
              renderReviews();
            } catch (e) {
              console.error("Error calling renderReviews:", e);
            }
          }
        } catch (error) {
          console.error("Error saving review:", error);
          showMessage("Error saving review. Please try again.", "error");
        }
      });
      
      // Helper to mark invalid fields
      function markInvalid(fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
          field.style.border = '1px solid #ff6464';
        }
      }
      
      // Helper to show toast-style messages
      function showMessage(message, type) {
        // Create toast element
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 10px 15px;
          border-radius: 4px;
          color: white;
          z-index: 10000;
          box-shadow: 0 2px 10px rgba(0,0,0,0.2);
          animation: toastIn 0.3s forwards;
        `;
        
        // Set color based on type
        if (type === 'error') {
          toast.style.background = 'rgba(255,100,100,0.9)';
        } else if (type === 'success') {
          toast.style.background = 'rgba(46,204,113,0.9)';
        } else {
          toast.style.background = 'rgba(52,152,219,0.9)';
        }
        
        // Add message
        toast.textContent = message;
        
        // Add to body
        document.body.appendChild(toast);
        
        // Add animation style
        const style = document.createElement('style');
        style.textContent = `
          @keyframes toastIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
          @keyframes toastOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100px); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s forwards';
          setTimeout(() => {
            if (document.body.contains(toast)) {
              document.body.removeChild(toast);
            }
          }, 300);
        }, 3000);
      }
    }
    
    // Fix the map
    fixMap();
    
    // Fix the review form
    fixReviewForm();
    
    console.log("StudyBuddy Clean Fix complete!");
  });
})();
    
    let CONFIG = {};
    async function fetchConfig(){
      try {
        console.log("Fetching configâ€¦");
        CONFIG = await (await fetch('/api/config')).json();
        console.log("CONFIG:", CONFIG);
      } catch(e){
        console.error("Config fetch failed", e);
      }
    }

    

    // NAV
    function initNav(){
      document.querySelectorAll('nav button').forEach(btn=>{
        btn.onclick=()=>{
          document.querySelector('nav button.active').classList.remove('active');
          btn.classList.add('active');
          document.querySelector('section.active').classList.remove('active');
          document.getElementById(btn.dataset.target).classList.add('active');
        };
      });
    }

    // Update the main initialization to incorporate our enhanced components
document.addEventListener('DOMContentLoaded', async () => {
  // Initialize background effect
  VANTA.DOTS({
    el: '#background',
    mouseControls: true,
    touchControls: true,
    gyroControls: false,
    minHeight: 200,
    minWidth: 200,
    scale: 1,
    scaleMobile: 1,
    color: 0x8c67ff,
    color2: 0x4f46e5,
    backgroundColor: 0x121212,
    size: 3,
    spacing: 25,
    showLines: false
  });
  
  // Fetch configuration
  await fetchConfig();
  
  // Initialize all components with enhanced versions
  initNav();
  initQuotes();
  initPomodoro();
  initTasks();
  initCafe(); // Enhanced cafe map functionality
  initGames();
  initSessions();
  initPlanner(); // Enhanced planner functionality
  initChat();
  
  // Add responsive improvements
  makeResponsive();
});

// Add some additional responsive improvements
function makeResponsive() {
  // Handle mobile screens better
  function adjustForScreenSize() {
    const isMobile = window.innerWidth < 768;
    
    // Adjust map height based on screen size
    const mapEl = document.getElementById('map');
    if (mapEl) {
      mapEl.style.height = isMobile ? '350px' : '500px';
    }
    
    // Adjust review form layout
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
      reviewForm.style.display = isMobile ? 'block' : 'grid';
    }
    
    // Force map to redraw if it exists
    if (window.leafletMap) {
      setTimeout(() => window.leafletMap.invalidateSize(), 100);
    }
  }
  
  // Call immediately and on resize
  adjustForScreenSize();
  window.addEventListener('resize', adjustForScreenSize);
  
  // Improve touch handling for draggable items
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  if (isTouchDevice) {
    document.documentElement.classList.add('touch-device');
    
    // Add hint for touch users on task cards
    const taskBoard = document.getElementById('tasksBoard');
    if (taskBoard) {
      const hint = document.createElement('div');
      hint.style.cssText = 'font-size:0.8rem;color:var(--txt-2);margin-bottom:10px;text-align:center;';
      hint.textContent = 'Tap tasks to see options';
      taskBoard.parentNode.insertBefore(hint, taskBoard);
    }
  }
}

// Add better error handling for the app overall
window.addEventListener('error', function(e) {
  console.error("Application error:", e);
  
  // Don't show errors for expected issues
  if (e.message && (
      e.message.includes('ResizeObserver loop') || 
      e.message.includes('Script error') ||
      e.message.includes('Uncaught'))) {
    return;
  }
  
  // Show a user-friendly error message
  const errorDiv = document.createElement('div');
  errorDiv.style.cssText = 'position:fixed;bottom:20px;left:20px;background:rgba(255,100,100,0.9);color:white;' +
                          'padding:10px 20px;border-radius:4px;font-size:14px;z-index:10000;max-width:80%;' +
                          'box-shadow:0 4px 12px rgba(0,0,0,0.3);';
  errorDiv.innerHTML = 'Something went wrong. <button id="errorDismiss" style="background:rgba(255,255,255,0.3);border:none;color:white;padding:3px 8px;border-radius:3px;cursor:pointer;margin-left:10px;">Dismiss</button>';
  document.body.appendChild(errorDiv);
  
  document.getElementById('errorDismiss').addEventListener('click', function() {
    errorDiv.remove();
  });
  
  // Auto-remove after 8 seconds
  setTimeout(() => {
    if (document.body.contains(errorDiv)) {
      errorDiv.remove();
    }
  }, 8000);
});

// Add this to ensure Leaflet loads properly
document.addEventListener('DOMContentLoaded', function() {
  // Ensure Leaflet has loaded
  if (typeof L === 'undefined') {
    // Try to load Leaflet dynamically if not available
    const leafletCss = document.createElement('link');
    leafletCss.rel = 'stylesheet';
    leafletCss.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(leafletCss);
    
    const leafletScript = document.createElement('script');
    leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    document.head.appendChild(leafletScript);
    
    leafletScript.onload = function() {
      console.log('Leaflet loaded dynamically');
      // Initialize cafe maps after Leaflet loads
      if (typeof initCafe === 'function') {
        initCafe();
      }
    };
  }
  
  // Add marker clustering library
  if (typeof L !== 'undefined' && typeof L.markerClusterGroup === 'undefined') {
    const clusterScript = document.createElement('script');
    clusterScript.src = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js';
    document.head.appendChild(clusterScript);
    
    const clusterCss = document.createElement('link');
    clusterCss.rel = 'stylesheet';
    clusterCss.href = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css';
    document.head.appendChild(clusterCss);
    
    const clusterDefaultCss = document.createElement('link');
    clusterDefaultCss.rel = 'stylesheet';
    clusterDefaultCss.href = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css';
    document.head.appendChild(clusterDefaultCss);
  }
});

    // QUOTES
    const quotesList = ["Start where you are.","Progress over perfection.","One step at a time.","Dream, believe, do.","Focus and win.","Every day is a second chance.","Small progress is progress.","Stay positive.","Believe you can.","Do it now.","Keep pushing.","Consistency is key.","Success is a journey.","You got this.","Make today count."];
    function renderQuotes(){
      const c=document.getElementById('quotes');c.innerHTML='';
      quotesList.sort(()=>0.5-Math.random()).slice(0,3).forEach(q=>{
        const d=document.createElement('div');d.className='card';d.textContent=`"${q}"`;c.append(d);
      });
    }
    function initQuotes(){
      renderQuotes();
      document.getElementById('refreshQuotes').onclick=renderQuotes;
    }

    // POMODORO
    let pomTime=25*60, pomInterval, pomRunning=false;
    function updatePom(){
      const m=String(Math.floor(pomTime/60)).padStart(2,'0'),
            s=String(pomTime%60).padStart(2,'0');
      document.getElementById('timerDisplay').textContent=`${m}:${s}`;
      document.title=`(${m}:${s}) StudyBuddy`;
    }
    function initPomodoro(){
      updatePom();
      document.getElementById('startTimer').onclick=()=>{
        if(pomRunning) return;
        pomRunning=true;
        pomInterval=setInterval(()=>{
          if(pomTime>0){pomTime--;updatePom();}
          else{clearInterval(pomInterval);pomRunning=false;confetti({particleCount:100,spread:70,origin:{y:0.6}});alert('Done!');document.title='StudyBuddy';}
        },1000);
      };
      document.getElementById('pauseTimer').onclick=()=>{clearInterval(pomInterval);pomRunning=false;};
      document.getElementById('resetTimer').onclick=()=>{clearInterval(pomInterval);pomRunning=false;pomTime=25*60;updatePom();};
    }

    // TASKS
    function getTasks(){
      let raw;
      try{ raw=JSON.parse(localStorage.getItem('sb-tasks')); }
      catch(e){ raw=null; console.warn("Invalid tasks data",e); }
      let t;
      if(Array.isArray(raw)){
        console.log("Legacy task-array found, migrating");
        t={todo:raw, inprogress:[], completed:[]};
      } else if(raw && typeof raw==='object'){
        t=raw;
      } else {
        t={todo:[],inprogress:[],completed:[]};
      }
      t.todo  = Array.isArray(t.todo) ? t.todo : [];
      t.inprogress = Array.isArray(t.inprogress) ? t.inprogress : [];
      t.completed  = Array.isArray(t.completed) ? t.completed : [];
      console.log("Loaded tasks:", t);
      return t;
    }
    function saveTasks(t){
      console.log("Saving tasks:", t);
      localStorage.setItem('sb-tasks',JSON.stringify(t));
    }
    function renderTasks(){
      const all=getTasks();
      ['todo','inprogress','completed'].forEach(status=>{
        const col=document.querySelector(`.column[data-status="${status}"]`);
        const title=col.querySelector('h3').textContent;
        col.innerHTML=`<h3>${title}</h3>`;
        all[status].forEach((txt,i)=>{
          const task=document.createElement('div');task.className='task';
          task.innerHTML=`
            <span>${txt}</span>
            <div class="task-buttons">
              ${status==='todo'?`<button data-action="start" data-index="${i}" class="btn btn-small btn-primary">Start</button>`:''}
              ${status==='inprogress'?`<button data-action="complete" data-index="${i}" class="btn btn-small btn-primary">Complete</button>`:''}
              <button data-action="delete" data-status="${status}" data-index="${i}" class="btn btn-small btn-secondary">Ã—</button>
            </div>
          `;
          col.append(task);
        });
      });
    }
    function initTasks(){
      console.log("initTasks()");
      document.getElementById('newTaskForm').addEventListener('submit',e=>{
        e.preventDefault();
        const v=document.getElementById('newTaskInput').value.trim();
        console.log("Adding task:",v);
        if(!v) return;
        const all=getTasks();
        all.todo.push(v);
        saveTasks(all);
        renderTasks();
        e.target.reset();
      });
      document.getElementById('tasksBoard').addEventListener('click',e=>{
        const btn=e.target.closest('button[data-action]');
        if(!btn) return;
        const action=btn.dataset.action;
        const all=getTasks();
        console.log("Task action:",action,btn.dataset);
        if(action==='delete'){
          all[btn.dataset.status].splice(+btn.dataset.index,1);
        }
        if(action==='start'){
          const [t]=all.todo.splice(+btn.dataset.index,1);
          all.inprogress.push(t);
        }
        if(action==='complete'){
          const [t]=all.inprogress.splice(+btn.dataset.index,1);
          all.completed.push(t);
          confetti({particleCount:100,spread:70,origin:{y:0.6}});
          document.getElementById('celebrationPopup').style.display='block';
          setTimeout(()=>document.getElementById('celebrationPopup').style.display='none',3000);
        }
        saveTasks(all);
        renderTasks();
      });
      renderTasks();
      document.getElementById('closeCelebration').onclick=()=>{
        document.getElementById('celebrationPopup').style.display='none';
      };
    }
    
  
    // on DOMContentLoaded include initCafe
    document.addEventListener('DOMContentLoaded', function() {
      initCafe();
    });
    function startMap(pos){
      console.log("startMap at",pos);
      const mp=new google.maps.Map(document.getElementById('map'),{center:pos,zoom:14});
      new google.maps.Marker({map:mp,position:pos,title:'You'});
      const svc=new google.maps.places.PlacesService(mp);
      svc.nearbySearch({location:pos,radius:1500,type:['cafe']},(res,st)=>{
        console.log("PlacesService:",st,res);
        if(st==='OK')res.forEach(p=>new google.maps.Marker({map:mp,position:p.geometry.location,title:p.name}));
      });
    }
// Replace the entire initCafe function with this improved version
// Enhanced Cafe Map with Real Cafes and Better Performance
// Fixed Cafe Map Implementation with REAL cafe data only - No simulated cafes
// DIRECT REPLACEMENT FOR CAFE MAP IMPLEMENTATION - NO ALERTS
// COMPLETELY REWRITTEN CAFE MAP AND REVIEW IMPLEMENTATION
// This replaces both initCafe and renderReviews with fixed implementations

// Main cafe initialization function
function initCafe() {
  console.log("Initializing cafe map - complete rewrite");
  
  // DOM elements
  const mapContainer = document.getElementById('map');
  const cafeList = document.getElementById('cafeList');
  const reviewForm = document.getElementById('reviewForm');
  const reviewName = document.getElementById('reviewName');
  const cafeReviews = document.getElementById('cafeReviews');
  
  // Fix map size - make it much bigger
  if (mapContainer) {
    mapContainer.style.height = '600px';
    mapContainer.style.width = '100%';
  }
  
  // Global variables
  let map = null;
  let userMarker = null;
  let searchCircle = null;
  let cafeMarkers = [];
  let allCafes = [];
  
  // Initialize the map
  function initializeMap() {
    if (!mapContainer) return;
    
    // Show loading state
    mapContainer.innerHTML = `
      <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(30,30,30,0.8);z-index:999;
           display:flex;align-items:center;justify-content:center;flex-direction:column;">
        <div style="width:40px;height:40px;border:4px solid rgba(140,103,255,0.3);border-radius:50%;
             border-top-color:#8c67ff;animation:spin 1s linear infinite;margin-bottom:15px;"></div>
        <div style="color:white;font-size:16px;">Loading map...</div>
        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
      </div>
    `;
    
    try {
      // Get user location with proper error handling
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          // Success callback
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            setupMap(lat, lng);
          },
          // Error callback
          (error) => {
            console.warn("Geolocation error:", error.message);
            // Default to a central location
            setupMap(25.276987, 55.296249); // Default location
          },
          // Options
          { 
            timeout: 10000, 
            enableHighAccuracy: false,
            maximumAge: 600000 // 10 minutes
          }
        );
      } else {
        // Geolocation not supported
        setupMap(25.276987, 55.296249); // Default location
      }
    } catch (error) {
      console.error("Map initialization error:", error);
      showMapError("Could not initialize map. Please try again.");
    }
  }
  
  // Create the actual map
  function setupMap(lat, lng) {
    try {
      // Clear container
      mapContainer.innerHTML = '';
      
      // Create map object
      map = L.map('map', {
        center: [lat, lng],
        zoom: 14,
        zoomControl: true,
        attributionControl: true,
        // Use canvas renderer for better performance
        renderer: L.canvas(),
        preferCanvas: true
      });
      
      // Store a reference to the map
      window.leafletMap = map;
      
      // Add the base map layer - try multiple sources for reliability
      try {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);
      } catch (error) {
        console.error("Error loading primary tile source:", error);
        
        // Try fallback tile source
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);
      }
      
      // Add user location marker - using standard marker to avoid errors
      userMarker = L.marker([lat, lng], {
        title: 'Your Location',
        zIndexOffset: 1000
      }).addTo(map);
      
      userMarker.bindPopup('Your location').openPopup();
      
      // Add search radius circle
      searchCircle = L.circle([lat, lng], {
        radius: 5000, // Default 5km radius
        color: '#8c67ff',
        fillColor: '#8c67ff',
        fillOpacity: 0.05,
        weight: 1
      }).addTo(map);
      
      // Add custom controls to the map
      addMapControls();
      
      // Fetch cafes
      fetchCafes(lat, lng, 5000);
      
    } catch (error) {
      console.error("Error setting up map:", error);
      showMapError("Error creating map. Please reload the page.");
    }
  }
  
  // Add custom controls to the map
  function addMapControls() {
    // Add radius control
    const radiusControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        container.style.background = 'rgba(30,30,30,0.8)';
        container.style.padding = '10px';
        container.style.borderRadius = '4px';
        container.style.color = 'white';
        container.innerHTML = `
          <label style="display:block;margin-bottom:5px;font-size:12px;color:#b0b0b0;">Search Radius</label>
          <input type="range" id="radius-slider" min="1000" max="100000" step="1000" value="5000" style="width:100%;">
          <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:2px;color:#b0b0b0;">
            <span>1km</span>
            <span>100km</span>
          </div>
          <div id="radius-value" style="text-align:center;margin-top:3px;font-size:12px;color:#fafafa;">5km</div>
        `;
        
        // Prevent map events from propagating
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.disableScrollPropagation(container);
        
        return container;
      }
    });
    
    // Add reload control for easy recovery
    const reloadControl = L.Control.extend({
      options: { position: 'bottomright' },
      onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const link = L.DomUtil.create('a', '', container);
        link.href = '#';
        link.title = 'Reload map';
        link.innerHTML = 'â†»';
        link.style.fontSize = '18px';
        link.style.width = '30px';
        link.style.height = '30px';
        link.style.lineHeight = '30px';
        link.style.textAlign = 'center';
        link.style.fontWeight = 'bold';
        link.style.display = 'block';
        
        L.DomEvent.on(link, 'click', function(e) {
          L.DomEvent.preventDefault(e);
          initializeMap();
        });
        
        return container;
      }
    });
    
    // Add controls to map
    map.addControl(new radiusControl());
    map.addControl(new reloadControl());
    
    // Add event listener for radius slider
    setTimeout(() => {
      const slider = document.getElementById('radius-slider');
      const valueDisplay = document.getElementById('radius-value');
      
      if (slider && valueDisplay) {
        slider.addEventListener('input', function() {
          const radius = parseInt(this.value);
          const radiusKm = (radius / 1000).toFixed(1);
          valueDisplay.textContent = radiusKm + 'km';
          
          // Update circle radius
          if (searchCircle) {
            searchCircle.setRadius(radius);
          }
        });
        
        slider.addEventListener('change', function() {
          const radius = parseInt(this.value);
          
          // Get center coordinates
          if (userMarker) {
            const position = userMarker.getLatLng();
            
            // Clear old cafes
            clearCafes();
            
            // Fetch new cafes with updated radius
            fetchCafes(position.lat, position.lng, radius);
          }
        });
      }
    }, 500);
  }
  
  // Show error message on the map
  function showMapError(message) {
    if (!mapContainer) return;
    
    mapContainer.innerHTML = `
      <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(30,30,30,0.9);z-index:999;
           display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:20px;">
        <div style="color:white;font-size:20px;margin-bottom:10px;">Error fetching cafe data.</div>
        <div style="color:#b0b0b0;font-size:16px;max-width:80%;margin-bottom:20px;">
          ${message || 'Please reload and try again.'}
        </div>
        <button id="map-reload-btn" style="background:#e74c3c;color:white;border:none;padding:10px 20px;
                border-radius:4px;cursor:pointer;font-size:14px;">
          Try Again
        </button>
      </div>
    `;
    
    // Add reload button event
    document.getElementById('map-reload-btn')?.addEventListener('click', function() {
      initializeMap();
    });
  }
  
  // Clear existing cafes
  function clearCafes() {
    // Remove existing markers
    cafeMarkers.forEach(marker => {
      if (map) map.removeLayer(marker);
    });
    
    // Reset arrays
    cafeMarkers = [];
    allCafes = [];
  }
  
  // Fetch cafes from OpenStreetMap
  function fetchCafes(lat, lng, radius = 5000) {
    // Add loading indicator
    const loadingEl = document.createElement('div');
    loadingEl.id = 'cafe-loading';
    loadingEl.style.cssText = `
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30,30,30,0.8);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 999;
    `;
    loadingEl.textContent = 'Finding cafes and study spots...';
    mapContainer.appendChild(loadingEl);
    
    // Create Overpass API query (simplified for better reliability)
    const query = `
      [out:json][timeout:30];
      (
        node["amenity"="cafe"](around:${radius},${lat},${lng});
        node["amenity"="library"](around:${radius},${lat},${lng});
        node["shop"="coffee"](around:${radius},${lat},${lng});
        node["amenity"="restaurant"]["cuisine"="coffee_shop"](around:${radius},${lat},${lng});
        node["amenity"="college"](around:${radius},${lat},${lng});
        node["amenity"="university"](around:${radius},${lat},${lng});
      );
      out body;
    `;
    
    // Use fetch with timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
    
    fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: 'data=' + encodeURIComponent(query),
      signal: controller.signal
    })
    .then(response => {
      clearTimeout(timeoutId);
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      // Remove loading indicator
      document.getElementById('cafe-loading')?.remove();
      
      if (data && data.elements && data.elements.length > 0) {
        // Process the results
        processCafes(data.elements);
        
        // Show success message
        const count = data.elements.length;
        showMapMessage(`Found ${count} study places within range`, 'success');
      } else {
        // No cafes found
        showMapMessage('No cafes found in this area. Try increasing the search radius.', 'info');
      }
    })
    .catch(error => {
      clearTimeout(timeoutId);
      document.getElementById('cafe-loading')?.remove();
      
      console.error("Error fetching cafes:", error);
      showMapMessage('Error fetching cafe data. Please try again.', 'error');
    });
  }
  
  // Show temporary message on the map
  function showMapMessage(message, type = 'info') {
    if (!mapContainer) return;
    
    // Remove any existing message
    const existingMsg = document.querySelector('.map-message');
    if (existingMsg) existingMsg.remove();
    
    // Set colors based on type
    let bgColor;
    switch (type) {
      case 'error':
        bgColor = 'rgba(231,76,60,0.9)';
        break;
      case 'success':
        bgColor = 'rgba(46,204,113,0.9)';
        break;
      default:
        bgColor = 'rgba(52,152,219,0.9)';
    }
    
    // Create message element
    const messageEl = document.createElement('div');
    messageEl.className = 'map-message';
    messageEl.style.cssText = `
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: ${bgColor};
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 999;
      text-align: center;
      max-width: 80%;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    `;
    messageEl.textContent = message;
    
    // Add to map
    mapContainer.appendChild(messageEl);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (messageEl.parentNode) {
        messageEl.remove();
      }
    }, 5000);
  }
  
  // Process cafe data
  function processCafes(elements) {
    // Filter nodes with tags
    const validNodes = elements.filter(el => el.type === 'node' && el.tags);
    
    if (validNodes.length === 0) {
      showMapMessage('No valid cafe data found');
      return;
    }
    
    // Define colors for different place types
    const colors = {
      cafe: '#8c67ff',
      library: '#4f46e5',
      coffee: '#8c67ff',
      restaurant: '#f59e0b',
      college: '#10b981',
      university: '#10b981',
      default: '#8c67ff'
    };
    
    // Define icons for different place types
    const icons = {
      cafe: 'â˜•',
      library: 'ðŸ“š',
      coffee: 'â˜•',
      restaurant: 'ðŸ½ï¸',
      college: 'ðŸŽ“',
      university: 'ðŸŽ“',
      default: 'ðŸ“'
    };
    
    // Process each place
    validNodes.forEach(node => {
      // Determine place type
      let placeType = 'default';
      let typeName = 'Study Place';
      
      if (node.tags.amenity === 'cafe' || node.tags.shop === 'coffee') {
        placeType = 'cafe';
        typeName = 'CafÃ©';
      } else if (node.tags.amenity === 'library') {
        placeType = 'library';
        typeName = 'Library';
      } else if (node.tags.amenity === 'restaurant') {
        placeType = 'restaurant';
        typeName = 'Coffee Shop';
      } else if (node.tags.amenity === 'college' || node.tags.amenity === 'university') {
        placeType = 'college';
        typeName = 'Campus';
      }
      
      // Get name (or create a generic one)
      const placeName = node.tags.name || `${typeName} #${node.id.toString().slice(-4)}`;
      
      // Create place object
      const place = {
        id: node.id,
        name: placeName,
        lat: node.lat,
        lng: node.lon,
        type: placeType,
        phone: node.tags.phone || node.tags['contact:phone'] || 'Not available',
        website: node.tags.website || node.tags['contact:website'] || '',
        address: formatAddress(node.tags),
        hours: node.tags.opening_hours || 'Hours not available',
        wifi: node.tags.internet_access === 'wlan' ? 'Available' : 'Unknown',
        wheelchair: node.tags.wheelchair || 'Unknown'
      };
      
      // Add to cafes array
      allCafes.push(place);
      
      // Create marker with standard marker for reliability
      // Use custom HTML icon instead of L.divIcon to avoid errors
      const marker = L.marker([place.lat, place.lng], {
        icon: L.divIcon({
          html: `<div style="background:${colors[placeType]};color:white;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:14px;">${icons[placeType]}</div>`,
          className: '',
          iconSize: [20, 20]
        }),
        title: place.name,
        placeType: placeType // Store for filtering
      }).addTo(map);
      
      // Create popup content
      const popupContent = `
        <div style="width:220px;padding:5px 0;">
          <h3 style="margin:0 0 8px;color:${colors[placeType]};font-size:16px;font-weight:bold;">${place.name}</h3>
          
          <div style="margin:8px 0;font-size:12px;">
            <span style="background:rgba(140,103,255,0.15);color:white;padding:3px 8px;border-radius:12px;display:inline-block;background:${colors[placeType]};">${typeName}</span>
          </div>
          
          ${place.address !== 'Address not available' ? 
            `<p style="margin:8px 0;font-size:13px;"><strong>Address:</strong><br>${place.address}</p>` : ''}
          
          ${place.hours !== 'Hours not available' ? 
            `<div style="margin:8px 0;font-size:12px;"><strong>Hours:</strong><br>${place.hours}</div>` : ''}
          
          <div style="display:flex;gap:5px;margin-top:10px;">
            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name + ' ' + place.address)}" 
              target="_blank" style="flex:1;text-decoration:none;background:#4285F4;color:white;padding:6px 0;border-radius:4px;font-size:13px;text-align:center;">
              Google Maps
            </a>
            ${place.website ? 
              `<a href="${place.website}" target="_blank" style="flex:1;text-decoration:none;background:#10b981;color:white;padding:6px 0;border-radius:4px;font-size:13px;text-align:center;">Website</a>` : ''}
          </div>
          
          <button onclick="selectCafeForReview('${place.name.replace(/'/g, "\\'")}')" 
            style="width:100%;margin-top:8px;background:${colors[placeType]};color:white;border:none;padding:6px 0;border-radius:4px;cursor:pointer;font-size:13px;">
            Add Review
          </button>
        </div>
      `;
      
      // Add popup to marker
      marker.bindPopup(popupContent);
      
      // Store marker for future reference
      cafeMarkers.push(marker);
    });
    
    // Update cafe list for the datalist
    updateCafeList();
  }
  
  // Format address from OSM tags
  function formatAddress(tags) {
    const parts = [];
    
    if (tags['addr:housenumber']) parts.push(tags['addr:housenumber']);
    if (tags['addr:street']) parts.push(tags['addr:street']);
    if (tags['addr:city']) parts.push(tags['addr:city']);
    if (tags['addr:postcode']) parts.push(tags['addr:postcode']);
    
    return parts.join(', ') || 'Address not available';
  }
  
  // Update cafe list for dropdown
  function updateCafeList() {
    if (!cafeList) return;
    
    // Clear existing options
    cafeList.innerHTML = '';
    
    // Sort cafes alphabetically
    const sortedCafes = [...allCafes].sort((a, b) => a.name.localeCompare(b.name));
    
    // Add options to datalist
    sortedCafes.forEach(cafe => {
      const option = document.createElement('option');
      option.value = cafe.name;
      cafeList.appendChild(option);
    });
  }
  
  // Fix the review form submission
  function fixReviewForm() {
    if (!reviewForm) return;
    
    // Remove existing handler
    reviewForm.onsubmit = null;
    
    // Add new submit handler
    reviewForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Get form fields
      const name = reviewName?.value?.trim() || '';
      const rating = document.getElementById('reviewRating')?.value || '';
      const category = document.getElementById('reviewCategory')?.value || '';
      const text = document.getElementById('reviewText')?.value?.trim() || '';
      
      console.log("Review form submitted with values:", { name, rating, category, text });
      
      // Handle validation without alerts
      let isValid = true;
      
      // Remove any existing error messages
      reviewForm.querySelectorAll('.field-error').forEach(el => el.remove());
      
      // Validate each field
      if (!name) {
        addFieldError('reviewName', 'Please choose a cafe name');
        isValid = false;
      }
      
      if (!rating) {
        addFieldError('reviewRating', 'Please select a rating');
        isValid = false;
      }
      
      if (!category) {
        addFieldError('reviewCategory', 'Please select a category');
        isValid = false;
      }
      
      if (!text) {
        addFieldError('reviewText', 'Please share your experience');
        isValid = false;
      }
      
      // If any field is invalid, stop
      if (!isValid) return;
      
      // Save the review
      try {
        // Get existing reviews
        let reviews = [];
        try {
          reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
        } catch (e) {
          console.error("Error parsing reviews:", e);
          reviews = [];
        }
        
        // Create review object
        const review = {
          name: name,
          rating: parseInt(rating),
          category: category,
          text: text,
          date: new Date().toISOString().split('T')[0]
        };
        
        // Add to array
        reviews.push(review);
        
        // Save back to localStorage
        localStorage.setItem('sb-reviews', JSON.stringify(reviews));
        
        console.log("Review saved:", review);
        console.log("All reviews:", reviews);
        
        // Reset form
        reviewForm.reset();
        
        // Show success message (non-alert)
        const successMsg = document.createElement('div');
        successMsg.style.cssText = `
          background: rgba(46,204,113,0.1);
          color: #2ecc71;
          padding: 10px;
          border-radius: 4px;
          margin-top: 10px;
          text-align: center;
          grid-column: span 2;
        `;
        successMsg.textContent = 'Review added successfully!';
        reviewForm.appendChild(successMsg);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
          if (successMsg.parentNode) {
            successMsg.remove();
          }
        }, 3000);
        
        // Render reviews
        renderReviews();
      } catch (error) {
        console.error("Error saving review:", error);
        
        // Show error message (non-alert)
        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = `
          background: rgba(231,76,60,0.1);
          color: #e74c3c;
          padding: 10px;
          border-radius: 4px;
          margin-top: 10px;
          text-align: center;
          grid-column: span 2;
        `;
        errorMsg.textContent = 'Error saving review. Please try again.';
        reviewForm.appendChild(errorMsg);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
          if (errorMsg.parentNode) {
            errorMsg.remove();
          }
        }, 3000);
      }
    });
    
    // Helper function to add field errors
    function addFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      if (!field) return;
      
      // Create error element
      const error = document.createElement('div');
      error.className = 'field-error';
      error.style.cssText = `
        color: #e74c3c;
        font-size: 12px;
        margin-top: -10px;
        margin-bottom: 10px;
      `;
      error.textContent = message;
      
      // Add after field
      field.parentNode.insertBefore(error, field.nextSibling);
      
      // Highlight field
      field.style.borderColor = '#e74c3c';
      
      // Clear error on focus
      field.addEventListener('focus', function() {
        field.style.borderColor = '';
        error.remove();
      }, { once: true });
    }
  }
  
  // Render reviews
  function renderReviews() {
    if (!cafeReviews) return;
    
    console.log("Rendering reviews");
    
    // Get reviews from localStorage
    let reviews = [];
    try {
      reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
    } catch (e) {
      console.error("Error parsing reviews:", e);
      reviews = [];
    }
    
    console.log("Retrieved reviews:", reviews);
    
    // Clear container
    cafeReviews.innerHTML = '';
    
    // Check if we have any reviews
    if (!reviews || reviews.length === 0) {
      cafeReviews.innerHTML = `
        <div class="card" style="text-align:center;padding:2rem;">
          <div style="font-size:4rem;margin-bottom:1rem;">ðŸ“</div>
          <h3 style="margin-bottom:1rem;color:var(--txt-2);">No Reviews Yet</h3>
          <p>Share your experience at your favorite study spots!</p>
        </div>
      `;
      return;
    }
    
    // Group reviews by cafe
    const reviewsByPlace = {};
    reviews.forEach(review => {
      if (!reviewsByPlace[review.name]) {
        reviewsByPlace[review.name] = [];
      }
      reviewsByPlace[review.name].push(review);
    });
    
    // Add section title
    const header = document.createElement('h3');
    header.className = 'section-subtitle';
    header.style.cssText = 'margin:1.5rem 0 1rem;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:0.5rem;';
    header.textContent = 'CafÃ© Reviews';
    cafeReviews.appendChild(header);
    
    // Create reviews grid
    const grid = document.createElement('div');
    grid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem;';
    cafeReviews.appendChild(grid);
    
    // Loop through each place and create review cards
    Object.keys(reviewsByPlace).sort().forEach(cafeName => {
      const placeReviews = reviewsByPlace[cafeName];
      
      // Calculate average rating
      const avgRating = placeReviews.reduce((sum, r) => sum + r.rating, 0) / placeReviews.length;
      
      // Determine most common category
      const categories = placeReviews.map(r => r.category);
      const categoryCount = {};
      categories.forEach(cat => {
        categoryCount[cat] = (categoryCount[cat] || 0) + 1;
      });
      let topCategory = '';
      let maxCount = 0;
      for (const cat in categoryCount) {
        if (categoryCount[cat] > maxCount) {
          maxCount = categoryCount[cat];
          topCategory = cat;
        }
      }
      
      // Create review card
      const card = document.createElement('div');
      card.className = 'card';
      
      // Card header
      const cardHeader = document.createElement('div');
      cardHeader.style.cssText = 'margin-bottom:0.8rem;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:0.8rem;';
      
      // Cafe name and rating
      cardHeader.innerHTML = `
        <h3 style="margin:0 0 0.8rem;font-size:1.3rem;">${cafeName}</h3>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="color:var(--ac-warn);font-size:1.2rem;">
            ${Array(Math.round(avgRating)).fill('â˜…').join('')}${Array(5-Math.round(avgRating)).fill('â˜†').join('')}
          </div>
          <span style="color:var(--txt-2);font-size:0.8rem;">
            ${placeReviews.length} review${placeReviews.length > 1 ? 's' : ''}
          </span>
        </div>
        ${topCategory ? `
          <div style="margin-top:0.5rem;">
            <span style="display:inline-block;background:rgba(140,103,255,0.2);color:var(--txt-1);
                   font-size:0.8rem;padding:3px 8px;border-radius:12px;">
              Best for: ${topCategory}
            </span>
          </div>
        ` : ''}
      `;
      card.appendChild(cardHeader);
      
      // Reviews list
      const reviewsList = document.createElement('div');
      reviewsList.style.cssText = 'max-height:300px;overflow-y:auto;padding-right:0.5rem;';
      
      // Add each review
      placeReviews.forEach((review, i) => {
        const reviewItem = document.createElement('div');
        reviewItem.style.cssText = i < placeReviews.length-1 ? 
          'margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid rgba(255,255,255,0.05);position:relative;' : 
          'position:relative;';
        
        // Format date nicely
        let displayDate = review.date || 'No date';
        try {
          if (review.date) {
            const date = new Date(review.date);
            displayDate = date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            });
          }
        } catch (e) {
          console.error("Date formatting error:", e);
        }
        
        // Review content
        reviewItem.innerHTML = `
          <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
            <div style="color:var(--ac-warn);">
              ${Array(review.rating).fill('â˜…').join('')}${Array(5-review.rating).fill('â˜†').join('')}
            </div>
            <div style="color:var(--txt-2);font-size:0.8rem;">${displayDate}</div>
          </div>
          <p style="margin:0 0 0.5rem;font-size:0.9rem;line-height:1.4;">${review.text}</p>
          ${review.category ? `
            <span style="display:inline-block;background:rgba(140,103,255,0.1);color:var(--txt-2);
                   font-size:0.7rem;padding:2px 6px;border-radius:3px;margin-top:0.3rem;">
              ${review.category}
            </span>
          ` : ''}
          <span class="delete-review" data-place="${cafeName}" data-index="${i}" style="position:absolute;top:0;right:0;cursor:pointer;color:var(--ac-warn);font-weight:bold;">Ã—</span>
        `;
        
        reviewsList.appendChild(reviewItem);
      });
      
      card.appendChild(reviewsList);
      grid.appendChild(card);
    });
    
    // Add handlers for delete buttons
    cafeReviews.querySelectorAll('.delete-review').forEach(button => {
      button.addEventListener('click', function() {
        const placeName = this.getAttribute('data-place');
        const index = parseInt(this.getAttribute('data-index'));
        
        // Get reviews
        let reviews = [];
        try {
          reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
        } catch (e) {
          console.error("Error parsing reviews:", e);
          return;
        }
        
        // Find all reviews for this place
        const placeReviews = reviews.filter(r => r.name === placeName);
        if (index >= 0 && index < placeReviews.length) {
          // Find the review to delete (match by unique properties)
          const reviewToDelete = placeReviews[index];
          
          // Find its index in the full reviews array
          const globalIndex = reviews.findIndex(r => 
            r.name === reviewToDelete.name && 
            r.rating === reviewToDelete.rating && 
            r.text === reviewToDelete.text && 
            r.date === reviewToDelete.date
          );
          
          // Remove it
          if (globalIndex !== -1) {
            reviews.splice(globalIndex, 1);
            
            // Save back to localStorage
            localStorage.setItem('sb-reviews', JSON.stringify(reviews));
            
            // Re-render reviews
            renderReviews();
            
            // Show confirmation (no alert)
            const tempMsg = document.createElement('div');
            tempMsg.style.cssText = `
              position: fixed;
              bottom: 20px;
              right: 20px;
              background: rgba(46,204,113,0.9);
              color: white;
              padding: 10px 20px;
              border-radius: 4px;
              font-size: 14px;
              z-index: 9999;
              box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            `;
            tempMsg.textContent = 'Review deleted successfully';
            document.body.appendChild(tempMsg);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
              if (tempMsg.parentNode) {
                tempMsg.remove();
              }
            }, 3000);
          }
        }
      });
    });
  }
  
  // Initialize cafe selection for review
  window.selectCafeForReview = function(cafeName) {
    if (reviewName) {
      reviewName.value = cafeName;
      
      // Scroll to form
      reviewForm.scrollIntoView({ behavior: 'smooth' });
      
      // Focus on rating
      setTimeout(() => {
        document.getElementById('reviewRating')?.focus();
      }, 500);
      
      // Highlight chosen cafe on the map
      if (map && allCafes.length > 0) {
        const cafe = allCafes.find(c => c.name === cafeName);
        if (cafe) {
          map.setView([cafe.lat, cafe.lng], 16);
          
          // Highlight the corresponding marker
          cafeMarkers.forEach((marker, i) => {
            if (allCafes[i] && allCafes[i].name === cafeName) {
              marker.openPopup();
            }
          });
        }
      }
    }
  };
  
  // Start initialization
  initializeMap();
  fixReviewForm();
  renderReviews();
}

// Initialize when document is ready
document.addEventListener('DOMContentLoaded', function() {
  // Ensure Leaflet is loaded
  if (typeof L === 'undefined') {
    const leafletCSS = document.createElement('link');
    leafletCSS.rel = 'stylesheet';
    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(leafletCSS);
    
    const leafletScript = document.createElement('script');
    leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    leafletScript.onload = initCafe;
    document.head.appendChild(leafletScript);
  } else {
    // Leaflet already loaded
    initCafe();
  }
});

// Call this function instead of the original initCafe
document.addEventListener('DOMContentLoaded', function() {
  // Ensure Leaflet is loaded
  if (typeof L === 'undefined') {
    // Load Leaflet CSS
    const leafletCSS = document.createElement('link');
    leafletCSS.rel = 'stylesheet';
    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(leafletCSS);
    
    // Load Leaflet JS
    const leafletScript = document.createElement('script');
    leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    leafletScript.onload = function() {
      console.log("Leaflet loaded, initializing cafe map");
      initCafe();
    };
    document.head.appendChild(leafletScript);
  } else {
    initCafe();
  }
});
// Call this function instead of the original initCafe
document.addEventListener('DOMContentLoaded', function() {
  // Ensure Leaflet is loaded
  if (typeof L === 'undefined') {
    // Load Leaflet CSS
    const leafletCSS = document.createElement('link');
    leafletCSS.rel = 'stylesheet';
    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(leafletCSS);
    
    // Load Leaflet JS
    const leafletScript = document.createElement('script');
    leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    leafletScript.onload = function() {
      console.log("Leaflet loaded, initializing cafe map");
      initCafe();
    };
    document.head.appendChild(leafletScript);
  } else {
    initCafe();
  }
});

// Add this function to make "selectCafeForReview" globally available
window.selectCafeForReview = function(cafeName) {
  const reviewName = document.getElementById('reviewName');
  const reviewForm = document.getElementById('reviewForm');
  
  if (reviewName && reviewForm) {
    reviewName.value = cafeName;
    reviewForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => {
      document.getElementById('reviewRating').focus();
    }, 500);
  }
};

    // GAMES
    function initGames(){
      const sel=document.getElementById('gameSelect');
      const games=[
      ['Wordle Clone', 'https://wordlegame.org/'],
    ['Hangman',      'https://hangmanwordgame.com/'],
      ['Flappy Bird',         'https://flappybird.io/'],
      ['Minesweeper',         'https://kamoroso94.github.io/minesweeper/'],      // :contentReference[oaicite:0]{index=0}
      ['Sudoku',           'https://sudoku.com/'],
      ['Connect Four',        'https://torikul007.github.io/Connect_Four/']       // :contentReference[oaicite:1]{index=1}
      ];
      games.forEach(g=>{
        const o=document.createElement('option');
        o.value=g[1]; o.textContent=g[0];
        sel.append(o);
      });
      sel.onchange=()=>document.getElementById('gameFrame').src=sel.value;
      sel.dispatchEvent(new Event('change'));
    }

    // SESSIONS
    function initSessions(){
      const getS=()=>JSON.parse(localStorage.getItem('sb-sessions')||'[]');
      const saveS=a=>localStorage.setItem('sb-sessions',JSON.stringify(a));
      const renderS=()=>{
        const ul=document.getElementById('sessionList'),a=getS();
        ul.innerHTML='';
        if(!a.length){ul.innerHTML='<li class="card">No sessions.</li>';return;}
        a.forEach((s,i)=>{
          const li=document.createElement('li');li.className='card';li.style.marginBottom='.6rem';
          li.innerHTML=`<strong>${s.topic}</strong> ${s.date} â€” ${s.duration} min
            <button class="btn btn-small btn-secondary" onclick="(()=>{
              const arr=getS();arr.splice(${i},1);saveS(arr);renderS();
            })()">Delete</button>`;
          ul.append(li);
        });
      };
      document.getElementById('sessionForm').addEventListener('submit',e=>{
        e.preventDefault();
        const arr=getS();
        arr.push({
          topic:document.getElementById('sessionTopic').value,
          date:document.getElementById('sessionDate').value,
          duration:+document.getElementById('sessionDuration').value
        });
        saveS(arr);renderS();e.target.reset();
      });
      renderS();
    }

    // PLANNER
// PLANNER - Enhanced with better formatting
// Enhanced Planner with beautiful formatting
// DIRECT REPLACEMENT FOR PLANNER IMPLEMENTATION
function initPlanner() {
  console.log("Initializing enhanced planner");
  
  // Helper functions to get and save plans
  const getP = () => JSON.parse(localStorage.getItem('sb-plans') || '[]');
  const saveP = a => localStorage.setItem('sb-plans', JSON.stringify(a));
  
  // Render plans with improved UI
  const renderP = () => {
    const wrap = document.getElementById('planList');
    if (!wrap) return;
    
    const plans = getP();
    wrap.innerHTML = '';
    
    // Sort plans by date
    plans.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    plans.forEach((p, i) => {
      const c = document.createElement('div');
      c.className = 'card';
      
      // Format date nicely
      const formattedDate = new Date(p.date).toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'short',
        day: 'numeric'
      });
      
      // Associate emojis with categories
      const categoryEmojis = {
        'Homework': 'ðŸ“',
        'Reading': 'ðŸ“š',
        'Project': 'ðŸ› ï¸',
        'Review': 'ðŸ”',
        'Exam': 'ðŸ“Š',
        'Essay': 'âœï¸',
        'Presentation': 'ðŸŽ¯',
        'Research': 'ðŸ”¬',
        'Lab': 'ðŸ§ª',
        'Other': 'ðŸ“Œ'
      };
      
      const emoji = categoryEmojis[p.category] || 'ðŸ“Œ';
      
      c.innerHTML = `
        <h4 style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <span style="font-size:1.4em;">${emoji}</span>
          <span>${p.title}</span>
        </h4>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <small style="background:rgba(140,103,255,0.2); padding:3px 10px; border-radius:12px;">
            ${p.category}
          </small>
          <small style="color:var(--txt-2);">
            <span style="margin-right:5px;">ðŸ“…</span>${formattedDate}
          </small>
        </div>
        <p style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px; margin-top:5px;">${p.desc}</p>
        <button class="delete-plan" data-index="${i}" style="position:absolute;top:10px;right:10px;background:none;border:none;color:var(--ac-warn);font-weight:bold;font-size:1.2rem;cursor:pointer;">Ã—</button>
      `;
      wrap.append(c);
    });
    
    wrap.querySelectorAll('.delete-plan').forEach(btn => {
      btn.onclick = () => {
        const arr = getP();
        arr.splice(+btn.dataset.index, 1);
        saveP(arr);
        renderP();
      };
    });
  };
  
  // Set up planner form
  const plannerForm = document.getElementById('plannerForm');
  if (plannerForm) {
    // Remove any existing handlers
    plannerForm.onsubmit = null;
    
    // Add new submit handler
    plannerForm.addEventListener('submit', e => {
      e.preventDefault();
      
      const title = document.getElementById('planTitle')?.value?.trim() || '';
      const category = document.getElementById('planCat')?.value || '';
      const desc = document.getElementById('planDesc')?.value?.trim() || '';
      const date = document.getElementById('planDate')?.value || '';
      
      console.log("Plan values:", {title, category, desc, date});
      
      // Basic validation
      if (!title) {
        alert("Please enter a title");
        return;
      }
      
      if (!category) {
        alert("Please select a category");
        return;
      }
      
      if (!date) {
        alert("Please select a date");
        return;
      }
      
      const arr = getP();
      arr.push({
        title: title,
        category: category,
        desc: desc,
        date: date
      });
      
      saveP(arr);
      renderP();
      e.target.reset();
      
      // Show success message
      alert("Task added successfully!");
    });
  }
  
  // Enhanced study plan generation
  const planStudyBtn = document.getElementById('planStudy');
  if (planStudyBtn) {
    planStudyBtn.onclick = async () => {
      const tasks = getP();
      const plannerAdvice = document.getElementById('plannerAdvice');
      if (!plannerAdvice) return;
      
      if (!tasks.length) {
        plannerAdvice.innerHTML = "<div style='text-align:center;padding:20px;'>Please add some tasks first.</div>";
        return;
      }
      
      // Show loading state
      plannerAdvice.innerHTML = `
        <div style='text-align:center;padding:20px;'>
          <div style='display:inline-block;width:30px;height:30px;border:3px solid rgba(140,103,255,0.3);
            border-radius:50%;border-top-color:var(--ac-1);animation:spin 1s linear infinite;'></div>
          <p style='margin-top:10px;'>Generating your personalized study plan...</p>
        </div>
        <style>
          @keyframes spin { to { transform: rotate(360deg); } }
        </style>
      `;
      
      // Sort tasks by date
      tasks.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      const today = new Date();
      const formattedToday = today.toISOString().split('T')[0];
      
      // Create a detailed request for better response
      const msg = `I have these academic tasks:\n${tasks.map(t => 
        `- ${t.title} (${t.category}), due ${t.date}: ${t.desc}`
      ).join('\n')}\n\nToday is ${formattedToday}. Please give me a detailed day-by-day study plan that's optimized for productivity and learning. For each day, suggest specific time blocks, study techniques, and breaks. Use emojis and clear formatting.`;
      
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({message: msg})
        });
        
        const data = await res.json();
        let studyPlan = data.reply || 'No advice available.';
        
        // Create a beautifully styled container for the plan
        const styledPlan = document.createElement('div');
        styledPlan.style.cssText = 'max-height:500px;overflow-y:auto;padding:20px;background:var(--bg-2);border-radius:var(--rad-m);margin-top:20px;border:1px solid rgba(255,255,255,0.05);box-shadow:var(--shadow-s);';
        
        // Add CSS styles for the plan
        const styleElement = document.createElement('style');
        styleElement.textContent = `
          .study-plan-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--ac-1);
            font-size: 1.5rem;
          }
          
          .day-header {
            margin-top: 20px;
            margin-bottom: 15px;
            color: var(--ac-1);
            border-bottom: 1px solid var(--ac-1);
            padding-bottom: 5px;
            font-size: 1.2rem;
          }
          
          .time-block {
            background: rgba(140,103,255,0.2);
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: bold;
            margin-right: 5px;
            font-size: 0.9rem;
          }
          
          .task-item {
            display: flex;
            margin: 8px 0;
            line-height: 1.5;
          }
          
          .bullet {
            margin-right: 10px;
            color: var(--ac-1);
          }
          
          .study-plan-content strong {
            color: var(--ac-1);
          }
          
          .study-tip {
            background: rgba(255,111,145,0.1);
            padding: 10px 15px;
            border-radius: var(--rad-s);
            margin: 12px 0;
            border-left: 3px solid var(--ac-3);
          }
          
          .tip-label {
            color: var(--ac-3);
            font-weight: bold;
          }
          
          .download-button {
            display: block;
            margin: 20px auto 10px;
            background: var(--ac-1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--rad-s);
            cursor: pointer;
            transition: all 0.2s ease;
          }
          
          .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          }
        `;
        styledPlan.appendChild(styleElement);
        
        // Add title
        const title = document.createElement('h2');
        title.className = 'study-plan-title';
        title.innerHTML = 'âœ¨ Your Personalized Study Plan âœ¨';
        styledPlan.appendChild(title);
        
        // Create content container with enhanced formatting
        const content = document.createElement('div');
        content.className = 'study-plan-content';
        
        // Process and enhance the study plan text with formatting
        let enhancedPlan = studyPlan
          // Format day headers
          .replace(/(?:^|\n)(?:\*\*)?(?:ðŸ“…\s*)?(?:Day \d+:)?\s*([A-Za-z]+day),?\s*([A-Za-z]+ \d+(?:st|nd|rd|th)?)(?:\*\*)?/g, 
            '<div class="day-header"><h3>ðŸ“… $1, $2</h3></div>')
          
          // Format time blocks
          .replace(/(\d{1,2}:\d{2}\s*(?:AM|PM|am|pm)\s*[-â€“â€”]\s*\d{1,2}:\d{2}\s*(?:AM|PM|am|pm))/g, 
            '<span class="time-block">â° $1</span>')
          
          // Format task names
          .replace(/(?:\*\*)([^*]+?)(?:\*\*)/g, '<strong>$1</strong>')
          
          // Format bullet points
          .replace(/^\s*[-â€¢*]\s+(.+)$/gm, '<div class="task-item"><span class="bullet">â€¢</span><span>$1</span></div>')
          
          // Format technique suggestions
          .replace(/(Technique|Tip|Method|Strategy):\s*([^.!?]+[.!?])/g, 
            '<div class="study-tip"><span class="tip-label">$1:</span> $2</div>');
        
        content.innerHTML = enhancedPlan;
        styledPlan.appendChild(content);
        
        // Add download button
        const downloadButton = document.createElement('button');
        downloadButton.className = 'download-button';
        downloadButton.innerHTML = 'ðŸ“¥ Download Study Plan';
        downloadButton.onclick = function() {
          // Clean up the plan text
          const planText = studyPlan
            .replace(/\*\*/g, '')
            .replace(/\[/g, '')
            .replace(/\]/g, '');
          
          // Create and download a text file
          const blob = new Blob(['# My StudyBuddy Plan\n\n' + planText], {type: 'text/plain'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'StudyPlan.txt';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };
        styledPlan.appendChild(downloadButton);
        
        // Add the styled plan to the page
        plannerAdvice.innerHTML = '';
        plannerAdvice.appendChild(styledPlan);
        
      } catch (error) {
        console.error("Plan generation error:", error);
        plannerAdvice.innerHTML = `
          <div style="padding:15px;background:rgba(255,100,100,0.1);border-radius:var(--rad-s);color:#ff6464;">
            <p>ðŸ˜” Sorry, there was an error generating your study plan. Please try again later.</p>
            <button onclick="document.getElementById('planStudy').click()" 
                    style="background:rgba(255,255,255,0.2);border:none;color:white;padding:5px 15px;border-radius:4px;margin-top:10px;cursor:pointer;">
              Try Again
            </button>
          </div>`;
      }
    };
  }
  
  // Add category options programmatically
  const categorySelect = document.getElementById('planCat');
  if (categorySelect && categorySelect.options.length <= 2) {
    const categories = ['Homework', 'Reading', 'Project', 'Review', 'Exam', 'Essay', 'Presentation', 'Research', 'Lab', 'Other'];
    categorySelect.innerHTML = '<option value="">Categoryâ€¦</option>';
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
    });
  }
  
  // Add custom CSS for better styling
  const styleElement = document.createElement('style');
  styleElement.textContent = `
    /* Add styling for the planner */
    #planList .card {
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      margin-bottom: 1rem;
    }
    
    #planList .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, var(--ac-1), var(--ac-3));
      border-radius: var(--rad-s) 0 0 var(--rad-s);
    }
    
    #planList .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-l);
    }
    
    #plannerForm {
      background: var(--bg-3);
      padding: 1.5rem;
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    #planStudy {
      background: linear-gradient(135deg, var(--ac-1), var(--ac-2));
      padding: 0.8rem 1.6rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }
    
    #planStudy:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(140, 103, 255, 0.3);
    }
  `;
  document.head.appendChild(styleElement);
  
  // Initialize UI
  renderP();
}

// Call the planner initialization
document.addEventListener('DOMContentLoaded', function() {
  // Initialize enhanced planner
  initPlanner();
});

// Complete Integration and Fixes
// This script should be loaded after the original StudyBuddy scripts
// It will fix both the review form validation and maps functionality

document.addEventListener('DOMContentLoaded', function() {
  console.log("StudyBuddy enhancements loading...");
  
  // Add Leaflet CSS if not already present
  if (!document.querySelector('link[href*="leaflet.css"]')) {
    const leafletCSS = document.createElement('link');
    leafletCSS.rel = 'stylesheet';
    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(leafletCSS);
  }
  
  // Add global CSS fixes
  const globalStyles = document.createElement('style');
  globalStyles.textContent = `
    /* Map fixes */
    #map {
      width: 100%;
      height: 600px !important; /* Force taller map */
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-s);
      position: relative;
      z-index: 1;
    }
    
    /* Leaflet customizations */
    .leaflet-container {
      background: #1e1e1e;
      font-family: 'Inter', sans-serif;
    }
    
    .leaflet-popup-content-wrapper {
      background: var(--bg-2);
      color: var(--txt-1);
      border-radius: var(--rad-m);
      padding: 0;
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .leaflet-popup-tip {
      background: var(--bg-2);
      box-shadow: var(--shadow-s);
    }
    
    .leaflet-popup-content {
      margin: 8px;
      width: auto !important;
    }
    
    /* Form fixes */
    #reviewForm {
      background: var(--bg-3);
      padding: 1.5rem;
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    /* Make loading indicators consistent */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(140, 103, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--ac-1);
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Improved visibility for required fields */
    #reviewName, #reviewRating, #reviewCategory, #reviewText {
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    #reviewName:required, #reviewRating:required, #reviewCategory:required, #reviewText:required {
      border-left: 3px solid var(--ac-1);
    }
    
    /* Form labels for better clarity */
    .form-label {
      display: block;
      margin-bottom: 0.3rem;
      color: var(--txt-2);
      font-size: 0.9rem;
    }
  `;
  document.head.appendChild(globalStyles);
  
  // Fix review form - this is the main issue you reported
  function fixReviewForm() {
    const reviewForm = document.getElementById('reviewForm');
    if (!reviewForm) {
      console.log("Review form not found");
      return;
    }
    
    console.log("Fixing review form");
    
    // Add labels for better clarity
    const nameInput = document.getElementById('reviewName');
    const ratingInput = document.getElementById('reviewRating');
    const categoryInput = document.getElementById('reviewCategory');
    const textInput = document.getElementById('reviewText');
    
    if (nameInput) {
      const label = document.createElement('label');
      label.className = 'form-label';
      label.htmlFor = 'reviewName';
      label.textContent = 'CafÃ© Name';
      nameInput.parentNode.insertBefore(label, nameInput);
    }
    
    if (ratingInput) {
      const label = document.createElement('label');
      label.className = 'form-label';
      label.htmlFor = 'reviewRating';
      label.textContent = 'Rating';
      ratingInput.parentNode.insertBefore(label, ratingInput);
    }
    
    if (categoryInput) {
      const label = document.createElement('label');
      label.className = 'form-label';
      label.htmlFor = 'reviewCategory';
      label.textContent = 'Best For';
      categoryInput.parentNode.insertBefore(label, categoryInput);
    }
    
    if (textInput) {
      const label = document.createElement('label');
      label.className = 'form-label';
      label.htmlFor = 'reviewText';
      label.textContent = 'Your Review';
      textInput.parentNode.insertBefore(label, textInput);
    }
    
    // Replace the existing submit handler with a corrected one
    reviewForm.onsubmit = null; // Remove any existing handler
    
    reviewForm.addEventListener('submit', function(e) {
      e.preventDefault();
      console.log("Review form submitted");
      
      // Get form values directly
      const name = nameInput?.value.trim() || '';
      const rating = ratingInput?.value || '';
      const category = categoryInput?.value || '';
      const text = textInput?.value.trim() || '';
      
      console.log("Review values:", {name, rating, category, text});
      
      // Validation messages
      if (!name) {
        alert("Please enter a cafÃ© name");
        nameInput?.focus();
        return;
      }
      
      if (!rating) {
        alert("Please select a rating");
        ratingInput?.focus();
        return;
      }
      
      if (!category) {
        alert("Please select a category");
        categoryInput?.focus();
        return;
      }
      
      if (!text) {
        alert("Please enter your review");
        textInput?.focus();
        return;
      }
      
      // Save review to localStorage directly rather than calling other functions
      try {
        // Get existing reviews
        let reviews = [];
        try {
          reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
        } catch (e) {
          console.error("Error parsing existing reviews:", e);
          reviews = [];
        }
        
        // Add new review
        reviews.push({
          name: name,
          rating: parseInt(rating),
          category: category,
          text: text,
          date: new Date().toISOString().split('T')[0]
        });
        
        // Save back to localStorage
        localStorage.setItem('sb-reviews', JSON.stringify(reviews));
        console.log("Review saved successfully");
        
        // Reset form
        reviewForm.reset();
        
        // Show success message
        alert("Review added successfully!");
        
        // Refresh reviews display
        if (typeof renderReviews === 'function') {
          renderReviews();
        }
      } catch (error) {
        console.error("Error saving review:", error);
        alert("There was an error saving your review. Please try again.");
      }
    });
    
    console.log("Review form fixed");
  }
  
  // Function to ensure Leaflet loads properly
  function ensureLeaflet() {
    if (typeof L === 'undefined') {
      console.log("Leaflet not defined, loading it now");
      
      // Load Leaflet JS
      const leafletScript = document.createElement('script');
      leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      
      // After Leaflet loads, check if the map is already initialized
      leafletScript.onload = function() {
        console.log("Leaflet loaded");
        
        // If initCafe is defined, but the map isn't showing, try calling it
        if (typeof initCafe === 'function') {
          setTimeout(() => {
            const mapElement = document.getElementById('map');
            if (mapElement && !mapElement.querySelector('.leaflet-container')) {
              console.log("Map container exists but no Leaflet map found, initializing");
              initCafe();
            }
          }, 1000);
        }
      };
      
      document.head.appendChild(leafletScript);
    } else {
      console.log("Leaflet is already defined");
    }
  }
  
  // Add a reload button to the map for easy recovery
  function addMapReloadButton() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) return;
    
    // Check if button already exists
    if (document.getElementById('map-reload-btn')) return;
    
    const reloadBtn = document.createElement('button');
    reloadBtn.id = 'map-reload-btn';
    reloadBtn.style.cssText = `
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 999;
      background: rgba(140, 103, 255, 0.8);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    `;
    reloadBtn.textContent = "Reload Map";
    reloadBtn.onclick = function() {
      location.reload();
    };
    
    mapContainer.appendChild(reloadBtn);
  }
  
  // Wait for everything to load then apply our fixes
  setTimeout(function() {
    // Fix review form
    fixReviewForm();
    
    // Ensure Leaflet is loaded
    ensureLeaflet();
    
    // Add map reload button
    addMapReloadButton();
    
    console.log("StudyBuddy enhancements applied");
  }, 1000);
});
// Script to integrate the enhanced features
document.addEventListener('DOMContentLoaded', function() {
  // Load additional CSS for enhanced features
  const enhancedCSS = document.createElement('style');
  enhancedCSS.textContent = `
    /* Improved map styling */
    #map {
      width: 100%;
      height: 500px;
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-s);
      position: relative;
      z-index: 1;
    }

    /* Custom Leaflet styling */
    .leaflet-container {
      background: #1e1e1e;
      font-family: 'Inter', sans-serif;
    }

    .leaflet-popup-content-wrapper {
      background: var(--bg-2);
      color: var(--txt-1);
      border-radius: var(--rad-m);
      padding: 0;
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .leaflet-popup-tip {
      background: var(--bg-2);
      box-shadow: var(--shadow-s);
    }

    .leaflet-popup-content {
      margin: 8px;
      width: auto !important;
    }

    .leaflet-control-attribution {
      background: rgba(30, 30, 30, 0.7) !important;
      color: var(--txt-2) !important;
      backdrop-filter: blur(5px);
      padding: 3px 8px;
      border-radius: 4px;
    }

    .leaflet-control-attribution a {
      color: var(--ac-1) !important;
    }
    
    /* Enhanced forms */
    #reviewForm, #plannerForm {
      background: var(--bg-3);
      padding: 15px;
      border-radius: var(--rad-m);
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Improved review form layout */
    #reviewForm {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    #reviewForm div:first-child {
      grid-column: span 2;
    }

    #reviewForm textarea {
      grid-column: span 2;
    }

    #reviewForm button {
      grid-column: span 2;
      margin-top: 0.5rem;
    }
    
    /* Add visual flare to study planner */
    #planList .card {
      position: relative;
      overflow: hidden;
    }

    #planList .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, var(--ac-1), var(--ac-3));
      border-radius: var(--rad-s) 0 0 var(--rad-s);
    }

    #planList .card h4 {
      margin-left: 8px;
    }
    
    /* Make loading indicators consistent */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(140, 103, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--ac-1);
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
      #map {
        height: 350px;
      }
      
      #reviewForm {
        display: block;
      }
    }
  `;
  document.head.appendChild(enhancedCSS);
  
  // Load Leaflet CSS if not already loaded
  if (!document.querySelector('link[href*="leaflet.css"]')) {
    const leafletCSS = document.createElement('link');
    leafletCSS.rel = 'stylesheet';
    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(leafletCSS);
  }
  
  // Load Leaflet JS if not already loaded
  if (typeof L === 'undefined') {
    const leafletScript = document.createElement('script');
    leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    leafletScript.onload = function() {
      console.log('Leaflet loaded dynamically');
      // Initialize cafe feature after Leaflet loads
      if (typeof initCafe === 'function') {
        initCafe();
      }
    };
    document.head.appendChild(leafletScript);
  } else {
    // Leaflet already loaded, initialize cafe feature
    if (typeof initCafe === 'function') {
      initCafe();
    }
  }
  
  // Initialize enhanced planner
  if (typeof initPlanner === 'function') {
    initPlanner();
  }
});

// Fix the global selectCafeForReview function if not defined
if (typeof selectCafeForReview === 'undefined') {
  window.selectCafeForReview = function(cafeName) {
    const reviewName = document.getElementById('reviewName');
    const reviewForm = document.getElementById('reviewForm');
    
    if (reviewName && reviewForm) {
      reviewName.value = cafeName;
      reviewForm.scrollIntoView({ behavior: 'smooth' });
      setTimeout(() => {
        document.getElementById('reviewRating')?.focus();
      }, 300);
    }
  };
}

// Add global error handling for map-related issues
window.addEventListener('error', function(e) {
  // Check if error is map related
  if (e.message && (
    e.message.toLowerCase().includes('leaflet') || 
    e.message.toLowerCase().includes('map') || 
    e.message.toLowerCase().includes('marker') || 
    e.message.toLowerCase().includes('layer')
  )) {
    console.error('Map error:', e);
    
    // Get map container
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
      // Show error message
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = 'position:absolute;top:10px;left:10px;z-index:1000;background:rgba(255,100,100,0.9);color:white;padding:10px;border-radius:4px;max-width:80%;';
      errorDiv.innerHTML = `
        Map error occurred. <button id="mapErrorRefresh" style="background:rgba(255,255,255,0.3);border:none;color:white;padding:3px 8px;border-radius:3px;cursor:pointer;margin-left:10px;">Refresh</button>
      `;
      mapContainer.appendChild(errorDiv);
      
      // Add refresh button handler
      document.getElementById('mapErrorRefresh')?.addEventListener('click', function() {
        window.location.reload();
      });
    }
  }
});
// CHAT
    function initChat(){
      const tog=document.getElementById('chatToggle'),
            w=document.getElementById('chatWidget'),
            cl=document.getElementById('chatClose');
      tog.onclick=()=>w.classList.toggle('open');
      cl.onclick=()=>w.classList.remove('open');
      document.getElementById('chatInput').addEventListener('submit',async e=>{
        e.preventDefault();
        const inp=e.target.querySelector('input'),txt=inp.value.trim();
        if(!txt) return;
        addChat('me',txt); inp.value='';
        addChat('bot','...');
        try{
          const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:txt})});
          const d=await res.json();
          const ps=document.querySelectorAll('#chatBody .bot p');
          ps[ps.length-1].textContent=d.reply||"Couldn't process.";
        }catch{
          const ps=document.querySelectorAll('#chatBody .bot p');
          ps[ps.length-1].textContent="Connection error.";
        }
      });
    }
    function addChat(who,txt){
      const b=document.getElementById('chatBody'),d=document.createElement('div');
      d.className='row '+who; d.innerHTML=`<p>${txt}</p>`; b.append(d); b.scrollTop=b.scrollHeight;
    }
    // StudyBuddy Integration Script (No Alerts)
// Add this script at the end of your HTML to fix both the map and review form

(function() {
  console.log("StudyBuddy integration script loading...");
  
  // Toast notification system (no alerts)
  function createToastSystem() {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 300px;
      `;
      document.body.appendChild(toastContainer);
    }
    
    // Toast creation function
    window.showToast = function(message, type = 'info', duration = 5000) {
      // Create toast element
      const toast = document.createElement('div');
      
      // Set colors based on type
      let bgColor, borderColor;
      switch(type) {
        case 'error':
          bgColor = 'rgba(255,65,54,0.95)';
          borderColor = '#ff4136';
          break;
        case 'success':
          bgColor = 'rgba(46,204,113,0.95)';
          borderColor = '#2ecc71';
          break;
        case 'warning':
          bgColor = 'rgba(255,133,27,0.95)';
          borderColor = '#ff851b';
          break;
        default:
          bgColor = 'rgba(52,152,219,0.95)';
          borderColor = '#3498db';
      }
      
      // Style toast
      toast.style.cssText = `
        background: ${bgColor};
        color: white;
        padding: 12px 16px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-top: 5px;
        font-size: 14px;
        border-left: 4px solid ${borderColor};
        animation: slideIn 0.3s ease;
        position: relative;
        transition: opacity 0.3s ease;
      `;
      
      // Add message and close button
      toast.innerHTML = `
        ${message}
        <span style="position:absolute;top:8px;right:8px;cursor:pointer;font-weight:bold;">Ã—</span>
      `;
      
      // Add to container
      toastContainer.appendChild(toast);
      
      // Add close handler
      toast.querySelector('span').onclick = () => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      };
      
      // Auto-remove after duration
      if (duration > 0) {
        setTimeout(() => {
          if (document.body.contains(toast)) {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
          }
        }, duration);
      }
      
      return toast;
    };
    
    // Add animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(style);
  }
  
  // Fix the Cafe Map
  function fixCafeMap() {
    // Check if map container exists
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
      console.log("Map container not found");
      return;
    }
    
    console.log("Fixing cafe map...");
    
    // Make map container bigger
    mapContainer.style.height = '600px';
    
    // Load Leaflet if not already loaded
    if (typeof L === 'undefined') {
      console.log("Loading Leaflet...");
      
      // Load CSS
      const leafletCSS = document.createElement('link');
      leafletCSS.rel = 'stylesheet';
      leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      document.head.appendChild(leafletCSS);
      
      // Load JS
      const leafletScript = document.createElement('script');
      leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      
      // Wait for leaflet to load, then initialize map
      leafletScript.onload = function() {
        console.log("Leaflet loaded");
        initializeMap();
      };
      
      // Handle loading error
      leafletScript.onerror = function() {
        console.error("Failed to load Leaflet");
        showMapError("Failed to load map library");
      };
      
      document.head.appendChild(leafletScript);
    } else {
      // Leaflet already loaded, initialize directly
      console.log("Leaflet already loaded");
      initializeMap();
    }
    
    // Initialize map
    function initializeMap() {
      // Check if a map is already initialized
      if (window.leafletMap) {
        console.log("Map already initialized");
        return;
      }
      
      // Show loading state
      mapContainer.innerHTML = `
        <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(30,30,30,0.8);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:999;">
          <div style="width:40px;height:40px;border:3px solid rgba(140,103,255,0.3);border-radius:50%;border-top-color:#8c67ff;animation:spin 1s linear infinite;margin-bottom:15px;"></div>
          <div style="color:white;font-size:16px;">Loading map...</div>
          <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
        </div>
      `;
      
      // Get user location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          // Success
          function(position) {
            setupMap(position.coords.latitude, position.coords.longitude);
          },
          // Error
          function(error) {
            console.warn("Geolocation error:", error);
            setupMap(40.7128, -74.0060); // New York as fallback
          },
          { timeout: 5000 }
        );
      } else {
        setupMap(40.7128, -74.0060); // New York as fallback
      }
    }
    
    // Set up map with error handling
    function setupMap(lat, lng) {
      try {
        // Clear container
        mapContainer.innerHTML = '';
        
        // Initialize map
        const map = L.map('map', {
          center: [lat, lng],
          zoom: 14,
          zoomControl: true
        });
        
        window.leafletMap = map;
        
        // Add a simple tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);
        
        // Add user marker
        const userMarker = L.circle([lat, lng], {
          radius: 300,
          color: '#4f46e5',
          fillColor: '#4f46e5',
          fillOpacity: 0.4
        }).addTo(map);
        
        userMarker.bindPopup("Your location").openPopup();
        
        // Add search radius
        L.circle([lat, lng], {
          radius: 2000,
          color: '#8c67ff',
          fillColor: '#8c67ff',
          fillOpacity: 0.05,
          weight: 1
        }).addTo(map);
        
        // Add reload button for easy recovery
        const reloadControl = L.Control.extend({
          options: { position: 'bottomright' },
          onAdd: function() {
            const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            container.innerHTML = `
              <a href="#" id="reload-map" title="Reload map" style="display:block;width:30px;height:30px;line-height:30px;text-align:center;font-size:16px;color:#fafafa;background:#1e1e1e;border-radius:4px;">â†»</a>
            `;
            
            L.DomEvent.disableClickPropagation(container);
            L.DomEvent.disableScrollPropagation(container);
            
            // Add click handler
            setTimeout(() => {
              document.getElementById('reload-map')?.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.reload();
              });
            }, 100);
            
            return container;
          }
        });
        
        map.addControl(new reloadControl());
        
        // Fetch cafes
        fetchCafes(lat, lng);
        
      } catch (error) {
        console.error("Error setting up map:", error);
        showMapError("There was a problem loading the map");
      }
    }
    
    // Show map error
    function showMapError(message) {
      mapContainer.innerHTML = `
        <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(30,30,30,0.9);display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:20px;">
          <div style="color:white;font-size:20px;margin-bottom:15px;">Map Error</div>
          <div style="color:#b0b0b0;font-size:16px;max-width:80%;margin-bottom:20px;">
            ${message}
          </div>
          <button onclick="window.location.reload()" style="background:#8c67ff;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;font-size:14px;">
            Reload Page
          </button>
        </div>
      `;
    }
    
    // Fetch cafes (simplified to avoid errors)
    function fetchCafes(lat, lng, radius = 2000) {
      // Loading indicator
      const loadingEl = document.createElement('div');
      loadingEl.id = 'cafe-loading';
      loadingEl.style.cssText = `
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(30,30,30,0.8);
        color: white;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 14px;
        z-index: 1000;
      `;
      loadingEl.textContent = 'Finding study spots...';
      mapContainer.appendChild(loadingEl);
      
      // Create a simpler query for better reliability
      const query = `
        [out:json][timeout:10];
        (
          node["amenity"="cafe"](around:${radius},${lat},${lng});
          node["amenity"="library"](around:${radius},${lat},${lng});
        );
        out body;
      `;
      
      // Fetch with timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);
      
      fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'data=' + encodeURIComponent(query),
        signal: controller.signal
      })
      .then(response => {
        clearTimeout(timeoutId);
        return response.json();
      })
      .then(data => {
        // Remove loading
        document.getElementById('cafe-loading')?.remove();
        
        // Process cafe data
        if (data && data.elements && data.elements.length > 0) {
          processCafes(data.elements);
          window.showToast(`Found ${data.elements.length} study spots`, 'success');
        } else {
          window.showToast('No cafes found in this area', 'info');
        }
      })
      .catch(error => {
        clearTimeout(timeoutId);
        document.getElementById('cafe-loading')?.remove();
        console.error("Error fetching cafes:", error);
        
        // Show error message
        const errorEl = document.createElement('div');
        errorEl.style.cssText = `
          position: absolute;
          bottom: 70px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(220,53,69,0.9);
          color: white;
          padding: 10px 20px;
          border-radius: 4px;
          z-index: 999;
          text-align: center;
        `;
        errorEl.textContent = 'Error fetching cafe data. Please reload and try again.';
        mapContainer.appendChild(errorEl);
        
        // Auto-remove after 5 seconds
        setTimeout(() => errorEl.remove(), 5000);
      });
    }
    
    // Process cafes
    function processCafes(elements) {
      // Filter valid nodes
      const validNodes = elements.filter(el => el.type === 'node' && el.tags);
      
      if (validNodes.length === 0) return;
      
      // Colors for different types
      const colors = {
        cafe: '#8c67ff',
        library: '#4f46e5',
        default: '#8c67ff'
      };
      
      // Global cafe list
      window.allCafes = [];
      
      // Process each node
      validNodes.forEach(node => {
        // Determine type
        let placeType = node.tags.amenity || 'default';
        
        // Get name
        const placeName = node.tags.name || `Cafe #${node.id.toString().slice(-4)}`;
        
        // Create object
        const place = {
          id: node.id,
          name: placeName,
          lat: node.lat,
          lng: node.lon,
          type: placeType
        };
        
        // Add to list
        window.allCafes.push(place);
        
        // Add marker
        const marker = L.circleMarker([place.lat, place.lng], {
          radius: 8,
          color: colors[placeType] || colors.default,
          fillColor: colors[placeType] || colors.default,
          fillOpacity: 0.8,
          weight: 2
        }).addTo(window.leafletMap);
        
        // Create popup
        const popupContent = `
          <div style="width:200px;">
            <h3 style="margin:0 0 8px;color:${colors[placeType] || colors.default};font-size:16px;">${place.name}</h3>
            <div style="margin:5px 0;font-size:12px;">
              <strong>Type:</strong> ${placeType === 'cafe' ? 'CafÃ©' : (placeType === 'library' ? 'Library' : 'Study Spot')}
            </div>
            <button onclick="selectCafeForReview('${place.name.replace(/'/g, "\\'")}')" 
              style="width:100%;margin-top:8px;background:${colors[placeType] || colors.default};color:white;border:none;padding:6px;border-radius:4px;cursor:pointer;">
              Add Review
            </button>
          </div>
        `;
        
        marker.bindPopup(popupContent);
      });
      
      // Update cafe list
      updateCafeList();
    }
    
    // Update cafe list
    function updateCafeList() {
      const cafeList = document.getElementById('cafeList');
      if (!cafeList || !window.allCafes) return;
      
      // Clear list
      cafeList.innerHTML = '';
      
      // Sort cafes
      const sortedCafes = [...window.allCafes].sort((a, b) => 
        a.name.localeCompare(b.name)
      );
      
      // Add to list
      sortedCafes.forEach(cafe => {
        const option = document.createElement('option');
        option.value = cafe.name;
        cafeList.appendChild(option);
      });
    }
  }
  
  // Fix review form
  function fixReviewForm() {
    const reviewForm = document.getElementById('reviewForm');
    if (!reviewForm) return;
    
    console.log("Fixing review form...");
    
    // Clear existing handler
    reviewForm.onsubmit = null;
    
    // Add inline validation
    reviewForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Get fields
      const nameInput = document.getElementById('reviewName');
      const ratingInput = document.getElementById('reviewRating');
      const categoryInput = document.getElementById('reviewCategory');
      const textInput = document.getElementById('reviewText');
      
      // Get values
      const name = nameInput?.value.trim() || '';
      const rating = ratingInput?.value || '';
      const category = categoryInput?.value || '';
      const text = textInput?.value.trim() || '';
      
      // Clear previous errors
      reviewForm.querySelectorAll('.form-error').forEach(el => el.remove());
      
      // Reset borders
      [nameInput, ratingInput, categoryInput, textInput].forEach(input => {
        if (input) input.style.borderColor = '';
      });
      
      // Validate
      let valid = true;
      
      if (!name) {
        highlightError(nameInput);
        valid = false;
      }
      
      if (!rating) {
        highlightError(ratingInput);
        valid = false;
      }
      
      if (!category) {
        highlightError(categoryInput);
        valid = false;
      }
      
      if (!text) {
        highlightError(textInput);
        valid = false;
      }
      
      if (!valid) {
        // Show overall message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'form-error';
        errorDiv.style.cssText = `
          background: rgba(255,100,100,0.1);
          color: #ff6464;
          padding: 10px;
          border-radius: var(--rad-s);
          margin-bottom: 15px;
          border-left: 3px solid #ff6464;
        `;
        errorDiv.textContent = 'Please fill in all required fields';
        reviewForm.prepend(errorDiv);
        return;
      }
      
      // Save review
      try {
        // Get existing reviews
        let reviews = [];
        try {
          reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
        } catch (e) {
          console.error("Error parsing reviews:", e);
          reviews = [];
        }
        
        // Add new review
        reviews.push({
          name: name,
          rating: parseInt(rating),
          category: category,
          text: text,
          date: new Date().toISOString().split('T')[0]
        });
        
        // Save back
        localStorage.setItem('sb-reviews', JSON.stringify(reviews));
        
        // Reset form
        reviewForm.reset();
        
        // Show success toast
        window.showToast('Review added successfully!', 'success');
        
        // Update reviews if function exists
        if (typeof renderReviews === 'function') {
          renderReviews();
        }
        
      } catch (error) {
        console.error("Error saving review:", error);
        window.showToast('Error saving your review', 'error');
      }
    });
    
    // Highlight error field
    function highlightError(field) {
      if (!field) return;
      field.style.borderColor = '#ff6464';
    }
  }
  
  // Add global cafe selection function
  window.selectCafeForReview = function(cafeName) {
    const reviewName = document.getElementById('reviewName');
    const reviewForm = document.getElementById('reviewForm');
    
    if (reviewName && reviewForm) {
      reviewName.value = cafeName;
      reviewForm.scrollIntoView({ behavior: 'smooth' });
    }
  };
  
  // Run our fixes when the page is loaded
  document.addEventListener('DOMContentLoaded', function() {
    createToastSystem();
    fixCafeMap();
    fixReviewForm();
    
    console.log("StudyBuddy integration complete");
  });
})();

// StudyBuddy Fix Script
// Add this at the end of your HTML body to fix map loading, review submission, and replace alerts
// This script fixes:
// 1. Cafe map loading with real data (no more mock cafes)
// 2. Review form submission and storage
// 3. Replace alerts with toast notifications
// 4. Enable map search radius up to 100km

(function() {
  console.log("StudyBuddy Fix Script - Loading...");
  
  // ======= Toast Notification System (No Alerts) =======
  function createToastSystem() {
    // Create toast container
    const toastContainer = document.createElement('div');
    toastContainer.id = 'sb-toast-container';
    toastContainer.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 300px;
    `;
    document.body.appendChild(toastContainer);
    
    // Add toast animation styles
    const toastStyles = document.createElement('style');
    toastStyles.textContent = `
      @keyframes sbToastIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes sbToastOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      .sb-toast {
        padding: 12px 16px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-top: 5px;
        font-size: 14px;
        border-left: 4px solid;
        animation: sbToastIn 0.3s ease;
        position: relative;
        color: white;
        max-width: 300px;
      }
      .sb-toast.info { background: rgba(52,152,219,0.95); border-color: #3498db; }
      .sb-toast.success { background: rgba(46,204,113,0.95); border-color: #2ecc71; }
      .sb-toast.error { background: rgba(231,76,60,0.95); border-color: #e74c3c; }
      .sb-toast.warning { background: rgba(241,196,15,0.95); border-color: #f1c40f; }
    `;
    document.head.appendChild(toastStyles);
    
    // Global function to show toast
    window.showToast = function(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `sb-toast ${type}`;
      
      toast.innerHTML = `
        ${message}
        <span style="position:absolute;top:8px;right:8px;cursor:pointer;font-weight:bold;">Ã—</span>
      `;
      
      // Add close handler
      toast.querySelector('span').onclick = () => {
        toast.style.animation = 'sbToastOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      };
      
      // Add to container
      document.getElementById('sb-toast-container').appendChild(toast);
      
      // Auto-remove after duration
      if (duration > 0) {
        setTimeout(() => {
          if (document.body.contains(toast)) {
            toast.style.animation = 'sbToastOut 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
          }
        }, duration);
      }
      
      return toast;
    };
  }
  
  // ======= Fix Cafe Map =======
  function fixCafeMap() {
    console.log("Fixing cafe map...");
    
    // Find map container
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
      console.log("Map container not found");
      return;
    }
    
    // Improve map styling and ensure proper height
    mapContainer.style.cssText = `
      width: 100%;
      height: 500px;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      position: relative;
      z-index: 1;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 20px rgba(0,0,0,.15);
    `;
    
    // Check if Leaflet is defined - if not, load it
    if (typeof L === 'undefined') {
      console.log("Loading Leaflet...");
      
      // Add Leaflet CSS
      const leafletCSS = document.createElement('link');
      leafletCSS.rel = 'stylesheet';
      leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      document.head.appendChild(leafletCSS);
      
      // Add Leaflet JS
      const leafletScript = document.createElement('script');
      leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      leafletScript.onload = initializeMap;
      document.head.appendChild(leafletScript);
    } else {
      // Leaflet already available
      initializeMap();
    }
    
    function initializeMap() {
      console.log("Initializing map...");
      
      // Show loading state
      mapContainer.innerHTML = `
        <div style="position:absolute; inset:0; background:rgba(30,30,30,0.8); 
             display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:10;">
          <div style="width:40px; height:40px; border:3px solid rgba(140,103,255,0.3); 
               border-radius:50%; border-top-color:var(--ac-1); animation:mapSpin 1s linear infinite;"></div>
          <div style="color:white; margin-top:15px; font-size:14px;">Loading map...</div>
        </div>
        <style>@keyframes mapSpin { to { transform: rotate(360deg); } }</style>
      `;
      
      // Get user location with fallback
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            // Success
            createMap(position.coords.latitude, position.coords.longitude);
          },
          (error) => {
            // Error - use fallback coordinates
            console.warn("Geolocation error:", error);
            createMap(37.7749, -122.4194); // Default to San Francisco
          },
          { timeout: 5000, maximumAge: 60000 }
        );
      } else {
        // Geolocation not supported
        createMap(37.7749, -122.4194); // Default to San Francisco
      }
    }
    
    function createMap(lat, lng) {
      // Clear container
      mapContainer.innerHTML = '';
      
      try {
        // Create the map
        const map = L.map('map', {
          center: [lat, lng],
          zoom: 13,
          attributionControl: true,
          zoomControl: true
        });
        
        // Store reference for other functions
        window.cafeMap = map;
        
        // Add a tile layer - dark theme
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          maxZoom: 19
        }).addTo(map);
        
        // Add user location marker
        const userMarker = L.circleMarker([lat, lng], {
          radius: 8,
          fillColor: "#8c67ff",
          color: "#4f46e5",
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(map);
        
        userMarker.bindPopup("Your location").openPopup();
        
        // Add radius selector control
        const radiusControl = L.Control.extend({
          options: { position: 'topleft' },
          onAdd: function() {
            const container = L.DomUtil.create('div', 'leaflet-control radius-control');
            container.style.cssText = `
              background: rgba(30,30,30,0.8);
              padding: 10px;
              border-radius: 4px;
              box-shadow: 0 1px 5px rgba(0,0,0,0.4);
              color: white;
              width: 200px;
            `;
            
            container.innerHTML = `
              <label style="display:block;margin-bottom:5px;font-size:12px;color:#b0b0b0;">Search Radius</label>
              <input type="range" id="radius-slider" min="1000" max="100000" step="1000" value="5000" style="width:100%;">
              <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:2px;color:#b0b0b0;">
                <span>1km</span>
                <span>100km</span>
              </div>
              <div id="radius-value" style="text-align:center;margin-top:3px;font-size:12px;color:#fafafa;">5km</div>
            `;
            
            // Prevent map events
            L.DomEvent.disableClickPropagation(container);
            L.DomEvent.disableScrollPropagation(container);
            
            // Add event listener after element is added to DOM
            setTimeout(() => {
              const slider = document.getElementById('radius-slider');
              const valueDisplay = document.getElementById('radius-value');
              
              if (slider && valueDisplay) {
                slider.addEventListener('input', function() {
                  const value = parseInt(this.value);
                  valueDisplay.textContent = (value / 1000).toFixed(1) + 'km';
                });
                
                slider.addEventListener('change', function() {
                  const radius = parseInt(this.value);
                  fetchRealCafes(map, lat, lng, radius);
                });
              }
            }, 100);
            
            return container;
          }
        });
        
        // Add refresh button
        const refreshControl = L.Control.extend({
          options: { position: 'bottomright' },
          onAdd: function() {
            const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            const link = L.DomUtil.create('a', '', container);
            link.href = '#';
            link.title = 'Refresh cafes';
            link.innerHTML = 'â†»';
            link.style.cssText = 'font-weight:bold; font-size:16px; display:flex; align-items:center; justify-content:center;';
            
            L.DomEvent.on(link, 'click', function(e) {
              L.DomEvent.preventDefault(e);
              // Get current radius value
              const radiusSlider = document.getElementById('radius-slider');
              const radius = radiusSlider ? parseInt(radiusSlider.value) : 5000;
              fetchRealCafes(map, lat, lng, radius);
            });
            
            return container;
          }
        });
        
        map.addControl(new radiusControl());
        map.addControl(new refreshControl());
        
        // Fetch real cafe data
        fetchRealCafes(map, lat, lng, 5000);
        
        // Add custom CSS for map
        const mapStyle = document.createElement('style');
        mapStyle.textContent = `
          .leaflet-container { background: #1e1e1e; }
          .leaflet-popup-content-wrapper, .leaflet-popup-tip { 
            background: var(--bg-2); 
            color: var(--txt-1);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,.25);
          }
          .leaflet-bar a { 
            background: var(--bg-2); 
            color: var(--txt-1);
            border: 1px solid rgba(255,255,255,0.1);
          }
          .leaflet-bar a:hover { 
            background: var(--bg-3);
            color: var(--ac-1);
          }
        `;
        document.head.appendChild(mapStyle);
        
      } catch (error) {
        console.error("Error creating map:", error);
        mapContainer.innerHTML = `
          <div style="position:absolute; inset:0; background:rgba(30,30,30,0.9); display:flex; 
               align-items:center; justify-content:center; flex-direction:column; text-align:center;">
            <div style="font-size:24px; margin-bottom:15px; color:white;">ðŸ˜• Map Error</div>
            <div style="color:#b0b0b0; max-width:80%; margin-bottom:20px;">
              There was a problem loading the map. Please refresh the page and try again.
            </div>
            <button onclick="location.reload()" style="background:var(--ac-1); border:none; color:white; 
                    padding:10px 20px; border-radius:6px; cursor:pointer;">
              Refresh Page
            </button>
          </div>
        `;
      }
    }
    
    // Store marker references for cleanup
    let cafeMarkers = [];
    // Reference to radius circle
    let searchRadiusCircle = null;
    // Current search radius
    let currentRadius = 5000; // Default 5km
    
    function fetchRealCafes(map, userLat, userLng, radius = 5000) {
      // Clear existing markers
      cafeMarkers.forEach(marker => {
        if (marker) map.removeLayer(marker);
      });
      cafeMarkers = [];
      
      // Update radius circle if it exists
      if (searchRadiusCircle) {
        map.removeLayer(searchRadiusCircle);
      }
      
      // Create new search radius circle
      searchRadiusCircle = L.circle([userLat, userLng], {
        radius: radius,
        color: 'rgba(140, 103, 255, 0.7)',
        fillColor: 'rgba(140, 103, 255, 0.1)',
        fillOpacity: 0.2,
        weight: 2
      }).addTo(map);
      
      // Show loading indicator
      const loadingIndicator = document.createElement('div');
      loadingIndicator.id = 'cafe-loading-indicator';
      loadingIndicator.style.cssText = `
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(30, 30, 30, 0.8);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 8px;
      `;
      loadingIndicator.innerHTML = `
        <span style="display:inline-block; width:14px; height:14px; border:2px solid rgba(140,103,255,0.3); 
              border-radius:50%; border-top-color:var(--ac-1); animation:mapSpin 1s linear infinite;"></span>
        <span>Finding study spots within ${(radius/1000).toFixed(1)}km...</span>
      `;
      document.getElementById('map').appendChild(loadingIndicator);
      
      // Update current radius
      currentRadius = radius;
      
      // Query for cafes, libraries, and study-friendly places
      const query = `
        [out:json][timeout:25];
        (
          node["amenity"="cafe"](around:${radius},${userLat},${userLng});
          node["amenity"="library"](around:${radius},${userLat},${userLng});
          node["shop"="coffee"](around:${radius},${userLat},${userLng});
          node["amenity"="college"](around:${radius},${userLat},${userLng});
          node["amenity"="university"](around:${radius},${userLat},${userLng});
        );
        out body;
      `;
      
      // Create a fetch request with timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 20000); // 20s timeout
      
      fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'data=' + encodeURIComponent(query),
        signal: controller.signal
      })
      .then(response => {
        clearTimeout(timeoutId);
        if (!response.ok) {
          throw new Error('Network response not ok');
        }
        return response.json();
      })
      .then(data => {
        // Remove loading indicator
        document.getElementById('cafe-loading-indicator')?.remove();
        
        // Check if we got results
        if (data && data.elements && data.elements.length > 0) {
          processCafeData(map, data.elements);
          // Show success message
          window.showToast(`Found ${data.elements.length} study places within ${(radius/1000).toFixed(1)}km`, 'success');
        } else {
          window.showToast('No cafes found in this area. Try increasing the search radius.', 'info');
        }
      })
      .catch(error => {
        clearTimeout(timeoutId);
        document.getElementById('cafe-loading-indicator')?.remove();
        console.error("Error fetching cafes:", error);
        window.showToast('Error loading cafe data. Please try again.', 'error');
      });
    }
    
    // Process cafe data from Overpass API
    function processCafeData(map, elements) {
      // Global container for all cafes
      window.allCafes = [];
      
      // Define icons/colors for different place types
      const placeTypes = {
        'cafe': { color: '#8c67ff', icon: 'â˜•', label: 'CafÃ©' },
        'library': { color: '#4f46e5', icon: 'ðŸ“š', label: 'Library' },
        'coffee': { color: '#8c67ff', icon: 'â˜•', label: 'Coffee Shop' },
        'college': { color: '#10b981', icon: 'ðŸŽ“', label: 'College' },
        'university': { color: '#10b981', icon: 'ðŸŽ“', label: 'University' },
        'default': { color: '#8c67ff', icon: 'ðŸ“', label: 'Study Spot' }
      };
      
      // Process each element
      elements.forEach(element => {
        // Skip elements without necessary data
        if (element.type !== 'node' || !element.lat || !element.lon) return;
        
        // Determine place type
        let placeType = 'default';
        if (element.tags) {
          if (element.tags.amenity === 'cafe') placeType = 'cafe';
          else if (element.tags.amenity === 'library') placeType = 'library';
          else if (element.tags.shop === 'coffee') placeType = 'coffee';
          else if (element.tags.amenity === 'college') placeType = 'college';
          else if (element.tags.amenity === 'university') placeType = 'university';
        }
        
        const typeInfo = placeTypes[placeType];
        
        // Get place name (or create generic one)
        const placeName = element.tags?.name || `${typeInfo.label} #${element.id.toString().slice(-4)}`;
        
        // Build address from available tags
        let address = '';
        if (element.tags) {
          const addressParts = [];
          if (element.tags['addr:housenumber']) addressParts.push(element.tags['addr:housenumber']);
          if (element.tags['addr:street']) addressParts.push(element.tags['addr:street']);
          if (element.tags['addr:city']) addressParts.push(element.tags['addr:city']);
          address = addressParts.join(', ');
        }
        
        // Create place object
        const place = {
          id: element.id,
          name: placeName,
          lat: element.lat,
          lng: element.lon,
          type: placeType,
          address: address || 'Address not available',
          tags: element.tags || {}
        };
        
        // Add to global list
        window.allCafes.push(place);
        
        // Create marker
        const marker = L.marker([place.lat, place.lng], {
          icon: L.divIcon({
            html: `<div style="background:${typeInfo.color};color:white;width:28px;height:28px;
                  display:flex;align-items:center;justify-content:center;border-radius:50%;
                  font-size:16px;box-shadow:0 2px 5px rgba(0,0,0,0.3);">${typeInfo.icon}</div>`,
            className: '',
            iconSize: [28, 28],
            iconAnchor: [14, 14]
          }),
          title: place.name
        }).addTo(map);
        
        // Store reference for later cleanup
        cafeMarkers.push(marker);
        
        // Create popup content
        const popupContent = `
          <div style="width:250px;padding:8px 0;">
            <h3 style="margin:0 0 8px;color:${typeInfo.color};font-size:16px;font-weight:bold;">${place.name}</h3>
            
            <div style="margin:8px 0;font-size:12px;">
              <span style="display:inline-block;background:${typeInfo.color};color:white;
                     padding:3px 8px;border-radius:12px;font-size:11px;">${typeInfo.label}</span>
            </div>
            
            ${place.address !== 'Address not available' ? 
              `<p style="margin:8px 0;font-size:13px;"><strong>Address:</strong><br>${place.address}</p>` : ''}
            
            ${place.tags.opening_hours ? 
              `<div style="margin:8px 0;font-size:12px;"><strong>Hours:</strong><br>${place.tags.opening_hours}</div>` : ''}
            
            <div style="display:flex;gap:5px;margin-top:10px;">
              <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name + ' ' + place.address)}" 
                target="_blank" rel="noopener" 
                style="flex:1;text-decoration:none;background:#4285F4;color:white;padding:6px 0;
                border-radius:4px;font-size:12px;text-align:center;">
                View on Maps
              </a>
              ${place.tags.website ? 
                `<a href="${place.tags.website}" target="_blank" rel="noopener" 
                  style="flex:1;text-decoration:none;background:#10b981;color:white;padding:6px 0;
                  border-radius:4px;font-size:12px;text-align:center;">Website</a>` : ''}
            </div>
            
            <button onclick="selectCafeForReview('${place.name.replace(/'/g, "\\'")}')" 
              style="width:100%;margin-top:8px;background:${typeInfo.color};color:white;border:none;
              padding:8px 0;border-radius:4px;cursor:pointer;font-size:13px;">
              Add Review
            </button>
          </div>
        `;
        
        // Bind popup to marker
        marker.bindPopup(popupContent);
      });
      
      // Update cafe list for datalist
      updateCafeListOptions();
    }
    
    // Update cafe options in the datalist
    function updateCafeListOptions() {
      const cafeList = document.getElementById('cafeList');
      if (!cafeList || !window.allCafes) return;
      
      // Clear existing options
      cafeList.innerHTML = '';
      
      // Add options for each cafe
      window.allCafes.forEach(cafe => {
        const option = document.createElement('option');
        option.value = cafe.name;
        cafeList.appendChild(option);
      });
    }
  }
  
  // ======= Fix Review Form =======
  function fixReviewForm() {
    console.log("Fixing review form...");
    
    const reviewForm = document.getElementById('reviewForm');
    if (!reviewForm) {
      console.log("Review form not found");
      return;
    }
    
    // Make sure cafe name selection works
    window.selectCafeForReview = function(cafeName) {
      const reviewNameInput = document.getElementById('reviewName');
      if (reviewNameInput) {
        reviewNameInput.value = cafeName;
        
        // Scroll to the form
        reviewForm.scrollIntoView({ behavior: 'smooth' });
        
        // Focus on the rating after a brief delay
        setTimeout(() => {
          document.getElementById('reviewRating')?.focus();
        }, 300);
        
        window.showToast(`Selected "${cafeName}" for review`, 'info', 2000);
      }
    };
    
    // Replace original form submission handler
    reviewForm.onsubmit = null;
    
    // Add new submit handler
    reviewForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Get form fields
      const name = document.getElementById('reviewName')?.value?.trim();
      const rating = document.getElementById('reviewRating')?.value;
      const category = document.getElementById('reviewCategory')?.value;
      const text = document.getElementById('reviewText')?.value?.trim();
      
      console.log("Review form submitted:", { name, rating, category, text });
      
      // Validate inputs without alerts
      let isValid = true;
      
      // Clear previous error messages
      reviewForm.querySelectorAll('.error-message').forEach(el => el.remove());
      
      // Reset input borders
      ['reviewName', 'reviewRating', 'reviewCategory', 'reviewText'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.border = '1px solid rgba(255, 255, 255, 0.1)';
      });
      
      // Validate each field
      if (!name) {
        addErrorToField('reviewName', 'Please enter a cafe name');
        isValid = false;
      }
      
      if (!rating) {
        addErrorToField('reviewRating', 'Please select a rating');
        isValid = false;
      }
      
      if (!category) {
        addErrorToField('reviewCategory', 'Please select a category');
        isValid = false;
      }
      
      if (!text) {
        addErrorToField('reviewText', 'Please share your experience');
        isValid = false;
      }
      
      if (!isValid) return;
      
      // Save the review
      try {
        // Get existing reviews
        let reviews = [];
        try {
          reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
        } catch (e) {
          console.error("Error parsing reviews:", e);
          reviews = [];
        }
        
        // Create review object
        const review = {
          name: name,
          rating: parseInt(rating),
          category: category,
          text: text,
          date: new Date().toISOString().split('T')[0]
        };
        
        // Add to array
        reviews.push(review);
        
        // Save back to localStorage
        localStorage.setItem('sb-reviews', JSON.stringify(reviews));
        
        console.log("Review saved successfully:", review);
        
        // Reset form
        reviewForm.reset();
        
        // Show success message
        window.showToast('Review added successfully!', 'success');
        
        // Call renderReviews if it exists
        if (typeof renderReviews === 'function') {
          renderReviews();
        } else {
          // If renderReviews doesn't exist, we'll create our own implementation
          createRenderReviews();
          renderReviews();
        }
        
      } catch (error) {
        console.error("Error saving review:", error);
        window.showToast('Error saving review. Please try again.', 'error');
      }
    });
    
    // Helper function to add error message to field
    function addErrorToField(fieldId, message) {
      const field = document.getElementById(fieldId);
      if (!field) return;
      
      // Highlight the field
      field.style.border = '1px solid #ff6464';
      
      // Add error message
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.style.cssText = `
        color: #ff6464;
        font-size: 0.8rem;
        margin-top: -0.8rem;
        margin-bottom: 0.8rem;
      `;
      errorDiv.textContent = message;
      
      // Insert after the field
      field.parentNode.insertBefore(errorDiv, field.nextSibling);
      
      // Remove error on focus
      field.addEventListener('focus', function() {
        field.style.border = '1px solid var(--ac-1)';
        document.querySelectorAll(`.error-message`).forEach(el => {
          if (el.previousElementSibling === field) {
            el.remove();
          }
        });
      }, { once: true });
    }
  }
  
  // Create renderReviews function if it doesn't exist
  function createRenderReviews() {
    if (typeof renderReviews === 'function') return;
    
    window.renderReviews = function() {
      console.log("Rendering reviews...");
      
      const cafeReviews = document.getElementById('cafeReviews');
      if (!cafeReviews) return;
      
      // Get reviews from localStorage
      let reviews = [];
      try {
        reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
      } catch (e) {
        console.error("Error parsing reviews:", e);
        reviews = [];
      }
      
      console.log(`Rendering ${reviews.length} reviews`);
      
      // Clear container
      cafeReviews.innerHTML = '';
      
      // If no reviews, show message
      if (!reviews.length) {
        cafeReviews.innerHTML = `
          <div class="card" style="text-align:center; padding:2rem;">
            <div style="font-size:4rem; margin-bottom:1rem;">ðŸ“</div>
            <h3 style="margin-bottom:1rem; color:var(--txt-2);">No Reviews Yet</h3>
            <p>Share your experience at your favorite study spots!</p>
          </div>
        `;
        return;
      }
      
      // Group reviews by cafe
      const reviewsByPlace = {};
      reviews.forEach(review => {
        if (!reviewsByPlace[review.name]) {
          reviewsByPlace[review.name] = [];
        }
        reviewsByPlace[review.name].push(review);
      });
      
      // Create grid container
      const grid = document.createElement('div');
      grid.style.cssText = `
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
      `;
      cafeReviews.appendChild(grid);
      
      // Add each place with its reviews
      Object.keys(reviewsByPlace).sort().forEach(placeName => {
        const placeReviews = reviewsByPlace[placeName];
        
        // Create card for this place
        const card = document.createElement('div');
        card.className = 'card cafe-review-card';
        
        // Calculate average rating
        const avgRating = placeReviews.reduce((sum, r) => sum + r.rating, 0) / placeReviews.length;
        
        // Determine most common category
        const categories = {};
        placeReviews.forEach(review => {
          categories[review.category] = (categories[review.category] || 0) + 1;
        });
        let topCategory = '';
        let maxCount = 0;
        for (const cat in categories) {
          if (categories[cat] > maxCount) {
            maxCount = categories[cat];
            topCategory = cat;
          }
        }
        
        // Create review card
        card.innerHTML = `
          <div class="review-header">
            <h3 style="margin:0; font-size:1.3rem;">${placeName}</h3>
            <div class="review-rating">
              ${Array(Math.round(avgRating)).fill('â˜…').join('')}${Array(5-Math.round(avgRating)).fill('â˜†').join('')}
            </div>
          </div>
          
          <div style="margin:8px 0; display:flex; flex-wrap:wrap; gap:5px;">
            <span style="display:inline-block; background:rgba(140,103,255,0.2); color:var(--txt-1);
                 font-size:0.8rem; padding:3px 8px; border-radius:12px;">
              Best for: ${topCategory}
            </span>
            <span style="display:inline-block; background:rgba(255,255,255,0.1); color:var(--txt-2);
                 font-size:0.8rem; padding:3px 8px; border-radius:12px;">
              ${placeReviews.length} review${placeReviews.length > 1 ? 's' : ''}
            </span>
          </div>
          
          <div class="reviews-list" style="max-height:300px; overflow-y:auto; margin-top:10px;">
            ${placeReviews.map((review, i) => {
              // Format date
              let displayDate = 'No date';
              try {
                if (review.date) {
                  const date = new Date(review.date);
                  displayDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                  });
                }
              } catch (e) {
                console.error("Date formatting error:", e);
              }
              
              return `
                <div style="${i > 0 ? 'margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.05);' : ''}">
                  <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <div style="color:var(--ac-warn);">
                      ${Array(review.rating).fill('â˜…').join('')}${Array(5-review.rating).fill('â˜†').join('')}
                    </div>
                    <div style="color:var(--txt-2); font-size:0.8rem;">${displayDate}</div>
                  </div>
                  <p style="margin:0 0 5px; font-size:0.9rem; line-height:1.4;">${review.text}</p>
                  ${review.category ? `
                    <span style="display:inline-block; background:rgba(140,103,255,0.1); color:var(--txt-2);
                         font-size:0.7rem; padding:2px 6px; border-radius:3px; margin-top:5px;">
                      ${review.category}
                    </span>
                  ` : ''}
                  <button data-place="${placeName}" data-index="${i}" class="delete-review btn-small" 
                    style="background:none; border:none; color:var(--ac-warn); cursor:pointer; margin-left:10px;
                           font-size:0.8rem; padding:2px 5px; border-radius:3px; float:right; margin-top:-3px;">
                    Ã—&nbsp;Delete
                  </button>
                </div>
              `;
            }).join('')}
          </div>
        `;
        
        // Add to grid
        grid.appendChild(card);
      });
      
      // Add event listeners for delete buttons
      grid.querySelectorAll('.delete-review').forEach(btn => {
        btn.addEventListener('click', function() {
          const placeName = this.getAttribute('data-place');
          const index = parseInt(this.getAttribute('data-index'));
          
          // Get confirmation without using alert
          if (window.showToast) {
            // Create a confirmation toast with buttons
            const toast = window.showToast(
              `Delete review of "${placeName}"?
              <div style="margin-top:10px;">
                <button id="confirm-delete" style="background:rgba(231,76,60,0.8);color:white;border:none;
                        padding:5px 10px;border-radius:3px;margin-right:10px;cursor:pointer;">
                  Delete
                </button>
                <button id="cancel-delete" style="background:rgba(255,255,255,0.2);color:white;border:none;
                        padding:5px 10px;border-radius:3px;cursor:pointer;">
                  Cancel
                </button>
              </div>`,
              'warning',
              0 // Don't auto-dismiss
            );
            
            // Add event listeners to buttons
            document.getElementById('confirm-delete')?.addEventListener('click', function() {
              deleteReview(placeName, index);
              toast.style.animation = 'sbToastOut 0.3s ease forwards';
              setTimeout(() => toast.remove(), 300);
            });
            
            document.getElementById('cancel-delete')?.addEventListener('click', function() {
              toast.style.animation = 'sbToastOut 0.3s ease forwards';
              setTimeout(() => toast.remove(), 300);
            });
          } else {
            // Fallback to confirm if toast system not available
            if (confirm(`Delete this review of ${placeName}?`)) {
              deleteReview(placeName, index);
            }
          }
        });
      });
      
      function deleteReview(placeName, index) {
        // Get all reviews
        let reviews = [];
        try {
          reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
        } catch (e) {
          console.error("Error parsing reviews:", e);
          return;
        }
        
        // Find all reviews for this place
        const placeReviews = reviews.filter(r => r.name === placeName);
        
        // Make sure index is valid
        if (index >= 0 && index < placeReviews.length) {
          const reviewToDelete = placeReviews[index];
          
          // Find its index in the full array
          const globalIndex = reviews.findIndex(r => 
            r.name === reviewToDelete.name && 
            r.rating === reviewToDelete.rating && 
            r.text === reviewToDelete.text && 
            r.date === reviewToDelete.date
          );
          
          // Remove it if found
          if (globalIndex !== -1) {
            reviews.splice(globalIndex, 1);
            localStorage.setItem('sb-reviews', JSON.stringify(reviews));
            
            // Re-render
            renderReviews();
            
            // Show success message
            window.showToast('Review deleted successfully', 'success');
          }
        }
      }
    };
  }
  
  // Main initialization function
  function init() {
    console.log("Initializing StudyBuddy fixes...");
    
    // Create toast notification system
    createToastSystem();
    
    // Fix cafe map
    fixCafeMap();
    
    // Fix review form
    fixReviewForm();
    
    // Create renderReviews function if it doesn't exist
    createRenderReviews();
    
    console.log("StudyBuddy fixes applied successfully!");
  }
  
  // Run init when document is loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
  </script>
  
</body>
</html>
