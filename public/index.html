<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StudyBuddy</title>

  <!-- Original Google API loader -->
  <script src="https://apis.google.com/js/api.js" defer></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Three.js & Vanta.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.dots.min.js" defer></script>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js" defer></script>

  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  defer
></script>

  <style>
    /* Enhanced CSS Styling for StudyBuddy */
/* Add these styles to the existing CSS */

/* Improved map styling */
#map {
  width: 100%;
  height: 500px;
  border-radius: var(--rad-m);
  margin-bottom: 1.5rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: var(--shadow-s);
  position: relative;
  z-index: 1;
}

/* Custom Leaflet styling */
.leaflet-container {
  background: #1e1e1e;
  font-family: 'Inter', sans-serif;
}

.leaflet-popup-content-wrapper {
  background: var(--bg-2);
  color: var(--txt-1);
  border-radius: var(--rad-m);
  padding: 0;
  box-shadow: var(--shadow-s);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.leaflet-popup-tip {
  background: var(--bg-2);
  box-shadow: var(--shadow-s);
}

.leaflet-popup-content {
  margin: 8px;
  width: auto !important;
}

.leaflet-control {
  margin: 10px !important;
}

.leaflet-bar a {
  background: var(--bg-2);
  color: var(--txt-1);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.leaflet-bar a:hover {
  background: var(--bg-3);
  color: var(--ac-1);
}

.leaflet-control-attribution {
  background: rgba(30, 30, 30, 0.7) !important;
  color: var(--txt-2) !important;
  backdrop-filter: blur(5px);
  padding: 3px 8px;
  border-radius: 4px;
}

.leaflet-control-attribution a {
  color: var(--ac-1) !important;
}

/* Enhanced study planner styling */
#plannerAdvice h3 {
  margin-top: 20px;
  margin-bottom: 10px;
  color: var(--ac-1);
  border-bottom: 1px solid var(--ac-1);
  padding-bottom: 5px;
}

#plannerAdvice div {
  line-height: 1.5;
}

#plannerAdvice strong {
  color: var(--ac-1);
}

/* Download button for study plan */
#downloadPlan {
  margin: 15px auto;
  display: block;
}

/* Enhanced forms */
#reviewForm, #plannerForm {
  background: var(--bg-3);
  padding: 15px;
  border-radius: var(--rad-m);
  margin-bottom: 20px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

#reviewForm input, #reviewForm select, #reviewForm textarea,
#plannerForm input, #plannerForm select, #plannerForm textarea {
  background: var(--bg-2);
  transition: all 0.2s ease;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

#reviewForm input:focus, #reviewForm select:focus, #reviewForm textarea:focus,
#plannerForm input:focus, #plannerForm select:focus, #plannerForm textarea:focus {
  border-color: var(--ac-1);
  box-shadow: 0 0 0 2px rgba(140, 103, 255, 0.2);
}

/* Better form layout for reviews */
#reviewForm {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

#reviewForm div:first-child {
  grid-column: span 2;
}

#reviewForm textarea {
  grid-column: span 2;
}

#reviewForm button {
  grid-column: span 2;
  margin-top: 0.5rem;
}

/* Enhanced cafe review cards */
.cafe-review-card {
  background: var(--bg-2);
  border-radius: var(--rad-m);
  padding: 1.25rem;
  box-shadow: var(--shadow-s);
  border: 1px solid rgba(255, 255, 255, 0.05);
  transition: all 0.3s ease;
  position: relative;
}

.cafe-review-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-l);
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.review-body {
  margin-bottom: 0.5rem;
  line-height: 1.5;
}

.review-rating {
  color: var(--ac-warn);
  font-size: 1.1rem;
}

.review-footer {
  font-size: 0.8rem;
  color: var(--txt-2);
  display: flex;
  justify-content: space-between;
  margin-top: 0.8rem;
  padding-top: 0.5rem;
  border-top: 1px solid rgba(255, 255, 255, 0.05);
}

/* Better styling for the review name input with datalist */
#reviewName {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255, 255, 255, 0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: 10px center;
  padding-left: 2.5rem;
}

/* Add smooth animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in {
  animation: fadeIn 0.4s ease forwards;
}

/* Add some visual flare to the study planner */
#planList .card {
  position: relative;
  overflow: hidden;
}

#planList .card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--ac-1), var(--ac-3));
  border-radius: var(--rad-s) 0 0 var(--rad-s);
}

#planList .card h4 {
  margin-left: 8px;
}

/* Enhanced planner button */
#planStudy {
  background: linear-gradient(135deg, var(--ac-1), var(--ac-2));
  padding: 0.8rem 1.6rem;
  font-weight: 600;
  letter-spacing: 0.5px;
  transition: all 0.3s ease;
  margin-bottom: 1rem;
}

#planStudy:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(140, 103, 255, 0.3);
}

/* Make loading indicators consistent */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(140, 103, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--ac-1);
  animation: spin 1s linear infinite;
  margin-right: 8px;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Add responsive improvements */
@media (max-width: 768px) {
  header {
    padding: 0.8rem 1rem;
  }
  
  .logo {
    font-size: 1.2rem;
  }
  
  main {
    padding: 1rem;
  }
  
  nav button {
    padding: 0.4rem 0.7rem;
    font-size: 0.9rem;
  }
  
  #map {
    height: 350px;
  }
  
  #reviewForm {
    display: block;
  }
  
  #timerDisplay {
    font-size: 2rem;
  }
  
  #tasksBoard {
    flex-direction: column;
  }
  
  .column {
    margin-bottom: 1rem;
  }
  
  #quotes {
    grid-template-columns: 1fr;
  }
}

/* Improve dark mode legibility */
::placeholder {
  color: rgba(176, 176, 176, 0.6);
}

select option {
  background-color: var(--bg-3);
}

/* Touch-specific enhancements */
.touch-device .task {
  position: relative;
}

.touch-device .task-buttons {
  position: absolute;
  right: 10px;
  display: flex;
  gap: 5px;
}

/* Focus styles for accessibility */
button:focus, input:focus, select:focus, textarea:focus {
  outline: 2px solid var(--ac-1);
  outline-offset: 2px;
}

/* Dark scrollbars for better aesthetics */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-1);
}

::-webkit-scrollbar-thumb {
  background: var(--bg-3);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--ac-1);
}

    :root {
      --bg-1:#121212; --bg-2:#1e1e1e; --bg-3:#2d2d2d;
      --txt-1:#fafafa; --txt-2:#b0b0b0;
      --ac-1:#8c67ff; --ac-2:#4f46e5; --ac-3:#ff6f91; --ac-warn:#f2c94c;
      --rad-s:6px; --rad-m:12px; --rad-l:20px;
      --shadow-s:0 4px 20px rgba(0,0,0,.15);
      --shadow-l:0 8px 30px rgba(0,0,0,.35);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
    body{background:var(--bg-1);color:var(--txt-1);min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;}
    a{color:var(--ac-1);text-decoration:none;transition:all .2s ease;}a:hover{text-decoration:underline;}
    #background{position:fixed;inset:0;z-index:-1;}
    header{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;padding:1rem 2rem;background:rgba(30,30,30,.85);backdrop-filter:blur(10px);box-shadow:var(--shadow-s);z-index:10;}
    .logo-container{display:flex;align-items:center;gap:.6rem;}
    .logo-icon{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--ac-1),var(--ac-2));display:grid;place-content:center;color:#fff;font-weight:700;}
    .logo{font-size:1.5rem;font-weight:700;background:linear-gradient(90deg,var(--ac-1),var(--ac-3));-webkit-background-clip:text;color:transparent;}
    nav{display:flex;gap:.3rem;flex-wrap:wrap;}
    nav button{background:none;border:none;color:var(--txt-2);padding:.55rem .95rem;border-radius:var(--rad-s);cursor:pointer;transition:all .2s ease;position:relative;}
    nav button:hover, nav button.active{background:rgba(140,103,255,.12);color:var(--txt-1);}
    nav button.active::after{content:'';position:absolute;left:50%;bottom:0;transform:translateX(-50%);width:22px;height:3px;background:var(--ac-1);border-radius:5px;}
    main{flex:1;max-width:1400px;margin:0 auto;padding:2rem;}
    section{display:none;animation:fade .35s ease-in-out;}section.active{display:block;}
    @keyframes fade{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
    h2.section-title{font-size:1.75rem;margin-bottom:1.4rem;}
    .card{background:var(--bg-2);padding:1.25rem;border-radius:var(--rad-m);box-shadow:var(--shadow-s);border:1px solid rgba(255,255,255,.05);transition:all .3s ease;position:relative;}
    .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-l);}
    .btn{display:inline-flex;align-items:center;gap:.45rem;border:none;cursor:pointer;padding:.7rem 1.4rem;font-weight:500;border-radius:var(--rad-s);box-shadow:0 2px 6px rgba(0,0,0,.2);transition:all .2s ease;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.3);}
    .btn-primary{background:var(--ac-1);color:#fff;} .btn-secondary{background:rgba(255,255,255,.1);color:var(--txt-1);} .btn-small{padding:.3rem .6rem;font-size:.8rem;}
    input,textarea,select{background:var(--bg-3);border:1px solid rgba(255,255,255,.1);color:var(--txt-1);padding:.75rem;border-radius:var(--rad-s);width:100%;margin-bottom:1rem;transition:border-color .2s ease;}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--ac-1);}
    /* Quotes */
    #quotes{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem;}
    #quotes .card{font-style:italic;text-align:center;color:var(--txt-2);}
    /* Pomodoro */
    #timerDisplay{font-size:2.5rem;text-align:center;margin:1rem 0;}
    #timerControls{display:flex;justify-content:center;gap:1rem;}
    /* Tasks */
    #tasksBoard{display:flex;gap:1rem;margin-top:1rem;}
    .column{background:var(--bg-2);flex:1;min-width:240px;padding:1rem;border-radius:var(--rad-m);position:relative;}
    .column h3{margin-bottom:.8rem;color:var(--txt-2);}
    .task{background:var(--bg-3);padding:.6rem 1rem;border-radius:var(--rad-s);margin-bottom:.6rem;display:flex;align-items:center;justify-content:space-between;}
    .task-buttons button{margin-left:.5rem;}
    /* Map */
    #map{width:100%;height:350px;border-radius:var(--rad-m);margin-bottom:1rem;}
    /* Reviews */
    .delete-review{position:absolute;top:4px;right:8px;cursor:pointer;color:var(--ac-warn);font-weight:bold;}
    .delete-review:hover{color:var(--ac-3);}
    /* Games */
    #gameSelect{margin-bottom:1rem;}
    /* Make iframe much bigger */
    #gameFrame{width:100%;height:80vh;border:none;border-radius:var(--rad-m);margin-top:1rem;box-shadow:var(--shadow-s);}
    /* Planner */
    #planList .card{margin-bottom:1rem;padding-right:2.5rem;}
    #plannerAdvice{margin-top:1rem;background:var(--bg-3);padding:1rem;border-radius:var(--rad-s);max-height:300px;overflow-y:auto;white-space:pre-wrap;line-height:1.5;}
    .delete-plan{position:absolute;top:10px;right:10px;cursor:pointer;color:var(--ac-warn);font-weight:bold;font-size:1.2rem;}
    .delete-plan:hover{color:var(--ac-3);}
    /* Chat */
    #chatToggle{position:fixed;bottom:1rem;right:1rem;width:56px;height:56px;border-radius:50%;background:var(--ac-1);color:#fff;font-size:1.5rem;border:none;cursor:pointer;box-shadow:var(--shadow-l);z-index:20;transition:transform 0.3s ease,box-shadow 0.3s ease;}
    #chatToggle:hover{transform:scale(1.1);box-shadow:0 10px 40px rgba(140,103,255,.4);}
    #chatWidget{position:fixed;bottom:1.5rem;right:1.5rem;width:340px;height:400px;background:var(--bg-2);border-radius:var(--rad-l);box-shadow:var(--shadow-l);display:flex;flex-direction:column;overflow:hidden;z-index:20;opacity:0;transform:translateY(20px) scale(0.8);pointer-events:none;transition:opacity .3s ease,transform .3s ease;}
    #chatWidget.open{opacity:1;transform:translateY(0) scale(1);pointer-events:all;}
    #chatHeader{background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;border-top-left-radius:var(--rad-l);border-top-right-radius:var(--rad-l);}
    #chatClose{background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;transition:transform .2s ease;}
    #chatClose:hover{transform:rotate(90deg);}
    #chatBody{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.7rem;scroll-behavior:smooth;background:rgba(18,18,18,.3);}
    .row{display:flex;}
    .row.me{justify-content:flex-end;}
    .row p{padding:.75rem 1rem;border-radius:18px;max-width:80%;font-size:.88rem;line-height:1.5;}
    .me p{background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;border-bottom-right-radius:6px;}
    .bot p{background:var(--bg-3);color:var(--txt-1);border-bottom-left-radius:6px;}
    #chatInput{display:flex;border-top:1px solid rgba(255,255,255,.06);}
    #chatInput input{flex:1;border:none;background:var(--bg-3);color:var(--txt-1);padding:.75rem 1rem;border-radius:var(--rad-s);margin:.5rem;outline:none;}
    #chatInput button{width:42px;height:42px;margin:.5rem;border-radius:50%;background:var(--ac-1);border:none;color:#fff;transition:all .2s ease;cursor:pointer;}
    #chatInput button:hover{transform:scale(1.1);background:var(--ac-2);}
    /* Celebration */
    #celebrationPopup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;padding:2rem;border-radius:var(--rad-l);text-align:center;z-index:100;box-shadow:var(--shadow-l);animation:popIn .5s cubic-bezier(.175,.885,.32,1.275) forwards;}
    #celebrationPopup .emoji{font-size:4rem;margin-bottom:1rem;display:block;}
    #celebrationPopup h2{font-size:2rem;margin-bottom:1rem;}
    #celebrationPopup button{margin-top:1rem;background:rgba(255,255,255,.2);border:none;color:#fff;padding:.5rem 1.5rem;border-radius:var(--rad-s);cursor:pointer;transition:all .2s ease;}
    #celebrationPopup button:hover{background:rgba(255,255,255,.3);}
    @keyframes popIn{0%{transform:translate(-50%,-50%) scale(.8);opacity:0;}100%{transform:translate(-50%,-50%) scale(1);opacity:1;}}
    :root {
      --bg-1: #121212;
      --bg-2: #1e1e1e;
      --bg-3: #2d2d2d;
      --txt-1: #fafafa;
      --txt-2: #b0b0b0;
      --ac-1: #8c67ff;
      --ac-2: #4f46e5;
      --ac-3: #ff6f91;
      --ac-warn: #f2c94c;
      --rad-s: 6px;
      --rad-m: 12px;
      --rad-l: 20px;
      --shadow-s: 0 4px 20px rgba(0, 0, 0, .15);
      --shadow-l: 0 8px 30px rgba(0, 0, 0, .35);
    }
  
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
  
    body {
      background: var(--bg-1);
      color: var(--txt-1);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }
  
    a {
      color: var(--ac-1);
      text-decoration: none;
      transition: all .2s ease;
    }
    a:hover {
      text-decoration: underline;
    }
  
    #background {
      position: fixed;
      inset: 0;
      z-index: -1;
    }
  
    header {
      position: sticky;
      top: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      background: rgba(30, 30, 30, .85);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-s);
      z-index: 10;
    }
  
    .logo-container {
      display: flex;
      align-items: center;
      gap: .6rem;
    }
  
    .logo-icon {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--ac-1), var(--ac-2));
      display: grid;
      place-content: center;
      color: #fff;
      font-weight: 700;
    }
  
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--ac-1), var(--ac-3));
      -webkit-background-clip: text;
      color: transparent;
    }
  
    nav {
      display: flex;
      gap: .3rem;
      flex-wrap: wrap;
    }
  
    nav button {
      background: none;
      border: none;
      color: var(--txt-2);
      padding: .55rem .95rem;
      border-radius: var(--rad-s);
      cursor: pointer;
      transition: all .2s ease;
      position: relative;
    }
    nav button:hover,
    nav button.active {
      background: rgba(140, 103, 255, .12);
      color: var(--txt-1);
    }
    #map {
      width: 100%;
      height: 500px;
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-s);
    }
  
    /* Improved cafe review styling */
    #reviewForm {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
  
    #reviewForm textarea {
      grid-column: span 2;
    }
  
    #reviewForm button {
      margin-top: 0.5rem;
    }
  
    /* Search input styling */
    .search-control input {
      background: var(--bg-3);
      color: var(--txt-1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.6rem;
      border-radius: var(--rad-s);
      width: 220px;
      box-shadow: var(--shadow-s);
      margin-bottom: 0 !important;
    }
  
    .search-control input:focus {
      outline: none;
      border-color: var(--ac-1);
    }
  
    /* Loading indicator */
    .loading-indicator span {
      background: rgba(30, 30, 30, 0.8);
      color: var(--txt-1);
      padding: 8px 12px;
      border-radius: var(--rad-s);
      font-size: 0.9rem;
      display: inline-block;
      box-shadow: var(--shadow-s);
    }
  
    /* Marker cluster styling */
    .marker-cluster {
      background-color: rgba(140, 103, 255, 0.6);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
  
    /* Leaflet popup styling */
    .leaflet-popup-content-wrapper {
      background: var(--bg-2);
      color: var(--txt-1);
      border-radius: var(--rad-m);
      padding: 0.5rem;
      box-shadow: var(--shadow-s);
    }
  
    .leaflet-popup-tip {
      background: var(--bg-2);
    }
  
    .leaflet-popup-content {
      margin: 0.5rem;
    }
  
    /* Enhanced review form */
    #cafeReviews {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
  
    .cafe-review-card {
      background: var(--bg-2);
      border-radius: var(--rad-m);
      padding: 1rem;
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }
  
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
  
    .review-body {
      margin-bottom: 0.5rem;
    }
  
    .review-footer {
      font-size: 0.8rem;
      color: var(--txt-2);
    }
    
    /* DataList enhancement */
    #reviewName {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255, 255, 255, 0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 2.5rem;
    }
    nav button.active::after {
      content: '';
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 22px;
      height: 3px;
      background: var(--ac-1);
      border-radius: 5px;
    }
  
    main {
      flex: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
  
    section {
      display: none;
      animation: fade .35s ease-in-out;
    }
    section.active {
      display: block;
    }
  
    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  
    h2.section-title {
      font-size: 1.75rem;
      margin-bottom: 1.4rem;
    }
  
    .card {
      background: var(--bg-2);
      padding: 1.25rem;
      border-radius: var(--rad-m);
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, .05);
      transition: all .3s ease;
      position: relative;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-l);
    }
  
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      border: none;
      cursor: pointer;
      padding: .7rem 1.4rem;
      font-weight: 500;
      border-radius: var(--rad-s);
      box-shadow: 0 2px 6px rgba(0, 0, 0, .2);
      transition: all .2s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, .3);
    }
  
    .btn-primary {
      background: var(--ac-1);
      color: #fff;
    }
    .btn-secondary {
      background: rgba(255, 255, 255, .1);
      color: var(--txt-1);
    }
    .btn-small {
      padding: .3rem .6rem;
      font-size: .8rem;
    }
  
    /* Inputs */
    input,
    textarea,
    select {
      background: var(--bg-3);
      border: 1px solid rgba(255, 255, 255, .1);
      color: var(--txt-1);
      padding: .75rem;
      border-radius: var(--rad-s);
      width: 100%;
      margin-bottom: 1rem;
      transition: border-color .2s ease;
    }
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--ac-1);
    }
  
    /* Quotes */
    #quotes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    #quotes .card {
      font-style: italic;
      text-align: center;
      color: var(--txt-2);
    }
  
    /* Pomodoro Timer */
    #timerDisplay {
      font-size: 2.5rem;
      text-align: center;
      margin: 1rem 0;
    }
    #timerControls {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
  
    /* Tasks Board */
    #tasksBoard {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    .column {
      background: var(--bg-2);
      flex: 1;
      min-width: 240px;
      padding: 1rem;
      border-radius: var(--rad-m);
      position: relative;
    }
    .column h3 {
      margin-bottom: .8rem;
      color: var(--txt-2);
    }
    .task {
      background: var(--bg-3);
      padding: .6rem 1rem;
      border-radius: var(--rad-s);
      margin-bottom: .6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .task-buttons button {
      margin-left: .5rem;
    }
  
    /* Map (Leaflet) */
    #map {
      width: 100%;
      height: 350px;
      border-radius: var(--rad-m);
      margin-bottom: 1rem;
    }
  
    /* Reviews */
    .delete-review {
      position: absolute;
      top: 4px;
      right: 8px;
      cursor: pointer;
      color: var(--ac-warn);
      font-weight: bold;
    }
    .delete-review:hover {
      color: var(--ac-3);
    }
  
    /* Games */
    #gameSelect {
      margin-bottom: 1rem;
    }
    #gameFrame {
      width: 100%;
      height: 80vh;
      border: none;
      border-radius: var(--rad-m);
      margin-top: 1rem;
      box-shadow: var(--shadow-s);
    }
  </style>
</head>
<body>
  <div id="background"></div>
  <header>
    <div class="logo-container"><div class="logo-icon">S</div><span class="logo">StudyBuddy</span></div>
    <nav>
      <button class="active" data-target="dashboard">Dashboard</button>
      <button data-target="cafes">Cafés</button>
      <button data-target="games">Play</button>
      <button data-target="sessions">Sessions</button>
      <button data-target="planner">Planner</button>
    </nav>
  </header>

  <main>
    <!-- Dashboard -->
    <section id="dashboard" class="active">
      <h2 class="section-title">Dashboard</h2>
      <div id="quotes"></div>
      <button id="refreshQuotes" class="btn btn-small btn-primary">Refresh Quotes</button>

      <div class="card">
        <h3>Pomodoro Timer</h3>
        <div id="timerDisplay">25:00</div>
        <div id="timerControls">
          <button id="startTimer" class="btn btn-primary">Start</button>
          <button id="pauseTimer" class="btn btn-secondary">Pause</button>
          <button id="resetTimer" class="btn btn-secondary">Reset</button>
        </div>
      </div>

      <div class="card">
        <h3>Tasks</h3>
        <form id="newTaskForm">
          <input id="newTaskInput" type="text" placeholder="New task… (Enter or click Add)" required/>
          <button type="submit" class="btn btn-primary btn-small">Add</button>
        </form>
        <div id="tasksBoard">
          <div class="column" data-status="todo"><h3>To Do</h3></div>
          <div class="column" data-status="inprogress"><h3>In Progress</h3></div>
          <div class="column" data-status="completed"><h3>Completed</h3></div>
        </div>
      </div>
    </section>

    <!-- Cafés -->
<!-- Cafés -->
<section id="cafes">
  <h2 class="section-title">Study Cafés</h2>
  <div id="map"></div>
  
  <div class="card">
    <h3>Add Café Review</h3>
    <form id="reviewForm">
      <div style="position: relative; grid-column: span 2;">
        <input id="reviewName" list="cafeList" type="text" placeholder="Choose a cafe or type a name..." required/>
        <datalist id="cafeList"></datalist>
      </div>
      <select id="reviewRating" required>
        <option value="">Select Rating...</option>
        <option value="1">★ (Poor)</option>
        <option value="2">★★ (Fair)</option>
        <option value="3">★★★ (Good)</option>
        <option value="4">★★★★ (Very Good)</option>
        <option value="5">★★★★★ (Excellent)</option>
      </select>
      <select id="reviewCategory" required>
        <option value="">Best For...</option>
        <option value="studying">Studying</option>
        <option value="reading">Reading</option>
        <option value="meetings">Meetings</option>
        <option value="relaxing">Relaxing</option>
        <option value="food">Food & Drinks</option>
      </select>
      <textarea id="reviewText" rows="3" placeholder="Share your experience... Were the tables good for studying? How was the WiFi? Was it quiet?" required></textarea>
      <button class="btn btn-primary" type="submit">Save Review</button>
    </form>
  </div>
  
  <div id="cafeReviews"></div>
</section>
    <!-- Games -->
    <section id="games">
      <h2 class="section-title">Take a Break</h2>
      <select id="gameSelect"></select>
      <iframe id="gameFrame"></iframe>
    </section>

    <!-- Sessions -->
    <section id="sessions">
      <h2 class="section-title">Study Sessions</h2>
      <div class="card">
        <h3>New Session</h3>
        <form id="sessionForm" class="grid two-col">
          <div><label>Topic</label><input id="sessionTopic" type="text" required/></div>
          <div><label>Date</label><input id="sessionDate" type="date" required/></div>
          <div><label>Duration</label><input id="sessionDuration" type="number" required/></div>
          <div style="grid-column:1/-1;"><button class="btn btn-primary" type="submit">Add</button></div>
        </form>
      </div>
      <ul id="sessionList"></ul>
    </section>

    <!-- Planner -->
    <section id="planner">
      <h2 class="section-title">Study Planner</h2>
      <div class="card">
        <h3>Add Planner Task</h3>
        <form id="plannerForm">
          <input id="planTitle" type="text" placeholder="Title…" required style="width:48%;display:inline-block;margin-right:2%;"/>
          <select id="planCat" style="width:48%;display:inline-block;" required>
            <option value="">Category…</option><option>Homework</option><option>Reading</option><option>Project</option><option>Review</option>
          </select>
          <textarea id="planDesc" rows="2" placeholder="Description…"></textarea>
          <input id="planDate" type="date" required/>
          <button class="btn btn-primary" type="submit">Add Task</button>
        </form>
      </div>
      <div id="planList"></div>
      <button id="planStudy" class="btn btn-primary">Plan My Study</button>
      <div id="plannerAdvice"></div>
    </section>
  </main>

  <!-- Chat -->
  <button id="chatToggle">💬</button>
  <div id="chatWidget">
    <div id="chatHeader">
      StudyBuddy AI
      <button id="chatClose">✕</button>
    </div>
    <div id="chatBody"></div>
    <form id="chatInput">
      <input type="text" placeholder="Ask a question…" autocomplete="off" required/>
      <button type="submit">➤</button>
    </form>
  </div>

  <!-- Celebration -->
  <div id="celebrationPopup">
    <span class="emoji">🎉</span>
    <h2>Great Job!</h2>
    <p>You've completed a task!</p>
    <button id="closeCelebration">Continue</button>
  </div>

  <script>
  /*──────────────────────  STUDYBUDDY  v1.2  ────────────────────────*
 | A single-file client script: no secrets here – the server proxies |
 | all OpenAI calls via /api/chat.  Requires Leaflet & Vanta dots    |
 *───────────────────────────────────────────────────────────────────*/

"use strict";
(function(){                /* ← wrapper added so “})();” at bottom matches */

/* ═════════════════ 0. Tiny helpers + Toasts ═══════════════════════*/
const  $ = (sel, ctx=document) => ctx.querySelector(sel),
      $$ = (sel, ctx=document) => [...ctx.querySelectorAll(sel)];

const toastRoot = document.createElement("div");
toastRoot.id = "toast-root";
toastRoot.style.cssText = `
  position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;
  gap:10px;z-index:9999;max-width:300px`;
document.head.insertAdjacentHTML("beforeend",`
<style>
@keyframes toastIn  {from{opacity:0;transform:translateX(100%)}to{opacity:1}}
@keyframes toastOut {from{opacity:1}to{opacity:0;transform:translateX(100%)}}
.toast{position:relative;padding:12px 16px;border-radius:8px;color:#fff;font-size:14px;
       box-shadow:0 4px 12px rgba(0,0,0,.25);border-left:4px solid;animation:toastIn .3s}
</style>`);

function toast(msg, type="info", ms=3000){
  const clr = {info:"#3498db",success:"#2ecc71",error:"#e74c3c",warning:"#f1c40f"}[type]||"#3498db";
  const el  = document.createElement("div");
  el.className="toast"; el.style.background=`${clr}ee`; el.style.borderColor=clr;
  el.innerHTML = `${msg}<span style="position:absolute;top:6px;right:10px;cursor:pointer;font-weight:bold">×</span>`;
  el.onclick = () => close(); toastRoot.append(el);
  const close = ()=>{el.style.animation="toastOut .3s forwards";setTimeout(()=>el.remove(),300)};
  if(ms>0) setTimeout(close, ms);
}

/* ════════════════ 1. Navigation tabs ══════════════════════════════*/
function initNav(){
  $$("nav button").forEach(btn=>{
    btn.addEventListener("click",()=>{
      $("nav button.active")?.classList.remove("active");
      btn.classList.add("active");
      $("section.active")?.classList.remove("active");
      $("#"+btn.dataset.target).classList.add("active");
    });
  });
}

/* ════════════════ 2. Quotes ═══════════════════════════════════════*/
function initQuotes(){
  const quotes = [
    "Start where you are.","Progress over perfection.","One step at a time.",
    "Dream, believe, do.","Focus and win.","Every day is a second chance.",
    "Small progress is progress.","Stay positive.","Believe you can.",
    "Do it now.","Keep pushing.","Consistency is key.","Success is a journey.",
    "You got this.","Make today count."
  ];
  const render = ()=>{
    const box=$("#quotes"); box.innerHTML="";
    quotes.sort(()=>0.5-Math.random()).slice(0,3).forEach(q=>{
      const card=document.createElement("div");
      card.className="card"; card.textContent=`"${q}"`; box.append(card);
    });
  };
  $("#refreshQuotes").onclick=render; render();
}

/* ════════════════ 3. Pomodoro ═════════════════════════════════════*/
function initPomodoro(){
  let secs=25*60, running=false, iv;
  const disp=$("#timerDisplay");
  const fmt=()=>disp.textContent=`${String(Math.floor(secs/60)).padStart(2,"0")}:${String(secs%60).padStart(2,"0")}`;
  fmt();
  $("#startTimer").onclick=()=>{
    if(running) return; running=true;
    iv=setInterval(()=>{ if(--secs<=0){clearInterval(iv);running=false;
      confetti({particleCount:120,spread:70,origin:{y:.6}});
      toast("Pomodoro finished! Break time 🎉","success");
      secs=25*60; fmt(); } else fmt();},1000);}
  $("#pauseTimer").onclick=()=>{clearInterval(iv);running=false;};
  $("#resetTimer").onclick=()=>{clearInterval(iv);running=false;secs=25*60;fmt();}
}

/* ════════════════ 4. Tasks board ══════════════════════════════════*/
function initTasks(){
  const lsKey="sb-tasks";
  const empty ={todo:[],inprogress:[],completed:[]};
  const get =()=>{try{return JSON.parse(localStorage.getItem(lsKey))||empty}catch{ return empty}};
  const set =obj=>localStorage.setItem(lsKey,JSON.stringify(obj));
  const render = ()=>{
    const data=get();
    ["todo","inprogress","completed"].forEach(st=>{
      const col=$(`.column[data-status="${st}"]`);
      const title=col.querySelector("h3").textContent; col.innerHTML=`<h3>${title}</h3>`;
      data[st].forEach((t,i)=>{
        col.insertAdjacentHTML("beforeend",`
          <div class="task">
            <span>${t}</span>
            <div class="task-buttons">
              ${st==="todo"?`<button data-act="start" data-i="${i}" class="btn btn-small btn-primary">Start</button>`:""}
              ${st==="inprogress"?`<button data-act="complete" data-i="${i}" class="btn btn-small btn-primary">Complete</button>`:""}
              <button data-act="del" data-st="${st}" data-i="${i}" class="btn btn-small btn-secondary">×</button>
            </div>
          </div>`);});
    });
  };
  $("#newTaskForm").addEventListener("submit",e=>{
    e.preventDefault(); const v=$("#newTaskInput").value.trim(); if(!v) return;
    const d=get(); d.todo.push(v); set(d); render(); e.target.reset();});
  $("#tasksBoard").addEventListener("click",e=>{
    const b=e.target.closest("button[data-act]"); if(!b) return;
    const d=get(); const st=b.dataset.st, i=+b.dataset.i;
    if(b.dataset.act==="del"){d[st].splice(i,1);}
    if(b.dataset.act==="start"){d.inprogress.push(d.todo.splice(i,1)[0]);}
    if(b.dataset.act==="complete"){d.completed.push(d.inprogress.splice(i,1)[0]);
      confetti({particleCount:100,spread:70,origin:{y:.6}});
      toast("Task completed!","success");}
    set(d); render();});
  render();
}

/* ════════════════ 5. Café map (original version) ══════════════════*/
function initCafe(){
  let map, userMarker, searchCircle, markers=[];
  const allCafes=[];           // pushes used by review form datalist
  const cafeList=$("#cafeList");
  const radiusSel=2000;        // initial 2 km

  const loadLeaflet = ()=> new Promise(res=>{
    if(window.L){res();return;}
    // css is already in <head> from HTML
    const s=document.createElement("script");
    s.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
    s.onload=res; document.head.append(s);
  });

  const buildMap = async ()=>{
    await loadLeaflet();
    const mapEl=$("#map"); mapEl.innerHTML="";
    const [lat,lng]=await getUserLoc();
    map=L.map(mapEl).setView([lat,lng],14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
    userMarker=L.marker([lat,lng]).addTo(map).bindPopup("You are here").openPopup();
    searchCircle=L.circle([lat,lng],{radius:radiusSel,color:"#8c67ff",fillOpacity:.05}).addTo(map);
    fetchCafes(lat,lng,radiusSel);
  };

  const getUserLoc = ()=> new Promise(res=>{
    navigator.geolocation?.getCurrentPosition(
      p=>res([p.coords.latitude,p.coords.longitude]),
      ()=>res([25.276987,55.296249]),{timeout:5000});
  });

  const fetchCafes = (lat,lng,rad)=>{
    clearMarkers();
    toast(`Searching cafés within ${(rad/1000).toFixed(1)} km…`,"info",1500);
    const q=`
      [out:json][timeout:15];
      ( node["amenity"="cafe"](around:${rad},${lat},${lng});
        node["shop"="coffee"](around:${rad},${lat},${lng});
        node["amenity"="library"](around:${rad},${lat},${lng});
      ); out body;`;
    fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:"data="+encodeURIComponent(q)})
    .then(r=>r.json()).then(j=>{
      j.elements.forEach(n=>{
        const name=n.tags.name||"Unnamed Café";
        allCafes.push({name});
        const m=L.marker([n.lat,n.lon]).addTo(map);
        m.bindPopup(`<b>${name}</b><br><button
           onclick="selectCafeForReview('${name.replace(/'/g,"\\'")}')">
           Add review</button>`);
        markers.push(m);
      });
      updateCafeDatalist();
      toast(`Found ${j.elements.length} places`,"success");
    }).catch(()=>toast("Could not load café data","error"));
  };

  function clearMarkers(){markers.forEach(m=>m.remove());markers=[];}

  function updateCafeDatalist(){
    cafeList.innerHTML=""; [...new Set(allCafes.map(c=>c.name))].sort().forEach(n=>{
      cafeList.insertAdjacentHTML("beforeend",`<option value="${n}">`);
    });
  }

  buildMap();
  // expose for review form convenience
  window.selectCafeForReview = name => { $("#reviewName").value=name; $("#reviewForm").scrollIntoView({behavior:"smooth"}); };
}

/* ════════════════ 6. Reviews (CRUD with delete-fix) ═══════════════*/
function initReviews(){
  const key="sb-reviews";
  const get=()=>{try{return JSON.parse(localStorage.getItem(key))||[]}catch{return[]}};
  const set=a=>localStorage.setItem(key,JSON.stringify(a));
  const list=$("#cafeReviews");

  $("#reviewForm").addEventListener("submit",e=>{
    e.preventDefault();
    const name=$("#reviewName").value.trim(),
          rating=+$("#reviewRating").value,
          cat=$("#reviewCategory").value,
          text=$("#reviewText").value.trim();
    if(!name||!rating||!cat||!text){toast("Fill all review fields","error");return;}
    const revs=get(); revs.push({name,rating,category:cat,text,date:new Date().toISOString()}); set(revs);
    toast("Review saved","success"); e.target.reset(); render();
  });

  const render = ()=>{
    const revs=get(); list.innerHTML="";
    if(!revs.length){list.innerHTML='<div class="card" style="text-align:center;padding:2rem;">No reviews yet.</div>'; return;}
    revs.forEach((r,i)=>{
      const stars="★".repeat(r.rating)+"☆".repeat(5-r.rating);
      list.insertAdjacentHTML("beforeend",`
        <div class="card cafe-review-card" style="position:relative">
          <div class="delete-review" data-i="${i}" style="position:absolute;top:6px;right:10px;cursor:pointer;font-size:18px;color:var(--ac-warn)">×</div>
          <h3 style="margin-top:0">${r.name}</h3>
          <div style="color:var(--ac-warn);margin-bottom:4px">${stars}</div>
          <div style="font-size:13px;color:var(--txt-2);margin-bottom:6px">${r.category}</div>
          <p style="margin:0 0 6px">${r.text}</p>
          <small style="color:var(--txt-2)">${r.date?.split("T")[0]||""}</small>
        </div>`);});
  };
  list.addEventListener("click",e=>{
    const del=e.target.closest(".delete-review"); if(!del) return;
    const i=+del.dataset.i; const revs=get(); revs.splice(i,1); set(revs); render(); toast("Review deleted","info");
  });
  render();
}

/* ════════════════ 7. Games list ═══════════════════════════════════*/
function initGames(){
  const arr=[
    ["Wordle Clone","https://wordlegame.org/"],
    ["Hangman","https://hangmanwordgame.com/"],
    ["Flappy Bird","https://flappybird.io/"],
    ["Minesweeper","https://kamoroso94.github.io/minesweeper/"],
    ["Sudoku","https://sudoku.com/"],
    ["Connect Four","https://torikul007.github.io/Connect_Four/"]
  ];
  const sel=$("#gameSelect"); sel.innerHTML="";
  arr.forEach(([n,u])=>sel.insertAdjacentHTML("beforeend",`<option value="${u}">${n}</option>`));
  sel.onchange=()=>$("#gameFrame").src=sel.value;
  sel.selectedIndex=0; sel.dispatchEvent(new Event("change"));
}

/* ════════════════ 8. Study sessions ═══════════════════════════════*/
function initSessions(){
  const key="sb-sessions";
  const get=()=>{try{return JSON.parse(localStorage.getItem(key))||[]}catch{return[]}};
  const set=a=>localStorage.setItem(key,JSON.stringify(a));
  const list=$("#sessionList");

  $("#sessionForm").addEventListener("submit",e=>{
    e.preventDefault();
    const t=$("#sessionTopic").value.trim(),
          d=$("#sessionDate").value,
          dur=+$("#sessionDuration").value;
    if(!t||!d||!dur){toast("Fill all session fields","error");return;}
    const s=get();s.push({topic:t,date:d,duration:dur});set(s);e.target.reset();render();toast("Session added","success");
  });
  const render=()=>{
    const s=get(); list.innerHTML="";
    if(!s.length){list.innerHTML='<li class="card">No sessions yet.</li>';return;}
    s.sort((a,b)=>new Date(b.date)-new Date(a.date));
    s.forEach((ss,i)=>{
      list.insertAdjacentHTML("beforeend",`
        <li class="card" style="margin-bottom:.6rem">
          <strong>${ss.topic}</strong> ${ss.date} — ${ss.duration} min
          <button class="btn btn-small btn-secondary" data-i="${i}" style="float:right">Delete</button>
        </li>`);});
  };
  list.addEventListener("click",e=>{
    const b=e.target.closest("button[data-i]"); if(!b) return;
    const s=get(); s.splice(+b.dataset.i,1); set(s); render(); toast("Session deleted","info");
  });
  render();
}

/* ════════════════ 9. Planner – GPT powered ════════════════════════*/
function initPlanner(){
  const key="sb-plans";
  const get=()=>{try{return JSON.parse(localStorage.getItem(key))||[]}catch{return[]}};
  const set=a=>localStorage.setItem(key,JSON.stringify(a));
  const list=$("#planList");

  $("#plannerForm").addEventListener("submit",e=>{
    e.preventDefault();
    const t=$("#planTitle").value.trim(),
          cat=$("#planCat").value,
          desc=$("#planDesc").value.trim(),
          date=$("#planDate").value;
    if(!t||!cat||!date){toast("Fill all required fields","error");return;}
    const p=get(); p.push({title:t,category:cat,desc,date}); set(p); e.target.reset(); render(); toast("Plan added","success");
  });

  const render=()=>{
    const p=get(); list.innerHTML="";
    if(!p.length){list.innerHTML='<div class="card" style="text-align:center;padding:1.5rem">No study plans yet.</div>';return;}
    p.sort((a,b)=>new Date(a.date)-new Date(b.date));
    p.forEach((pl,i)=>{
      list.insertAdjacentHTML("beforeend",`
        <div class="card" style="position:relative">
          <button class="delete-plan" data-i="${i}" style="position:absolute;top:8px;right:10px;
                  background:none;border:none;font-size:18px;color:var(--ac-warn);cursor:pointer">×</button>
          <h4 style="margin-top:0">${pl.title}</h4>
          <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px">
            <span>${pl.category}</span><span>${pl.date}</span>
          </div>
          <p style="margin:0">${pl.desc}</p>
        </div>`);});
  };
  list.addEventListener("click",e=>{
    const b=e.target.closest(".delete-plan"); if(!b) return;
    const p=get(); p.splice(+b.dataset.i,1); set(p); render(); toast("Plan deleted","info");
  });
  render();

  /* GPT generation */
  $("#planStudy").addEventListener("click",async()=>{
    const tasks=get();
    const adv=$("#plannerAdvice");
    if(!tasks.length){adv.textContent="Add tasks first 😊";return;}
    adv.innerHTML='<div style="text-align:center;padding:20px"><div class="loading-spinner"></div> Generating study plan with AI…</div>';
    const prompt=`I have these upcoming study tasks:\n${tasks.map(t=>`• ${t.title} (${t.category}) due ${t.date}${t.desc?": "+t.desc:""}`).join("\n")}\n\nGenerate a detailed study schedule starting today. Use clear headings like "Today", "Tomorrow", etc.; include technique suggestions for each task and end with 5 general study tips.`;
    try{
      const r=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:prompt})});
      const {reply}=await r.json();
      if(!reply) throw"empty";
      showPlan(reply);
    }catch(err){
      adv.textContent="Sorry, AI is unavailable at the moment.";
      console.error(err);
    }
    function showPlan(md){
      const plain=md.replace(/```[\s\S]*?```/g,"");            // remove code blocks for txt
      /* markdown→basic html (headings & bullets only) */
      const html=plain.split("\n").map(l=>{
        if(/^#{1,6}\s/.test(l)){const lv=l.match(/^#+/)[0].length;return`<h${lv}>${l.slice(lv+1)}</h${lv}>`;}
        if(/^-\s/.test(l)) return `<li>${l.slice(2)}</li>`;
        return `<p>${l}</p>`;}).join("");
      const box=document.createElement("div");
      box.style.cssText="max-height:500px;overflow:auto;padding:20px;background:var(--bg-2);border-radius:var(--rad-m)";
      box.innerHTML=html.replace(/<li>/g,"<li style='margin-left:18px'>");
      const dl=document.createElement("button");
      dl.textContent="📥 Download Study Plan"; dl.className="btn btn-primary"; dl.style.display="block";
      dl.onclick=()=>{
        const blob=new Blob([plain],{type:"text/plain"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a"); a.href=url; a.download="StudyBuddy_Plan.txt";
        document.body.append(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        toast("Study plan downloaded","success");
      };
      box.append(dl); adv.innerHTML=""; adv.append(box);
    }
  });
}

/* ════════════════10. Chat widget (uses /api/chat) ═════════════════*/
function initChat(){
  const toggle=$("#chatToggle"), w=$("#chatWidget"), close=$("#chatClose"), body=$("#chatBody"), form=$("#chatInput");
  toggle.onclick=()=>w.classList.toggle("open"); close.onclick=()=>w.classList.remove("open");
  form.addEventListener("submit",async e=>{
    e.preventDefault();
    const inp=form.querySelector("input"); const txt=inp.value.trim(); if(!txt) return;
    addMsg("me",txt); inp.value="";
    const wait=addMsg("bot","…");
    try{
      const r=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:txt})});
      const {reply}=await r.json(); wait.textContent=reply||"(no response)";
    }catch{wait.textContent="Sorry, can't connect right now.";}
  });
  function addMsg(type,t){const row=document.createElement("div");row.className=`row ${type}`;
    row.innerHTML=`<p>${t}</p>`; body.append(row); body.scrollTop=body.scrollHeight; return row.querySelector("p");}
}

/* ════════════════11. Global stuff & init ══════════════════════════*/
document.addEventListener("DOMContentLoaded",()=>{
  document.body.append(toastRoot);
  initNav();   initQuotes(); initPomodoro(); initTasks();
  initCafe();  initReviews(); initGames();   initSessions();
  initPlanner(); initChat();

  /* background dots (Vanta) */
  if(window.VANTA?.DOTS) VANTA.DOTS({el:"#background",color:0x8c67ff,color2:0x4f46e5,
    backgroundColor:0x121212,size:3,spacing:25,showLines:false});

  /* keyboard shortcuts */
  document.addEventListener("keydown",e=>{
    if(e.altKey){ if(/^[1-5]$/.test(e.key)) $$("nav button")[e.key-1]?.click();
      if(e.key==="t") $("#startTimer")?.click();}
  });
});

/* ════════════════ confetti (tiny fallback) ════════════════════════*/
function confetti(opts={}){try{window.confetti(opts);}catch{}}

})();                /* ← end IIFE wrapper */
  </script>
  
</body>
</html>
