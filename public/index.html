<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StudyBuddy</title>

  <!-- Original Google API loader -->
  <script src="https://apis.google.com/js/api.js" defer></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Three.js & Vanta.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.dots.min.js" defer></script>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js" defer></script>

  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  defer
></script>

  <style>
    /* Enhanced CSS Styling for StudyBuddy */
/* Add these styles to the existing CSS */

/* Improved map styling */
#map {
  width: 100%;
  height: 500px;
  border-radius: var(--rad-m);
  margin-bottom: 1.5rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: var(--shadow-s);
  position: relative;
  z-index: 1;
}

/* Custom Leaflet styling */
.leaflet-container {
  background: #1e1e1e;
  font-family: 'Inter', sans-serif;
}

.leaflet-popup-content-wrapper {
  background: var(--bg-2);
  color: var(--txt-1);
  border-radius: var(--rad-m);
  padding: 0;
  box-shadow: var(--shadow-s);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.leaflet-popup-tip {
  background: var(--bg-2);
  box-shadow: var(--shadow-s);
}

.leaflet-popup-content {
  margin: 8px;
  width: auto !important;
}

.leaflet-control {
  margin: 10px !important;
}

.leaflet-bar a {
  background: var(--bg-2);
  color: var(--txt-1);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.leaflet-bar a:hover {
  background: var(--bg-3);
  color: var(--ac-1);
}

.leaflet-control-attribution {
  background: rgba(30, 30, 30, 0.7) !important;
  color: var(--txt-2) !important;
  backdrop-filter: blur(5px);
  padding: 3px 8px;
  border-radius: 4px;
}

.leaflet-control-attribution a {
  color: var(--ac-1) !important;
}

/* Enhanced study planner styling */
#plannerAdvice h3 {
  margin-top: 20px;
  margin-bottom: 10px;
  color: var(--ac-1);
  border-bottom: 1px solid var(--ac-1);
  padding-bottom: 5px;
}

#plannerAdvice div {
  line-height: 1.5;
}

#plannerAdvice strong {
  color: var(--ac-1);
}

/* Download button for study plan */
#downloadPlan {
  margin: 15px auto;
  display: block;
}

/* Enhanced forms */
#reviewForm, #plannerForm {
  background: var(--bg-3);
  padding: 15px;
  border-radius: var(--rad-m);
  margin-bottom: 20px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

#reviewForm input, #reviewForm select, #reviewForm textarea,
#plannerForm input, #plannerForm select, #plannerForm textarea {
  background: var(--bg-2);
  transition: all 0.2s ease;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

#reviewForm input:focus, #reviewForm select:focus, #reviewForm textarea:focus,
#plannerForm input:focus, #plannerForm select:focus, #plannerForm textarea:focus {
  border-color: var(--ac-1);
  box-shadow: 0 0 0 2px rgba(140, 103, 255, 0.2);
}

/* Better form layout for reviews */
#reviewForm {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

#reviewForm div:first-child {
  grid-column: span 2;
}

#reviewForm textarea {
  grid-column: span 2;
}

#reviewForm button {
  grid-column: span 2;
  margin-top: 0.5rem;
}

/* Enhanced cafe review cards */
.cafe-review-card {
  background: var(--bg-2);
  border-radius: var(--rad-m);
  padding: 1.25rem;
  box-shadow: var(--shadow-s);
  border: 1px solid rgba(255, 255, 255, 0.05);
  transition: all 0.3s ease;
  position: relative;
}

.cafe-review-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-l);
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.review-body {
  margin-bottom: 0.5rem;
  line-height: 1.5;
}

.review-rating {
  color: var(--ac-warn);
  font-size: 1.1rem;
}

.review-footer {
  font-size: 0.8rem;
  color: var(--txt-2);
  display: flex;
  justify-content: space-between;
  margin-top: 0.8rem;
  padding-top: 0.5rem;
  border-top: 1px solid rgba(255, 255, 255, 0.05);
}

/* Better styling for the review name input with datalist */
#reviewName {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255, 255, 255, 0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: 10px center;
  padding-left: 2.5rem;
}

/* Add smooth animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in {
  animation: fadeIn 0.4s ease forwards;
}

/* Add some visual flare to the study planner */
#planList .card {
  position: relative;
  overflow: hidden;
}

#planList .card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--ac-1), var(--ac-3));
  border-radius: var(--rad-s) 0 0 var(--rad-s);
}

#planList .card h4 {
  margin-left: 8px;
}

/* Enhanced planner button */
#planStudy {
  background: linear-gradient(135deg, var(--ac-1), var(--ac-2));
  padding: 0.8rem 1.6rem;
  font-weight: 600;
  letter-spacing: 0.5px;
  transition: all 0.3s ease;
  margin-bottom: 1rem;
}

#planStudy:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(140, 103, 255, 0.3);
}

/* Make loading indicators consistent */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(140, 103, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--ac-1);
  animation: spin 1s linear infinite;
  margin-right: 8px;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Add responsive improvements */
@media (max-width: 768px) {
  header {
    padding: 0.8rem 1rem;
  }
  
  .logo {
    font-size: 1.2rem;
  }
  
  main {
    padding: 1rem;
  }
  
  nav button {
    padding: 0.4rem 0.7rem;
    font-size: 0.9rem;
  }
  
  #map {
    height: 350px;
  }
  
  #reviewForm {
    display: block;
  }
  
  #timerDisplay {
    font-size: 2rem;
  }
  
  #tasksBoard {
    flex-direction: column;
  }
  
  .column {
    margin-bottom: 1rem;
  }
  
  #quotes {
    grid-template-columns: 1fr;
  }
}

/* Improve dark mode legibility */
::placeholder {
  color: rgba(176, 176, 176, 0.6);
}

select option {
  background-color: var(--bg-3);
}

/* Touch-specific enhancements */
.touch-device .task {
  position: relative;
}

.touch-device .task-buttons {
  position: absolute;
  right: 10px;
  display: flex;
  gap: 5px;
}

/* Focus styles for accessibility */
button:focus, input:focus, select:focus, textarea:focus {
  outline: 2px solid var(--ac-1);
  outline-offset: 2px;
}

/* Dark scrollbars for better aesthetics */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-1);
}

::-webkit-scrollbar-thumb {
  background: var(--bg-3);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--ac-1);
}

    :root {
      --bg-1:#121212; --bg-2:#1e1e1e; --bg-3:#2d2d2d;
      --txt-1:#fafafa; --txt-2:#b0b0b0;
      --ac-1:#8c67ff; --ac-2:#4f46e5; --ac-3:#ff6f91; --ac-warn:#f2c94c;
      --rad-s:6px; --rad-m:12px; --rad-l:20px;
      --shadow-s:0 4px 20px rgba(0,0,0,.15);
      --shadow-l:0 8px 30px rgba(0,0,0,.35);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
    body{background:var(--bg-1);color:var(--txt-1);min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;}
    a{color:var(--ac-1);text-decoration:none;transition:all .2s ease;}a:hover{text-decoration:underline;}
    #background{position:fixed;inset:0;z-index:-1;}
    header{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;padding:1rem 2rem;background:rgba(30,30,30,.85);backdrop-filter:blur(10px);box-shadow:var(--shadow-s);z-index:10;}
    .logo-container{display:flex;align-items:center;gap:.6rem;}
    .logo-icon{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--ac-1),var(--ac-2));display:grid;place-content:center;color:#fff;font-weight:700;}
    .logo{font-size:1.5rem;font-weight:700;background:linear-gradient(90deg,var(--ac-1),var(--ac-3));-webkit-background-clip:text;color:transparent;}
    nav{display:flex;gap:.3rem;flex-wrap:wrap;}
    nav button{background:none;border:none;color:var(--txt-2);padding:.55rem .95rem;border-radius:var(--rad-s);cursor:pointer;transition:all .2s ease;position:relative;}
    nav button:hover, nav button.active{background:rgba(140,103,255,.12);color:var(--txt-1);}
    nav button.active::after{content:'';position:absolute;left:50%;bottom:0;transform:translateX(-50%);width:22px;height:3px;background:var(--ac-1);border-radius:5px;}
    main{flex:1;max-width:1400px;margin:0 auto;padding:2rem;}
    section{display:none;animation:fade .35s ease-in-out;}section.active{display:block;}
    @keyframes fade{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
    h2.section-title{font-size:1.75rem;margin-bottom:1.4rem;}
    .card{background:var(--bg-2);padding:1.25rem;border-radius:var(--rad-m);box-shadow:var(--shadow-s);border:1px solid rgba(255,255,255,.05);transition:all .3s ease;position:relative;}
    .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-l);}
    .btn{display:inline-flex;align-items:center;gap:.45rem;border:none;cursor:pointer;padding:.7rem 1.4rem;font-weight:500;border-radius:var(--rad-s);box-shadow:0 2px 6px rgba(0,0,0,.2);transition:all .2s ease;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.3);}
    .btn-primary{background:var(--ac-1);color:#fff;} .btn-secondary{background:rgba(255,255,255,.1);color:var(--txt-1);} .btn-small{padding:.3rem .6rem;font-size:.8rem;}
    input,textarea,select{background:var(--bg-3);border:1px solid rgba(255,255,255,.1);color:var(--txt-1);padding:.75rem;border-radius:var(--rad-s);width:100%;margin-bottom:1rem;transition:border-color .2s ease;}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--ac-1);}
    /* Quotes */
    #quotes{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem;}
    #quotes .card{font-style:italic;text-align:center;color:var(--txt-2);}
    /* Pomodoro */
    #timerDisplay{font-size:2.5rem;text-align:center;margin:1rem 0;}
    #timerControls{display:flex;justify-content:center;gap:1rem;}
    /* Tasks */
    #tasksBoard{display:flex;gap:1rem;margin-top:1rem;}
    .column{background:var(--bg-2);flex:1;min-width:240px;padding:1rem;border-radius:var(--rad-m);position:relative;}
    .column h3{margin-bottom:.8rem;color:var(--txt-2);}
    .task{background:var(--bg-3);padding:.6rem 1rem;border-radius:var(--rad-s);margin-bottom:.6rem;display:flex;align-items:center;justify-content:space-between;}
    .task-buttons button{margin-left:.5rem;}
    /* Map */
    #map{width:100%;height:350px;border-radius:var(--rad-m);margin-bottom:1rem;}
    /* Reviews */
    .delete-review{position:absolute;top:4px;right:8px;cursor:pointer;color:var(--ac-warn);font-weight:bold;}
    .delete-review:hover{color:var(--ac-3);}
    /* Games */
    #gameSelect{margin-bottom:1rem;}
    /* Make iframe much bigger */
    #gameFrame{width:100%;height:80vh;border:none;border-radius:var(--rad-m);margin-top:1rem;box-shadow:var(--shadow-s);}
    /* Planner */
    #planList .card{margin-bottom:1rem;padding-right:2.5rem;}
    #plannerAdvice{margin-top:1rem;background:var(--bg-3);padding:1rem;border-radius:var(--rad-s);max-height:300px;overflow-y:auto;white-space:pre-wrap;line-height:1.5;}
    .delete-plan{position:absolute;top:10px;right:10px;cursor:pointer;color:var(--ac-warn);font-weight:bold;font-size:1.2rem;}
    .delete-plan:hover{color:var(--ac-3);}
    /* Chat */
    #chatToggle{position:fixed;bottom:1rem;right:1rem;width:56px;height:56px;border-radius:50%;background:var(--ac-1);color:#fff;font-size:1.5rem;border:none;cursor:pointer;box-shadow:var(--shadow-l);z-index:20;transition:transform 0.3s ease,box-shadow 0.3s ease;}
    #chatToggle:hover{transform:scale(1.1);box-shadow:0 10px 40px rgba(140,103,255,.4);}
    #chatWidget{position:fixed;bottom:1.5rem;right:1.5rem;width:340px;height:400px;background:var(--bg-2);border-radius:var(--rad-l);box-shadow:var(--shadow-l);display:flex;flex-direction:column;overflow:hidden;z-index:20;opacity:0;transform:translateY(20px) scale(0.8);pointer-events:none;transition:opacity .3s ease,transform .3s ease;}
    #chatWidget.open{opacity:1;transform:translateY(0) scale(1);pointer-events:all;}
    #chatHeader{background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;border-top-left-radius:var(--rad-l);border-top-right-radius:var(--rad-l);}
    #chatClose{background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;transition:transform .2s ease;}
    #chatClose:hover{transform:rotate(90deg);}
    #chatBody{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.7rem;scroll-behavior:smooth;background:rgba(18,18,18,.3);}
    .row{display:flex;}
    .row.me{justify-content:flex-end;}
    .row p{padding:.75rem 1rem;border-radius:18px;max-width:80%;font-size:.88rem;line-height:1.5;}
    .me p{background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;border-bottom-right-radius:6px;}
    .bot p{background:var(--bg-3);color:var(--txt-1);border-bottom-left-radius:6px;}
    #chatInput{display:flex;border-top:1px solid rgba(255,255,255,.06);}
    #chatInput input{flex:1;border:none;background:var(--bg-3);color:var(--txt-1);padding:.75rem 1rem;border-radius:var(--rad-s);margin:.5rem;outline:none;}
    #chatInput button{width:42px;height:42px;margin:.5rem;border-radius:50%;background:var(--ac-1);border:none;color:#fff;transition:all .2s ease;cursor:pointer;}
    #chatInput button:hover{transform:scale(1.1);background:var(--ac-2);}
    /* Celebration */
    #celebrationPopup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;padding:2rem;border-radius:var(--rad-l);text-align:center;z-index:100;box-shadow:var(--shadow-l);animation:popIn .5s cubic-bezier(.175,.885,.32,1.275) forwards;}
    #celebrationPopup .emoji{font-size:4rem;margin-bottom:1rem;display:block;}
    #celebrationPopup h2{font-size:2rem;margin-bottom:1rem;}
    #celebrationPopup button{margin-top:1rem;background:rgba(255,255,255,.2);border:none;color:#fff;padding:.5rem 1.5rem;border-radius:var(--rad-s);cursor:pointer;transition:all .2s ease;}
    #celebrationPopup button:hover{background:rgba(255,255,255,.3);}
    @keyframes popIn{0%{transform:translate(-50%,-50%) scale(.8);opacity:0;}100%{transform:translate(-50%,-50%) scale(1);opacity:1;}}
    :root {
      --bg-1: #121212;
      --bg-2: #1e1e1e;
      --bg-3: #2d2d2d;
      --txt-1: #fafafa;
      --txt-2: #b0b0b0;
      --ac-1: #8c67ff;
      --ac-2: #4f46e5;
      --ac-3: #ff6f91;
      --ac-warn: #f2c94c;
      --rad-s: 6px;
      --rad-m: 12px;
      --rad-l: 20px;
      --shadow-s: 0 4px 20px rgba(0, 0, 0, .15);
      --shadow-l: 0 8px 30px rgba(0, 0, 0, .35);
    }
  
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
  
    body {
      background: var(--bg-1);
      color: var(--txt-1);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }
  
    a {
      color: var(--ac-1);
      text-decoration: none;
      transition: all .2s ease;
    }
    a:hover {
      text-decoration: underline;
    }
  
    #background {
      position: fixed;
      inset: 0;
      z-index: -1;
    }
  
    header {
      position: sticky;
      top: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      background: rgba(30, 30, 30, .85);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-s);
      z-index: 10;
    }
  
    .logo-container {
      display: flex;
      align-items: center;
      gap: .6rem;
    }
  
    .logo-icon {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--ac-1), var(--ac-2));
      display: grid;
      place-content: center;
      color: #fff;
      font-weight: 700;
    }
  
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--ac-1), var(--ac-3));
      -webkit-background-clip: text;
      color: transparent;
    }
  
    nav {
      display: flex;
      gap: .3rem;
      flex-wrap: wrap;
    }
  
    nav button {
      background: none;
      border: none;
      color: var(--txt-2);
      padding: .55rem .95rem;
      border-radius: var(--rad-s);
      cursor: pointer;
      transition: all .2s ease;
      position: relative;
    }
    nav button:hover,
    nav button.active {
      background: rgba(140, 103, 255, .12);
      color: var(--txt-1);
    }
    #map {
      width: 100%;
      height: 500px;
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-s);
    }
  
    /* Improved cafe review styling */
    #reviewForm {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
  
    #reviewForm textarea {
      grid-column: span 2;
    }
  
    #reviewForm button {
      margin-top: 0.5rem;
    }
  
    /* Search input styling */
    .search-control input {
      background: var(--bg-3);
      color: var(--txt-1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.6rem;
      border-radius: var(--rad-s);
      width: 220px;
      box-shadow: var(--shadow-s);
      margin-bottom: 0 !important;
    }
  
    .search-control input:focus {
      outline: none;
      border-color: var(--ac-1);
    }
  
    /* Loading indicator */
    .loading-indicator span {
      background: rgba(30, 30, 30, 0.8);
      color: var(--txt-1);
      padding: 8px 12px;
      border-radius: var(--rad-s);
      font-size: 0.9rem;
      display: inline-block;
      box-shadow: var(--shadow-s);
    }
  
    /* Marker cluster styling */
    .marker-cluster {
      background-color: rgba(140, 103, 255, 0.6);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
  
    /* Leaflet popup styling */
    .leaflet-popup-content-wrapper {
      background: var(--bg-2);
      color: var(--txt-1);
      border-radius: var(--rad-m);
      padding: 0.5rem;
      box-shadow: var(--shadow-s);
    }
  
    .leaflet-popup-tip {
      background: var(--bg-2);
    }
  
    .leaflet-popup-content {
      margin: 0.5rem;
    }
  
    /* Enhanced review form */
    #cafeReviews {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
  
    .cafe-review-card {
      background: var(--bg-2);
      border-radius: var(--rad-m);
      padding: 1rem;
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }
  
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
  
    .review-body {
      margin-bottom: 0.5rem;
    }
  
    .review-footer {
      font-size: 0.8rem;
      color: var(--txt-2);
    }
    
    /* DataList enhancement */
    #reviewName {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255, 255, 255, 0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 2.5rem;
    }
    nav button.active::after {
      content: '';
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 22px;
      height: 3px;
      background: var(--ac-1);
      border-radius: 5px;
    }
  
    main {
      flex: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
  
    section {
      display: none;
      animation: fade .35s ease-in-out;
    }
    section.active {
      display: block;
    }
  
    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  
    h2.section-title {
      font-size: 1.75rem;
      margin-bottom: 1.4rem;
    }
  
    .card {
      background: var(--bg-2);
      padding: 1.25rem;
      border-radius: var(--rad-m);
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, .05);
      transition: all .3s ease;
      position: relative;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-l);
    }
  
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      border: none;
      cursor: pointer;
      padding: .7rem 1.4rem;
      font-weight: 500;
      border-radius: var(--rad-s);
      box-shadow: 0 2px 6px rgba(0, 0, 0, .2);
      transition: all .2s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, .3);
    }
  
    .btn-primary {
      background: var(--ac-1);
      color: #fff;
    }
    .btn-secondary {
      background: rgba(255, 255, 255, .1);
      color: var(--txt-1);
    }
    .btn-small {
      padding: .3rem .6rem;
      font-size: .8rem;
    }
  
    /* Inputs */
    input,
    textarea,
    select {
      background: var(--bg-3);
      border: 1px solid rgba(255, 255, 255, .1);
      color: var(--txt-1);
      padding: .75rem;
      border-radius: var(--rad-s);
      width: 100%;
      margin-bottom: 1rem;
      transition: border-color .2s ease;
    }
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--ac-1);
    }
  
    /* Quotes */
    #quotes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    #quotes .card {
      font-style: italic;
      text-align: center;
      color: var(--txt-2);
    }
  
    /* Pomodoro Timer */
    #timerDisplay {
      font-size: 2.5rem;
      text-align: center;
      margin: 1rem 0;
    }
    #timerControls {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
  
    /* Tasks Board */
    #tasksBoard {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    .column {
      background: var(--bg-2);
      flex: 1;
      min-width: 240px;
      padding: 1rem;
      border-radius: var(--rad-m);
      position: relative;
    }
    .column h3 {
      margin-bottom: .8rem;
      color: var(--txt-2);
    }
    .task {
      background: var(--bg-3);
      padding: .6rem 1rem;
      border-radius: var(--rad-s);
      margin-bottom: .6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .task-buttons button {
      margin-left: .5rem;
    }
  
    /* Map (Leaflet) */
    #map {
      width: 100%;
      height: 350px;
      border-radius: var(--rad-m);
      margin-bottom: 1rem;
    }
  
    /* Reviews */
    .delete-review {
      position: absolute;
      top: 4px;
      right: 8px;
      cursor: pointer;
      color: var(--ac-warn);
      font-weight: bold;
    }
    .delete-review:hover {
      color: var(--ac-3);
    }
  
    /* Games */
    #gameSelect {
      margin-bottom: 1rem;
    }
    #gameFrame {
      width: 100%;
      height: 80vh;
      border: none;
      border-radius: var(--rad-m);
      margin-top: 1rem;
      box-shadow: var(--shadow-s);
    }
  </style>
</head>
<body>
  <div id="background"></div>
  <header>
    <div class="logo-container"><div class="logo-icon">S</div><span class="logo">StudyBuddy</span></div>
    <nav>
      <button class="active" data-target="dashboard">Dashboard</button>
      <button data-target="cafes">Cafés</button>
      <button data-target="games">Play</button>
      <button data-target="sessions">Sessions</button>
      <button data-target="planner">Planner</button>
    </nav>
  </header>

  <main>
    <!-- Dashboard -->
    <section id="dashboard" class="active">
      <h2 class="section-title">Dashboard</h2>
      <div id="quotes"></div>
      <button id="refreshQuotes" class="btn btn-small btn-primary">Refresh Quotes</button>

      <div class="card">
        <h3>Pomodoro Timer</h3>
        <div id="timerDisplay">25:00</div>
        <div id="timerControls">
          <button id="startTimer" class="btn btn-primary">Start</button>
          <button id="pauseTimer" class="btn btn-secondary">Pause</button>
          <button id="resetTimer" class="btn btn-secondary">Reset</button>
        </div>
      </div>

      <div class="card">
        <h3>Tasks</h3>
        <form id="newTaskForm">
          <input id="newTaskInput" type="text" placeholder="New task… (Enter or click Add)" required/>
          <button type="submit" class="btn btn-primary btn-small">Add</button>
        </form>
        <div id="tasksBoard">
          <div class="column" data-status="todo"><h3>To Do</h3></div>
          <div class="column" data-status="inprogress"><h3>In Progress</h3></div>
          <div class="column" data-status="completed"><h3>Completed</h3></div>
        </div>
      </div>
    </section>

    <!-- Cafés -->
<!-- Cafés -->
<section id="cafes">
  <h2 class="section-title">Study Cafés</h2>
  <div id="map"></div>
  
  <div class="card">
    <h3>Add Café Review</h3>
    <form id="reviewForm">
      <div style="position: relative; grid-column: span 2;">
        <input id="reviewName" list="cafeList" type="text" placeholder="Choose a cafe or type a name..." required/>
        <datalist id="cafeList"></datalist>
      </div>
      <select id="reviewRating" required>
        <option value="">Select Rating...</option>
        <option value="1">★ (Poor)</option>
        <option value="2">★★ (Fair)</option>
        <option value="3">★★★ (Good)</option>
        <option value="4">★★★★ (Very Good)</option>
        <option value="5">★★★★★ (Excellent)</option>
      </select>
      <select id="reviewCategory" required>
        <option value="">Best For...</option>
        <option value="studying">Studying</option>
        <option value="reading">Reading</option>
        <option value="meetings">Meetings</option>
        <option value="relaxing">Relaxing</option>
        <option value="food">Food & Drinks</option>
      </select>
      <textarea id="reviewText" rows="3" placeholder="Share your experience... Were the tables good for studying? How was the WiFi? Was it quiet?" required></textarea>
      <button class="btn btn-primary" type="submit">Save Review</button>
    </form>
  </div>
  
  <div id="cafeReviews"></div>
</section>
    <!-- Games -->
    <section id="games">
      <h2 class="section-title">Take a Break</h2>
      <select id="gameSelect"></select>
      <iframe id="gameFrame"></iframe>
    </section>

    <!-- Sessions -->
    <section id="sessions">
      <h2 class="section-title">Study Sessions</h2>
      <div class="card">
        <h3>New Session</h3>
        <form id="sessionForm" class="grid two-col">
          <div><label>Topic</label><input id="sessionTopic" type="text" required/></div>
          <div><label>Date</label><input id="sessionDate" type="date" required/></div>
          <div><label>Duration</label><input id="sessionDuration" type="number" required/></div>
          <div style="grid-column:1/-1;"><button class="btn btn-primary" type="submit">Add</button></div>
        </form>
      </div>
      <ul id="sessionList"></ul>
    </section>

    <!-- Planner -->
    <section id="planner">
      <h2 class="section-title">Study Planner</h2>
      <div class="card">
        <h3>Add Planner Task</h3>
        <form id="plannerForm">
          <input id="planTitle" type="text" placeholder="Title…" required style="width:48%;display:inline-block;margin-right:2%;"/>
          <select id="planCat" style="width:48%;display:inline-block;" required>
            <option value="">Category…</option><option>Homework</option><option>Reading</option><option>Project</option><option>Review</option>
          </select>
          <textarea id="planDesc" rows="2" placeholder="Description…"></textarea>
          <input id="planDate" type="date" required/>
          <button class="btn btn-primary" type="submit">Add Task</button>
        </form>
      </div>
      <div id="planList"></div>
      <button id="planStudy" class="btn btn-primary">Plan My Study</button>
      <div id="plannerAdvice"></div>
    </section>
  </main>

  <!-- Chat -->
  <button id="chatToggle">💬</button>
  <div id="chatWidget">
    <div id="chatHeader">
      StudyBuddy AI
      <button id="chatClose">✕</button>
    </div>
    <div id="chatBody"></div>
    <form id="chatInput">
      <input type="text" placeholder="Ask a question…" autocomplete="off" required/>
      <button type="submit">➤</button>
    </form>
  </div>

  <!-- Celebration -->
  <div id="celebrationPopup">
    <span class="emoji">🎉</span>
    <h2>Great Job!</h2>
    <p>You've completed a task!</p>
    <button id="closeCelebration">Continue</button>
  </div>

  <script>
 /* StudyBuddy main script – v1.0.1 (all features consolidated & bug‑fixed)
   ‑‑ paste this file after the <body> tag or bundle it as /assets/js/studybuddy.js ‑‑
*/

(() => {
  'use strict';

  // ────────────────────────────────────────────────────────────────────────────
  // GLOBALS & CONSTANTS
  // ────────────────────────────────────────────────────────────────────────────
  const VERSION = '1.0.1';
  let leafletMap = null;   // exposed so resize can invalidate size later

  /* Convenience */
  const qs = id => document.getElementById(id);

  // ────────────────────────────────────────────────────────────────────────────
  // APP BOOTSTRAP
  // ────────────────────────────────────────────────────────────────────────────
  document.addEventListener('DOMContentLoaded', () => {
    console.log(`StudyBuddy ${VERSION} initialising…`);

    initVanta();
    createToastSystem();
    initNav();
    initQuotes();
    initPomodoro();
    initTasks();
    initCafe();
    initGames();
    initSessions();
    initPlanner();
    initChat();

    setupKeyboardShortcuts();
    adjustForScreenSize();
    fixMobileViewport();
    detectTouchDevice();
    window.addEventListener('resize', adjustForScreenSize);

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('✓ Service‑worker registered'))
        .catch(err => console.warn('SW registration failed', err));
    }

    console.log('StudyBuddy ready!');
  });

  // ────────────────────────────────────────────────────────────────────────────
  // TOAST SYSTEM
  // ────────────────────────────────────────────────────────────────────────────
  function createToastSystem () {
    if (qs('toast-container')) return; // already wired

    const wrap = document.createElement('div');
    wrap.id = 'toast-container';
    wrap.style.cssText = `position:fixed;bottom:20px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:10px;max-width:300px;`;
    document.body.appendChild(wrap);

    const css = document.createElement('style');
    css.textContent = `
      @keyframes toastIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
      @keyframes toastOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
      .toast{padding:12px 16px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.15);font-size:14px;border-left:4px solid;animation:toastIn .3s ease;position:relative;color:#fff;max-width:300px}
      .toast.info{background:rgba(52,152,219,.95);border-color:#3498db}
      .toast.success{background:rgba(46,204,113,.95);border-color:#2ecc71}
      .toast.error{background:rgba(231,76,60,.95);border-color:#e74c3c}
      .toast.warning{background:rgba(241,196,15,.95);border-color:#f1c40f}`;
    document.head.appendChild(css);

    /** global */
    window.showToast = function (message, type = 'info', duration = 3000) {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `${message}<span style="position:absolute;top:8px;right:8px;cursor:pointer;font-weight:bold;">×</span>`;
      t.querySelector('span').onclick = close;
      wrap.appendChild(t);

      if (duration > 0) setTimeout(close, duration);

      function close () {
        t.style.animation = 'toastOut .3s ease forwards';
        setTimeout(() => t.remove(), 300);
      }
      return t;
    };
  }

  // ────────────────────────────────────────────────────────────────────────────
  // VANTA BACKGROUND
  // ────────────────────────────────────────────────────────────────────────────
  function initVanta () {
    if (window.VANTA && window.VANTA.DOTS) {
      window.VANTA.DOTS({
        el: '#background',
        mouseControls: true,
        touchControls: true,
        minHeight: 200,
        minWidth: 200,
        scale: 1,
        scaleMobile: 1,
        color: 0x8c67ff,
        color2: 0x4f46e5,
        backgroundColor: 0x121212,
        size: 3,
        spacing: 25,
        showLines: false
      });
    }
  }

  // ────────────────────────────────────────────────────────────────────────────
  // NAVIGATION (tabs)
  // ────────────────────────────────────────────────────────────────────────────
  function initNav () {
    document.querySelectorAll('nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelector('nav button.active').classList.remove('active');
        btn.classList.add('active');
        document.querySelector('section.active').classList.remove('active');
        qs(btn.dataset.target).classList.add('active');
      });
    });
  }

  // ────────────────────────────────────────────────────────────────────────────
  // MOTIVATIONAL QUOTES
  // ────────────────────────────────────────────────────────────────────────────
  function initQuotes () {
    const QUOTES = [
      'Start where you are.', 'Progress over perfection.', 'One step at a time.', 'Dream, believe, do.',
      'Focus and win.', 'Every day is a second chance.', 'Small progress is progress.', 'Stay positive.',
      'Believe you can.', 'Do it now.', 'Keep pushing.', 'Consistency is key.', 'Success is a journey.',
      'You got this.', 'Make today count.'
    ];

    const container = qs('quotes');
    const render = () => {
      container.innerHTML = '';
      QUOTES.sort(() => 0.5 - Math.random()).slice(0, 3).forEach(q => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = `"${q}"`;
        container.append(div);
      });
    };

    render();
    qs('refreshQuotes').onclick = render;
  }

  // ────────────────────────────────────────────────────────────────────────────
  // POMODORO TIMER
  // ────────────────────────────────────────────────────────────────────────────
  function initPomodoro () {
    let seconds = 25 * 60;
    let timer = null;
    const display = qs('timerDisplay');
    const startBtn = qs('startTimer');
    const pauseBtn = qs('pauseTimer');
    const resetBtn = qs('resetTimer');

    const update = () => {
      const m = String(Math.floor(seconds / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      display.textContent = `${m}:${s}`;
      document.title = `(${m}:${s}) StudyBuddy`;
    };
    update();

    startBtn.onclick = () => {
      if (timer) return;
      timer = setInterval(() => {
        if (seconds > 0) {
          seconds--; update();
        } else {
          clearInterval(timer); timer = null;
          window.confetti && window.confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
          showToast('Pomodoro finished! Take a break.', 'success');
          document.title = 'StudyBuddy';
        }
      }, 1000);
    };

    pauseBtn.onclick = () => { clearInterval(timer); timer = null; };
    resetBtn.onclick = () => { clearInterval(timer); timer = null; seconds = 25 * 60; update(); };
  }

  // ────────────────────────────────────────────────────────────────────────────
  // TASK KANBAN BOARD
  // ────────────────────────────────────────────────────────────────────────────
  function initTasks () {
    const LS_KEY = 'sb-tasks';
    const board = qs('tasksBoard');
    const form = qs('newTaskForm');
    const input = qs('newTaskInput');

    const blank = () => ({ todo: [], inprogress: [], completed: [] });
    const load = () => {
      try {
        const d = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
        if (Array.isArray(d)) return { todo: d, inprogress: [], completed: [] }; // migrate
        return d && typeof d === 'object' ? d : blank();
      } catch { return blank(); }
    };
    const save = data => localStorage.setItem(LS_KEY, JSON.stringify(data));

    const render = () => {
      const data = load();
      ['todo', 'inprogress', 'completed'].forEach(status => {
        const col = document.querySelector(`.column[data-status="${status}"]`);
        const title = col.querySelector('h3').textContent;
        col.innerHTML = `<h3>${title}</h3>`;
        data[status].forEach((txt, i) => {
          const div = document.createElement('div');
          div.className = 'task';
          div.innerHTML = `
            <span>${txt}</span>
            <div class="task-buttons">
              ${status === 'todo' ? `<button class="btn btn-small btn-primary" data-act="start" data-idx="${i}">Start</button>` : ''}
              ${status === 'inprogress' ? `<button class="btn btn-small btn-primary" data-act="complete" data-idx="${i}">Complete</button>` : ''}
              <button class="btn btn-small btn-secondary" data-act="delete" data-status="${status}" data-idx="${i}">×</button>
            </div>`;
          col.append(div);
        });
      });
    };

    form.addEventListener('submit', e => {
      e.preventDefault();
      const val = input.value.trim();
      if (!val) return;
      const data = load();
      data.todo.push(val); save(data);
      input.value = ''; render();
    });

    board.addEventListener('click', e => {
      const btn = e.target.closest('button[data-act]');
      if (!btn) return;
      const action = btn.dataset.act;
      const idx = +btn.dataset.idx;
      const data = load();

      if (action === 'delete') data[btn.dataset.status].splice(idx, 1);
      if (action === 'start') data.inprogress.push(data.todo.splice(idx, 1)[0]);
      if (action === 'complete') {
        data.completed.push(data.inprogress.splice(idx, 1)[0]);
        window.confetti && window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        qs('celebrationPopup').style.display = 'block';
        setTimeout(() => qs('celebrationPopup').style.display = 'none', 3000);
      }
      save(data); render();
    });

    qs('closeCelebration').onclick = () => qs('celebrationPopup').style.display = 'none';
    render();
  }

  // ────────────────────────────────────────────────────────────────────────────
  // STUDY CAFÉ MAP + REVIEWS (Leaflet + OpenStreetMap)
  // ────────────────────────────────────────────────────────────────────────────
  function initCafe () {
    const mapEl = qs('map');
    if (!mapEl) return;

    let cafeMarkers = [];
    const cafeList = qs('cafeList');
    const reviewForm = qs('reviewForm');
    let allCafes = [];

    /* dynamic leaflet loader */
    const loadLeaflet = () => new Promise((resolve, reject) => {
      if (window.L) { resolve(); return; }
      const css = document.createElement('link'); css.rel = 'stylesheet'; css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      document.head.appendChild(css);
      const js = document.createElement('script'); js.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      js.onload = resolve; js.onerror = reject; document.head.appendChild(js);
    });

    const initMap = (lat, lng) => {
      leafletMap = L.map(mapEl, { center: [lat, lng], zoom: 14 });
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(leafletMap);
      L.marker([lat, lng]).addTo(leafletMap).bindPopup('Your location');
      L.circle([lat, lng], { radius: 5000, color: '#8c67ff', fillColor: '#8c67ff', fillOpacity: .05 }).addTo(leafletMap);
      fetchCafes(lat, lng, 5000);
    };

    const fetchCafes = (lat, lng, radius) => {
      const query = `[out:json][timeout:15];(node["amenity"="cafe"](around:${radius},${lat},${lng});node["amenity"="library"](around:${radius},${lat},${lng});node["shop"="coffee"](around:${radius},${lat},${lng}));out body;`;
      fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'data=' + encodeURIComponent(query)
      })
        .then(r => r.json())
        .then(j => processCafes(j.elements))
        .catch(err => {
          console.warn('Overpass error', err);
          showToast('Couldn\'t fetch cafés. Showing sample data.', 'warning');
          processCafes([
            { lat: lat + 0.005, lon: lng + 0.005, tags: { name: 'Study Café', amenity: 'cafe' } },
            { lat: lat - 0.004, lon: lng + 0.006, tags: { name: 'Library Corner', amenity: 'library' } }
          ]);
        });
    };

    const ico = (emoji, bg) => L.divIcon({ html: `<div style="background:${bg};color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;">${emoji}</div>`, className: '' });

    const processCafes = nodes => {
      clearMarkers();
      allCafes = [];
      nodes.forEach(n => {
        const t = n.tags.amenity === 'library' ? 'library' : 'cafe';
        const info = t === 'library' ? { e: '📚', c: '#4f46e5', lbl: 'Library' } : { e: '☕', c: '#8c67ff', lbl: 'Café' };
        const name = n.tags.name || `${info.lbl} #${n.id.toString().slice(-4)}`;
        allCafes.push({ name });
        const m = L.marker([n.lat, n.lon], { icon: ico(info.e, info.c) }).addTo(leafletMap);
        m.bindPopup(`<strong>${name}</strong><br><button onclick="selectCafeForReview('${name.replace(/'/g, '\\')}")" style="margin-top:6px;background:${info.c};color:#fff;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;">Add Review</button>`);
        cafeMarkers.push(m);
      });
      updateCafeList();
    };

    const clearMarkers = () => { cafeMarkers.forEach(m => leafletMap.removeLayer(m)); cafeMarkers = []; };

    window.selectCafeForReview = name => {
      const input = qs('reviewName'); if (input) { input.value = name; reviewForm.scrollIntoView({ behavior: 'smooth' }); }
      showToast(`Selected ${name} for review`, 'info', 2000);
    };

    /* Review CRUD */
    const LS_REV = 'sb-reviews';
    const getReviews = () => { try { return JSON.parse(localStorage.getItem(LS_REV) || '[]'); } catch { return []; } };
    const saveReviews = arr => localStorage.setItem(LS_REV, JSON.stringify(arr));

    const renderReviews = () => {
      const container = qs('cafeReviews');
      if (!container) return;
      const reviews = getReviews();
      container.innerHTML = '';
      if (!reviews.length) { container.innerHTML = '<div class="card" style="padding:2rem;text-align:center;">No reviews yet.</div>'; return; }
      const by = {};
      reviews.forEach(r => (by[r.name] = by[r.name] || []).push(r));
      Object.keys(by).sort().forEach(cafe => {
        const arr = by[cafe];
        const avg = arr.reduce((s, r) => s + r.rating, 0) / arr.length;
        const card = document.createElement('div'); card.className = 'card cafe-review-card';
        card.innerHTML = `<div class="review-header"><h3 style="margin:0">${cafe}</h3><div>${'★'.repeat(Math.round(avg))}${'☆'.repeat(5 - Math.round(avg))}</div></div>`;
        arr.forEach((r, i) => {
          const item = document.createElement('div'); item.style.cssText = 'border-top:1px solid rgba(255,255,255,.05);margin-top:6px;padding-top:6px';
          item.innerHTML = `
            <div style="color:#f2c94c">${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}</div>
            <p style="margin:4px 0">${r.text}</p>
            <small>${r.date}</small>
            <button class="delete-review btn btn-small btn-secondary" data-cafe="${cafe}" data-idx="${i}" style="float:right">×</button>`;
          card.appendChild(item);
        });
        container.appendChild(card);
      });
      container.querySelectorAll('.delete-review').forEach(btn => {
        btn.onclick = () => {
          const cafe = btn.dataset.cafe;
          const idx = +btn.dataset.idx;
          const rev = getReviews();
          const filtered = rev.filter(r => !(r.name === cafe && by[cafe].indexOf(r) === idx));
          saveReviews(filtered);
          renderReviews();
          showToast('Review deleted', 'success');
        };
      });
    };

    if (reviewForm) {
      reviewForm.addEventListener('submit', e => {
        e.preventDefault();
        const name = qs('reviewName').value.trim();
        const rating = +qs('reviewRating').value;
        const category = qs('reviewCategory').value;
        const text = qs('reviewText').value.trim();
        if (!name || !rating || !category || !text) { showToast('Fill all review fields', 'error'); return; }
        const rev = getReviews();
        rev.push({ name, rating, category, text, date: new Date().toISOString().split('T')[0] });
        saveReviews(rev);
        reviewForm.reset();
        renderReviews();
        showToast('Review saved!', 'success');
      });
    }

    const updateCafeList = () => {
      cafeList.innerHTML = '';
      allCafes.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
        const op = document.createElement('option'); op.value = c.name; cafeList.appendChild(op);
      });
    };

    loadLeaflet().then(() => {
      navigator.geolocation.getCurrentPosition(
        pos => initMap(pos.coords.latitude, pos.coords.longitude),
        () => initMap(25.276987, 55.296249),
        { timeout: 5000 });
    });

    renderReviews();
  }

  // ────────────────────────────────────────────────────────────────────────────
  // GAME IFRAME SELECTOR
  // ────────────────────────────────────────────────────────────────────────────
  function initGames () {
    const select = qs('gameSelect');
    const frame = qs('gameFrame');
    if (!select || !frame) return;

    const GAMES = [
      ['Wordle Clone', 'https://wordlegame.org/'],
      ['Hangman', 'https://hangmanwordgame.com/'],
      ['Flappy Bird', 'https://flappybird.io/'],
      ['Minesweeper', 'https://kamoroso94.github.io/minesweeper/'],
      ['Sudoku', 'https://sudoku.com/'],
      ['Connect Four', 'https://torikul007.github.io/Connect_Four/']
    ];

    select.innerHTML = '';
    GAMES.forEach(([label, url]) => {
      const op = document.createElement('option'); op.value = url; op.textContent = label; select.appendChild(op);
    });
    select.onchange = () => { frame.src = select.value; };
    select.selectedIndex = 0; select.dispatchEvent(new Event('change'));
  }

  // ────────────────────────────────────────────────────────────────────────────
  // STUDY SESSIONS LIST
  // ────────────────────────────────────────────────────────────────────────────
  function initSessions () {
    const LS = 'sb-sessions';
    const get = () => { try { return JSON.parse(localStorage.getItem(LS) || '[]'); } catch { return []; } };
    const save = arr => localStorage.setItem(LS, JSON.stringify(arr));
    const list = qs('sessionList');
    const form = qs('sessionForm');

    const render = () => {
      const arr = get();
      list.innerHTML = '';
      if (!arr.length) { list.innerHTML = '<li class="card">No sessions yet.</li>'; return; }
      arr.sort((a, b) => new Date(b.date) - new Date(a.date));
      arr.forEach((s, i) => {
        const li = document.createElement('li'); li.className = 'card'; li.style.marginBottom = '.6rem';
        li.innerHTML = `<strong>${s.topic}</strong> ${s.date} — ${s.duration} min <button class="btn btn-small btn-secondary" data-idx="${i}">Delete</button>`;
        li.querySelector('button').onclick = () => { const d = get(); d.splice(i, 1); save(d); render(); showToast('Session deleted', 'info'); };
        list.appendChild(li);
      });
    };

    if (form) {
      form.addEventListener('submit', e => {
        e.preventDefault();
        const topic = qs('sessionTopic').value.trim();
        const date = qs('sessionDate').value;
        const duration = +qs('sessionDuration').value;
        if (!topic || !date || isNaN(duration)) { showToast('Fill all session fields', 'error'); return; }
        const data = get(); data.push({ topic, date, duration }); save(data); render(); form.reset(); showToast('Session added', 'success');
      });
    }

    render();
  }

  // ────────────────────────────────────────────────────────────────────────────
  // STUDY PLANNER & STUDY PLAN GENERATOR
  // ────────────────────────────────────────────────────────────────────────────
  function initPlanner () {
    const LS = 'sb-plans';
    const get = () => { try { return JSON.parse(localStorage.getItem(LS) || '[]'); } catch { return []; } };
    const save = a => localStorage.setItem(LS, JSON.stringify(a));

    const list = qs('planList');
    const form = qs('plannerForm');
    const generateBtn = qs('planStudy');
    const advice = qs('plannerAdvice');

    const categories = ['Homework', 'Reading', 'Project', 'Review', 'Exam', 'Essay', 'Presentation', 'Research', 'Lab', 'Other'];
    const catSelect = qs('planCat');
    if (catSelect && catSelect.options.length <= 1) {
      catSelect.innerHTML = '<option value="">Category…</option>';
      categories.forEach(c => { const op = document.createElement('option'); op.value = c; op.textContent = c; catSelect.appendChild(op); });
    }

    const render = () => {
      const arr = get();
      list.innerHTML = '';
      if (!arr.length) { list.innerHTML = '<div class="card" style="text-align:center;padding:1rem;">No study plans yet.</div>'; return; }
      arr.sort((a, b) => new Date(a.date) - new Date(b.date));
      const em = { Homework: '📝', Reading: '📚', Project: '🛠️', Review: '🔍', Exam: '📊', Essay: '✍️', Presentation: '🎯', Research: '🔬', Lab: '🧪', Other: '📌' };
      arr.forEach((p, i) => {
        const card = document.createElement('div'); card.className = 'card'; card.style.position = 'relative';
        const when = new Date(p.date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        card.innerHTML = `
          <h4 style="margin-bottom:6px"><span style="font-size:1.4em">${em[p.category] || '📌'}</span> ${p.title}</h4>
          <div style="display:flex;justify-content:space-between;margin-bottom:6px"><small style="background:rgba(140,103,255,.2);padding:2px 8px;border-radius:12px">${p.category}</small><small style="color:var(--txt-2)">📅 ${when}</small></div>
          <p>${p.desc || ''}</p>
          <button class="delete-plan btn btn-small btn-secondary" data-idx="${i}" style="position:absolute;top:8px;right:8px">×</button>`;
        card.querySelector('button').onclick = () => { const d = get(); d.splice(i, 1); save(d); render(); showToast('Plan deleted', 'success'); };
        list.appendChild(card);
      });
    };

    if (form) {
      form.addEventListener('submit', e => {
        e.preventDefault();
        const title = qs('planTitle').value.trim();
        const category = qs('planCat').value;
        const desc = qs('planDesc').value.trim();
        const date = qs('planDate').value;
        if (!title || !category || !date) { showToast('Fill required fields', 'error'); return; }
        const data = get(); data.push({ title, category, desc, date }); save(data); form.reset(); render(); showToast('Plan added', 'success');
      });
    }

    generateBtn.onclick = () => {
      const tasks = get();
      if (!tasks.length) { advice.innerHTML = '<p style="text-align:center">Please add tasks first.</p>'; return; }
      advice.innerHTML = '<p style="text-align:center;padding:20px;">Generating plan…</p>';
      setTimeout(() => {
        const today = new Date();
        tasks.sort((a, b) => new Date(a.date) - new Date(b.date));

        const md = [`# Your Personalized Study Plan`, `Today is ${today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}.`];
        tasks.forEach(t => {
          const due = new Date(t.date);
          const diff = Math.ceil((due - today) / 86400000);
          const when = diff <= 0 ? 'Today' : diff === 1 ? 'Tomorrow' : `In ${diff} days`;
          md.push(`## ${when}`);
          md.push(`### ${t.title} (${t.category})`);
          md.push(`- Due date: ${due.toLocaleDateString()}`);
          if (t.desc) md.push(`- Description: ${t.desc}`);
          md.push(`- Study tip: ${t.category === 'Reading' ? 'Break reading into chunks.' : 'Use 25‑min focus sessions.'}`);
        });
        md.push('## General Tips', '- Study in 25‑30 min blocks', '- Stay hydrated');

        const html = markdownToHtml(md.join('\n'));
        advice.innerHTML = html;
        attachDownload(html.replace(/<[^>]+>/g, ''));
        showToast('Study plan generated', 'success');
      }, 600);
    };

    const markdownToHtml = md => {
      return md.split('\n').map(line => {
        if (line.startsWith('# ')) return `<h1>${line.slice(2)}</h1>`;
        if (line.startsWith('## ')) return `<h2>${line.slice(3)}</h2>`;
        if (line.startsWith('### ')) return `<h3>${line.slice(4)}</h3>`;
        if (line.startsWith('- ')) return `<li>${line.slice(2)}</li>`;
        return `<p>${line}</p>`;
      }).join('');
    };

    const attachDownload = text => {
      let btn = qs('downloadPlan');
      if (!btn) {
        btn = document.createElement('button');
        btn.id = 'downloadPlan';
        btn.className = 'btn btn-primary';
        btn.textContent = '📥 Download Study Plan';
        generateBtn.insertAdjacentElement('afterend', btn);
      }
      btn.onclick = () => {
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'StudyBuddy_Plan.txt';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showToast('Study plan downloaded', 'success');
      };
    };

    render();
  }

  // ────────────────────────────────────────────────────────────────────────────
  // MINI CHATBOT (client‑side fallback)
  // ────────────────────────────────────────────────────────────────────────────
  function initChat () {
    const toggle = qs('chatToggle');
    const widget = qs('chatWidget');
    const closeBtn = qs('chatClose');
    const body = qs('chatBody');
    const form = qs('chatInput');

    const addMsg = (cls, txt) => {
      const row = document.createElement('div'); row.className = `row ${cls}`; row.innerHTML = `<p>${txt}</p>`; body.appendChild(row); body.scrollTop = body.scrollHeight;
    };

    toggle.onclick = () => widget.classList.toggle('open');
    closeBtn.onclick = () => widget.classList.remove('open');

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const inp = form.querySelector('input');
      const txt = inp.value.trim(); if (!txt) return;
      addMsg('me', txt); inp.value = '';
      addMsg('bot', '…');

      try {
        const res = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: txt }) });
        const { reply } = await res.json();
        body.querySelector('.row.bot:last-child p').textContent = reply || defaultReply();
      } catch {
        body.querySelector('.row.bot:last-child p').textContent = defaultReply();
      }
    });

    const defaultReply = () => {
      const arr = [
        'I\'m here to help with your studying.',
        'Need help organizing your schedule?',
        'Tip: Use Pomodoro to stay focused.',
        'Remember to take breaks!',
        'What topic are you working on?'
      ];
      return arr[Math.floor(Math.random() * arr.length)];
    };
  }

  // ────────────────────────────────────────────────────────────────────────────
  // KEYBOARD SHORTCUTS & RESPONSIVE HELPERS
  // ────────────────────────────────────────────────────────────────────────────
  function setupKeyboardShortcuts () {
    document.addEventListener('keydown', e => {
      if (e.altKey && e.key === 't') qs('startTimer').click();
      if (e.altKey && e.key === 'n') qs('newTaskInput').focus();
      if (e.altKey && ['1', '2', '3', '4', '5'].includes(e.key)) {
        document.querySelectorAll('nav button')[+e.key - 1]?.click();
      }
    });
  }

  function adjustForScreenSize () {
    const mobile = window.innerWidth < 768;
    const map = qs('map'); if (map) map.style.height = mobile ? '350px' : '500px';
    const reviewForm = qs('reviewForm'); if (reviewForm) reviewForm.style.display = mobile ? 'block' : 'grid';
    leafletMap && setTimeout(() => leafletMap.invalidateSize(), 100);
  }

  function fixMobileViewport () {
    if (window.innerWidth < 768) {
      let vp = document.querySelector('meta[name="viewport"]');
      if (!vp) { vp = document.createElement('meta'); vp.name = 'viewport'; document.head.appendChild(vp); }
      vp.content = 'width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no';
    }
  }

  function detectTouchDevice () {
    if ('ontouchstart' in window || navigator.maxTouchPoints) document.body.classList.add('touch-device');
  }

  // ────────────────────────────────────────────────────────────────────────────
  // GLOBAL ERROR HANDLER (last‑resort)
  // ────────────────────────────────────────────────────────────────────────────
  window.addEventListener('error', e => {
    if (e.message && (e.message.includes('ResizeObserver loop') || e.message.includes('Script error'))) return;
    console.error('Global error', e);
    showToast('An unexpected error occurred.', 'error', 5000);
  });

})();

  </script>
  
</body>
</html>
