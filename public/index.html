<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StudyBuddy</title>

  <!-- Original Google API loader -->
  <script src="https://apis.google.com/js/api.js" defer></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Three.js & Vanta.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.dots.min.js" defer></script>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js" defer></script>

  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  defer
></script>

  <style>
    /* Enhanced CSS Styling for StudyBuddy */
/* Add these styles to the existing CSS */

/* Improved map styling */
#map {
  width: 100%;
  height: 500px;
  border-radius: var(--rad-m);
  margin-bottom: 1.5rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: var(--shadow-s);
  position: relative;
  z-index: 1;
}

/* Custom Leaflet styling */
.leaflet-container {
  background: #1e1e1e;
  font-family: 'Inter', sans-serif;
}

.leaflet-popup-content-wrapper {
  background: var(--bg-2);
  color: var(--txt-1);
  border-radius: var(--rad-m);
  padding: 0;
  box-shadow: var(--shadow-s);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.leaflet-popup-tip {
  background: var(--bg-2);
  box-shadow: var(--shadow-s);
}

.leaflet-popup-content {
  margin: 8px;
  width: auto !important;
}

.leaflet-control {
  margin: 10px !important;
}

.leaflet-bar a {
  background: var(--bg-2);
  color: var(--txt-1);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.leaflet-bar a:hover {
  background: var(--bg-3);
  color: var(--ac-1);
}

.leaflet-control-attribution {
  background: rgba(30, 30, 30, 0.7) !important;
  color: var(--txt-2) !important;
  backdrop-filter: blur(5px);
  padding: 3px 8px;
  border-radius: 4px;
}

.leaflet-control-attribution a {
  color: var(--ac-1) !important;
}

/* Enhanced study planner styling */
#plannerAdvice h3 {
  margin-top: 20px;
  margin-bottom: 10px;
  color: var(--ac-1);
  border-bottom: 1px solid var(--ac-1);
  padding-bottom: 5px;
}

#plannerAdvice div {
  line-height: 1.5;
}

#plannerAdvice strong {
  color: var(--ac-1);
}

/* Download button for study plan */
#downloadPlan {
  margin: 15px auto;
  display: block;
}

/* Enhanced forms */
#reviewForm, #plannerForm {
  background: var(--bg-3);
  padding: 15px;
  border-radius: var(--rad-m);
  margin-bottom: 20px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

#reviewForm input, #reviewForm select, #reviewForm textarea,
#plannerForm input, #plannerForm select, #plannerForm textarea {
  background: var(--bg-2);
  transition: all 0.2s ease;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

#reviewForm input:focus, #reviewForm select:focus, #reviewForm textarea:focus,
#plannerForm input:focus, #plannerForm select:focus, #plannerForm textarea:focus {
  border-color: var(--ac-1);
  box-shadow: 0 0 0 2px rgba(140, 103, 255, 0.2);
}

/* Better form layout for reviews */
#reviewForm {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

#reviewForm div:first-child {
  grid-column: span 2;
}

#reviewForm textarea {
  grid-column: span 2;
}

#reviewForm button {
  grid-column: span 2;
  margin-top: 0.5rem;
}

/* Enhanced cafe review cards */
.cafe-review-card {
  background: var(--bg-2);
  border-radius: var(--rad-m);
  padding: 1.25rem;
  box-shadow: var(--shadow-s);
  border: 1px solid rgba(255, 255, 255, 0.05);
  transition: all 0.3s ease;
  position: relative;
}

.cafe-review-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-l);
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.review-body {
  margin-bottom: 0.5rem;
  line-height: 1.5;
}

.review-rating {
  color: var(--ac-warn);
  font-size: 1.1rem;
}

.review-footer {
  font-size: 0.8rem;
  color: var(--txt-2);
  display: flex;
  justify-content: space-between;
  margin-top: 0.8rem;
  padding-top: 0.5rem;
  border-top: 1px solid rgba(255, 255, 255, 0.05);
}

/* Better styling for the review name input with datalist */
#reviewName {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255, 255, 255, 0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: 10px center;
  padding-left: 2.5rem;
}

/* Add smooth animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in {
  animation: fadeIn 0.4s ease forwards;
}

/* Add some visual flare to the study planner */
#planList .card {
  position: relative;
  overflow: hidden;
}

#planList .card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--ac-1), var(--ac-3));
  border-radius: var(--rad-s) 0 0 var(--rad-s);
}

#planList .card h4 {
  margin-left: 8px;
}

/* Enhanced planner button */
#planStudy {
  background: linear-gradient(135deg, var(--ac-1), var(--ac-2));
  padding: 0.8rem 1.6rem;
  font-weight: 600;
  letter-spacing: 0.5px;
  transition: all 0.3s ease;
  margin-bottom: 1rem;
}

#planStudy:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(140, 103, 255, 0.3);
}

/* Make loading indicators consistent */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(140, 103, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--ac-1);
  animation: spin 1s linear infinite;
  margin-right: 8px;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Add responsive improvements */
@media (max-width: 768px) {
  header {
    padding: 0.8rem 1rem;
  }
  
  .logo {
    font-size: 1.2rem;
  }
  
  main {
    padding: 1rem;
  }
  
  nav button {
    padding: 0.4rem 0.7rem;
    font-size: 0.9rem;
  }
  
  #map {
    height: 350px;
  }
  
  #reviewForm {
    display: block;
  }
  
  #timerDisplay {
    font-size: 2rem;
  }
  
  #tasksBoard {
    flex-direction: column;
  }
  
  .column {
    margin-bottom: 1rem;
  }
  
  #quotes {
    grid-template-columns: 1fr;
  }
}

/* Improve dark mode legibility */
::placeholder {
  color: rgba(176, 176, 176, 0.6);
}

select option {
  background-color: var(--bg-3);
}

/* Touch-specific enhancements */
.touch-device .task {
  position: relative;
}

.touch-device .task-buttons {
  position: absolute;
  right: 10px;
  display: flex;
  gap: 5px;
}

/* Focus styles for accessibility */
button:focus, input:focus, select:focus, textarea:focus {
  outline: 2px solid var(--ac-1);
  outline-offset: 2px;
}

/* Dark scrollbars for better aesthetics */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-1);
}

::-webkit-scrollbar-thumb {
  background: var(--bg-3);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--ac-1);
}

    :root {
      --bg-1:#121212; --bg-2:#1e1e1e; --bg-3:#2d2d2d;
      --txt-1:#fafafa; --txt-2:#b0b0b0;
      --ac-1:#8c67ff; --ac-2:#4f46e5; --ac-3:#ff6f91; --ac-warn:#f2c94c;
      --rad-s:6px; --rad-m:12px; --rad-l:20px;
      --shadow-s:0 4px 20px rgba(0,0,0,.15);
      --shadow-l:0 8px 30px rgba(0,0,0,.35);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
    body{background:var(--bg-1);color:var(--txt-1);min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;}
    a{color:var(--ac-1);text-decoration:none;transition:all .2s ease;}a:hover{text-decoration:underline;}
    #background{position:fixed;inset:0;z-index:-1;}
    header{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;padding:1rem 2rem;background:rgba(30,30,30,.85);backdrop-filter:blur(10px);box-shadow:var(--shadow-s);z-index:10;}
    .logo-container{display:flex;align-items:center;gap:.6rem;}
    .logo-icon{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--ac-1),var(--ac-2));display:grid;place-content:center;color:#fff;font-weight:700;}
    .logo{font-size:1.5rem;font-weight:700;background:linear-gradient(90deg,var(--ac-1),var(--ac-3));-webkit-background-clip:text;color:transparent;}
    nav{display:flex;gap:.3rem;flex-wrap:wrap;}
    nav button{background:none;border:none;color:var(--txt-2);padding:.55rem .95rem;border-radius:var(--rad-s);cursor:pointer;transition:all .2s ease;position:relative;}
    nav button:hover, nav button.active{background:rgba(140,103,255,.12);color:var(--txt-1);}
    nav button.active::after{content:'';position:absolute;left:50%;bottom:0;transform:translateX(-50%);width:22px;height:3px;background:var(--ac-1);border-radius:5px;}
    main{flex:1;max-width:1400px;margin:0 auto;padding:2rem;}
    section{display:none;animation:fade .35s ease-in-out;}section.active{display:block;}
    @keyframes fade{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
    h2.section-title{font-size:1.75rem;margin-bottom:1.4rem;}
    .card{background:var(--bg-2);padding:1.25rem;border-radius:var(--rad-m);box-shadow:var(--shadow-s);border:1px solid rgba(255,255,255,.05);transition:all .3s ease;position:relative;}
    .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-l);}
    .btn{display:inline-flex;align-items:center;gap:.45rem;border:none;cursor:pointer;padding:.7rem 1.4rem;font-weight:500;border-radius:var(--rad-s);box-shadow:0 2px 6px rgba(0,0,0,.2);transition:all .2s ease;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.3);}
    .btn-primary{background:var(--ac-1);color:#fff;} .btn-secondary{background:rgba(255,255,255,.1);color:var(--txt-1);} .btn-small{padding:.3rem .6rem;font-size:.8rem;}
    input,textarea,select{background:var(--bg-3);border:1px solid rgba(255,255,255,.1);color:var(--txt-1);padding:.75rem;border-radius:var(--rad-s);width:100%;margin-bottom:1rem;transition:border-color .2s ease;}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--ac-1);}
    /* Quotes */
    #quotes{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem;}
    #quotes .card{font-style:italic;text-align:center;color:var(--txt-2);}
    /* Pomodoro */
    #timerDisplay{font-size:2.5rem;text-align:center;margin:1rem 0;}
    #timerControls{display:flex;justify-content:center;gap:1rem;}
    /* Tasks */
    #tasksBoard{display:flex;gap:1rem;margin-top:1rem;}
    .column{background:var(--bg-2);flex:1;min-width:240px;padding:1rem;border-radius:var(--rad-m);position:relative;}
    .column h3{margin-bottom:.8rem;color:var(--txt-2);}
    .task{background:var(--bg-3);padding:.6rem 1rem;border-radius:var(--rad-s);margin-bottom:.6rem;display:flex;align-items:center;justify-content:space-between;}
    .task-buttons button{margin-left:.5rem;}
    /* Map */
    #map{width:100%;height:350px;border-radius:var(--rad-m);margin-bottom:1rem;}
    /* Reviews */
    .delete-review{position:absolute;top:4px;right:8px;cursor:pointer;color:var(--ac-warn);font-weight:bold;}
    .delete-review:hover{color:var(--ac-3);}
    /* Games */
    #gameSelect{margin-bottom:1rem;}
    /* Make iframe much bigger */
    #gameFrame{width:100%;height:80vh;border:none;border-radius:var(--rad-m);margin-top:1rem;box-shadow:var(--shadow-s);}
    /* Planner */
    #planList .card{margin-bottom:1rem;padding-right:2.5rem;}
    #plannerAdvice{margin-top:1rem;background:var(--bg-3);padding:1rem;border-radius:var(--rad-s);max-height:300px;overflow-y:auto;white-space:pre-wrap;line-height:1.5;}
    .delete-plan{position:absolute;top:10px;right:10px;cursor:pointer;color:var(--ac-warn);font-weight:bold;font-size:1.2rem;}
    .delete-plan:hover{color:var(--ac-3);}
    /* Chat */
    #chatToggle{position:fixed;bottom:1rem;right:1rem;width:56px;height:56px;border-radius:50%;background:var(--ac-1);color:#fff;font-size:1.5rem;border:none;cursor:pointer;box-shadow:var(--shadow-l);z-index:20;transition:transform 0.3s ease,box-shadow 0.3s ease;}
    #chatToggle:hover{transform:scale(1.1);box-shadow:0 10px 40px rgba(140,103,255,.4);}
    #chatWidget{position:fixed;bottom:1.5rem;right:1.5rem;width:340px;height:400px;background:var(--bg-2);border-radius:var(--rad-l);box-shadow:var(--shadow-l);display:flex;flex-direction:column;overflow:hidden;z-index:20;opacity:0;transform:translateY(20px) scale(0.8);pointer-events:none;transition:opacity .3s ease,transform .3s ease;}
    #chatWidget.open{opacity:1;transform:translateY(0) scale(1);pointer-events:all;}
    #chatHeader{background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;border-top-left-radius:var(--rad-l);border-top-right-radius:var(--rad-l);}
    #chatClose{background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;transition:transform .2s ease;}
    #chatClose:hover{transform:rotate(90deg);}
    #chatBody{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.7rem;scroll-behavior:smooth;background:rgba(18,18,18,.3);}
    .row{display:flex;}
    .row.me{justify-content:flex-end;}
    .row p{padding:.75rem 1rem;border-radius:18px;max-width:80%;font-size:.88rem;line-height:1.5;}
    .me p{background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;border-bottom-right-radius:6px;}
    .bot p{background:var(--bg-3);color:var(--txt-1);border-bottom-left-radius:6px;}
    #chatInput{display:flex;border-top:1px solid rgba(255,255,255,.06);}
    #chatInput input{flex:1;border:none;background:var(--bg-3);color:var(--txt-1);padding:.75rem 1rem;border-radius:var(--rad-s);margin:.5rem;outline:none;}
    #chatInput button{width:42px;height:42px;margin:.5rem;border-radius:50%;background:var(--ac-1);border:none;color:#fff;transition:all .2s ease;cursor:pointer;}
    #chatInput button:hover{transform:scale(1.1);background:var(--ac-2);}
    /* Celebration */
    #celebrationPopup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;padding:2rem;border-radius:var(--rad-l);text-align:center;z-index:100;box-shadow:var(--shadow-l);animation:popIn .5s cubic-bezier(.175,.885,.32,1.275) forwards;}
    #celebrationPopup .emoji{font-size:4rem;margin-bottom:1rem;display:block;}
    #celebrationPopup h2{font-size:2rem;margin-bottom:1rem;}
    #celebrationPopup button{margin-top:1rem;background:rgba(255,255,255,.2);border:none;color:#fff;padding:.5rem 1.5rem;border-radius:var(--rad-s);cursor:pointer;transition:all .2s ease;}
    #celebrationPopup button:hover{background:rgba(255,255,255,.3);}
    @keyframes popIn{0%{transform:translate(-50%,-50%) scale(.8);opacity:0;}100%{transform:translate(-50%,-50%) scale(1);opacity:1;}}
    :root {
      --bg-1: #121212;
      --bg-2: #1e1e1e;
      --bg-3: #2d2d2d;
      --txt-1: #fafafa;
      --txt-2: #b0b0b0;
      --ac-1: #8c67ff;
      --ac-2: #4f46e5;
      --ac-3: #ff6f91;
      --ac-warn: #f2c94c;
      --rad-s: 6px;
      --rad-m: 12px;
      --rad-l: 20px;
      --shadow-s: 0 4px 20px rgba(0, 0, 0, .15);
      --shadow-l: 0 8px 30px rgba(0, 0, 0, .35);
    }
  
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
  
    body {
      background: var(--bg-1);
      color: var(--txt-1);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }
  
    a {
      color: var(--ac-1);
      text-decoration: none;
      transition: all .2s ease;
    }
    a:hover {
      text-decoration: underline;
    }
  
    #background {
      position: fixed;
      inset: 0;
      z-index: -1;
    }
  
    header {
      position: sticky;
      top: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      background: rgba(30, 30, 30, .85);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-s);
      z-index: 10;
    }
  
    .logo-container {
      display: flex;
      align-items: center;
      gap: .6rem;
    }
  
    .logo-icon {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--ac-1), var(--ac-2));
      display: grid;
      place-content: center;
      color: #fff;
      font-weight: 700;
    }
  
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--ac-1), var(--ac-3));
      -webkit-background-clip: text;
      color: transparent;
    }
  
    nav {
      display: flex;
      gap: .3rem;
      flex-wrap: wrap;
    }
  
    nav button {
      background: none;
      border: none;
      color: var(--txt-2);
      padding: .55rem .95rem;
      border-radius: var(--rad-s);
      cursor: pointer;
      transition: all .2s ease;
      position: relative;
    }
    nav button:hover,
    nav button.active {
      background: rgba(140, 103, 255, .12);
      color: var(--txt-1);
    }
    #map {
      width: 100%;
      height: 500px;
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-s);
    }
  
    /* Improved cafe review styling */
    #reviewForm {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
  
    #reviewForm textarea {
      grid-column: span 2;
    }
  
    #reviewForm button {
      margin-top: 0.5rem;
    }
  
    /* Search input styling */
    .search-control input {
      background: var(--bg-3);
      color: var(--txt-1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.6rem;
      border-radius: var(--rad-s);
      width: 220px;
      box-shadow: var(--shadow-s);
      margin-bottom: 0 !important;
    }
  
    .search-control input:focus {
      outline: none;
      border-color: var(--ac-1);
    }
  
    /* Loading indicator */
    .loading-indicator span {
      background: rgba(30, 30, 30, 0.8);
      color: var(--txt-1);
      padding: 8px 12px;
      border-radius: var(--rad-s);
      font-size: 0.9rem;
      display: inline-block;
      box-shadow: var(--shadow-s);
    }
  
    /* Marker cluster styling */
    .marker-cluster {
      background-color: rgba(140, 103, 255, 0.6);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
  
    /* Leaflet popup styling */
    .leaflet-popup-content-wrapper {
      background: var(--bg-2);
      color: var(--txt-1);
      border-radius: var(--rad-m);
      padding: 0.5rem;
      box-shadow: var(--shadow-s);
    }
  
    .leaflet-popup-tip {
      background: var(--bg-2);
    }
  
    .leaflet-popup-content {
      margin: 0.5rem;
    }
  
    /* Enhanced review form */
    #cafeReviews {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
  
    .cafe-review-card {
      background: var(--bg-2);
      border-radius: var(--rad-m);
      padding: 1rem;
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }
  
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
  
    .review-body {
      margin-bottom: 0.5rem;
    }
  
    .review-footer {
      font-size: 0.8rem;
      color: var(--txt-2);
    }
    
    /* DataList enhancement */
    #reviewName {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255, 255, 255, 0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 2.5rem;
    }
    nav button.active::after {
      content: '';
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 22px;
      height: 3px;
      background: var(--ac-1);
      border-radius: 5px;
    }
  
    main {
      flex: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
  
    section {
      display: none;
      animation: fade .35s ease-in-out;
    }
    section.active {
      display: block;
    }
  
    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  
    h2.section-title {
      font-size: 1.75rem;
      margin-bottom: 1.4rem;
    }
  
    .card {
      background: var(--bg-2);
      padding: 1.25rem;
      border-radius: var(--rad-m);
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, .05);
      transition: all .3s ease;
      position: relative;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-l);
    }
  
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      border: none;
      cursor: pointer;
      padding: .7rem 1.4rem;
      font-weight: 500;
      border-radius: var(--rad-s);
      box-shadow: 0 2px 6px rgba(0, 0, 0, .2);
      transition: all .2s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, .3);
    }
  
    .btn-primary {
      background: var(--ac-1);
      color: #fff;
    }
    .btn-secondary {
      background: rgba(255, 255, 255, .1);
      color: var(--txt-1);
    }
    .btn-small {
      padding: .3rem .6rem;
      font-size: .8rem;
    }
  
    /* Inputs */
    input,
    textarea,
    select {
      background: var(--bg-3);
      border: 1px solid rgba(255, 255, 255, .1);
      color: var(--txt-1);
      padding: .75rem;
      border-radius: var(--rad-s);
      width: 100%;
      margin-bottom: 1rem;
      transition: border-color .2s ease;
    }
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--ac-1);
    }
  
    /* Quotes */
    #quotes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    #quotes .card {
      font-style: italic;
      text-align: center;
      color: var(--txt-2);
    }
  
    /* Pomodoro Timer */
    #timerDisplay {
      font-size: 2.5rem;
      text-align: center;
      margin: 1rem 0;
    }
    #timerControls {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
  
    /* Tasks Board */
    #tasksBoard {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    .column {
      background: var(--bg-2);
      flex: 1;
      min-width: 240px;
      padding: 1rem;
      border-radius: var(--rad-m);
      position: relative;
    }
    .column h3 {
      margin-bottom: .8rem;
      color: var(--txt-2);
    }
    .task {
      background: var(--bg-3);
      padding: .6rem 1rem;
      border-radius: var(--rad-s);
      margin-bottom: .6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .task-buttons button {
      margin-left: .5rem;
    }
  
    /* Map (Leaflet) */
    #map {
      width: 100%;
      height: 350px;
      border-radius: var(--rad-m);
      margin-bottom: 1rem;
    }
  
    /* Reviews */
    .delete-review {
      position: absolute;
      top: 4px;
      right: 8px;
      cursor: pointer;
      color: var(--ac-warn);
      font-weight: bold;
    }
    .delete-review:hover {
      color: var(--ac-3);
    }
  
    /* Games */
    #gameSelect {
      margin-bottom: 1rem;
    }
    #gameFrame {
      width: 100%;
      height: 80vh;
      border: none;
      border-radius: var(--rad-m);
      margin-top: 1rem;
      box-shadow: var(--shadow-s);
    }
  </style>
</head>
<body>
  <div id="background"></div>
  <header>
    <div class="logo-container"><div class="logo-icon">S</div><span class="logo">StudyBuddy</span></div>
    <nav>
      <button class="active" data-target="dashboard">Dashboard</button>
      <button data-target="cafes">Cafés</button>
      <button data-target="games">Play</button>
      <button data-target="sessions">Sessions</button>
      <button data-target="planner">Planner</button>
    </nav>
  </header>

  <main>
    <!-- Dashboard -->
    <section id="dashboard" class="active">
      <h2 class="section-title">Dashboard</h2>
      <div id="quotes"></div>
      <button id="refreshQuotes" class="btn btn-small btn-primary">Refresh Quotes</button>

      <div class="card">
        <h3>Pomodoro Timer</h3>
        <div id="timerDisplay">25:00</div>
        <div id="timerControls">
          <button id="startTimer" class="btn btn-primary">Start</button>
          <button id="pauseTimer" class="btn btn-secondary">Pause</button>
          <button id="resetTimer" class="btn btn-secondary">Reset</button>
        </div>
      </div>

      <div class="card">
        <h3>Tasks</h3>
        <form id="newTaskForm">
          <input id="newTaskInput" type="text" placeholder="New task… (Enter or click Add)" required/>
          <button type="submit" class="btn btn-primary btn-small">Add</button>
        </form>
        <div id="tasksBoard">
          <div class="column" data-status="todo"><h3>To Do</h3></div>
          <div class="column" data-status="inprogress"><h3>In Progress</h3></div>
          <div class="column" data-status="completed"><h3>Completed</h3></div>
        </div>
      </div>
    </section>

    <!-- Cafés -->
<!-- Cafés -->
<section id="cafes">
  <h2 class="section-title">Study Cafés</h2>
  <div id="map"></div>
  
  <div class="card">
    <h3>Add Café Review</h3>
    <form id="reviewForm">
      <div style="position: relative; grid-column: span 2;">
        <input id="reviewName" list="cafeList" type="text" placeholder="Choose a cafe or type a name..." required/>
        <datalist id="cafeList"></datalist>
      </div>
      <select id="reviewRating" required>
        <option value="">Select Rating...</option>
        <option value="1">★ (Poor)</option>
        <option value="2">★★ (Fair)</option>
        <option value="3">★★★ (Good)</option>
        <option value="4">★★★★ (Very Good)</option>
        <option value="5">★★★★★ (Excellent)</option>
      </select>
      <select id="reviewCategory" required>
        <option value="">Best For...</option>
        <option value="studying">Studying</option>
        <option value="reading">Reading</option>
        <option value="meetings">Meetings</option>
        <option value="relaxing">Relaxing</option>
        <option value="food">Food & Drinks</option>
      </select>
      <textarea id="reviewText" rows="3" placeholder="Share your experience... Were the tables good for studying? How was the WiFi? Was it quiet?" required></textarea>
      <button class="btn btn-primary" type="submit">Save Review</button>
    </form>
  </div>
  
  <div id="cafeReviews"></div>
</section>
    <!-- Games -->
    <section id="games">
      <h2 class="section-title">Take a Break</h2>
      <select id="gameSelect"></select>
      <iframe id="gameFrame"></iframe>
    </section>

    <!-- Sessions -->
    <section id="sessions">
      <h2 class="section-title">Study Sessions</h2>
      <div class="card">
        <h3>New Session</h3>
        <form id="sessionForm" class="grid two-col">
          <div><label>Topic</label><input id="sessionTopic" type="text" required/></div>
          <div><label>Date</label><input id="sessionDate" type="date" required/></div>
          <div><label>Duration</label><input id="sessionDuration" type="number" required/></div>
          <div style="grid-column:1/-1;"><button class="btn btn-primary" type="submit">Add</button></div>
        </form>
      </div>
      <ul id="sessionList"></ul>
    </section>

    <!-- Planner -->
    <section id="planner">
      <h2 class="section-title">Study Planner</h2>
      <div class="card">
        <h3>Add Planner Task</h3>
        <form id="plannerForm">
          <input id="planTitle" type="text" placeholder="Title…" required style="width:48%;display:inline-block;margin-right:2%;"/>
          <select id="planCat" style="width:48%;display:inline-block;" required>
            <option value="">Category…</option><option>Homework</option><option>Reading</option><option>Project</option><option>Review</option>
          </select>
          <textarea id="planDesc" rows="2" placeholder="Description…"></textarea>
          <input id="planDate" type="date" required/>
          <button class="btn btn-primary" type="submit">Add Task</button>
        </form>
      </div>
      <div id="planList"></div>
      <button id="planStudy" class="btn btn-primary">Plan My Study</button>
      <div id="plannerAdvice"></div>
    </section>
  </main>

  <!-- Chat -->
  <button id="chatToggle">💬</button>
  <div id="chatWidget">
    <div id="chatHeader">
      StudyBuddy AI
      <button id="chatClose">✕</button>
    </div>
    <div id="chatBody"></div>
    <form id="chatInput">
      <input type="text" placeholder="Ask a question…" autocomplete="off" required/>
      <button type="submit">➤</button>
    </form>
  </div>

  <!-- Celebration -->
  <div id="celebrationPopup">
    <span class="emoji">🎉</span>
    <h2>Great Job!</h2>
    <p>You've completed a task!</p>
    <button id="closeCelebration">Continue</button>
  </div>

  <script>
    let CONFIG = {};
    async function fetchConfig(){
      try {
        console.log("Fetching config…");
        CONFIG = await (await fetch('/api/config')).json();
        console.log("CONFIG:", CONFIG);
      } catch(e){
        console.error("Config fetch failed", e);
      }
    }

    

    // NAV
    function initNav(){
      document.querySelectorAll('nav button').forEach(btn=>{
        btn.onclick=()=>{
          document.querySelector('nav button.active').classList.remove('active');
          btn.classList.add('active');
          document.querySelector('section.active').classList.remove('active');
          document.getElementById(btn.dataset.target).classList.add('active');
        };
      });
    }

    // Update the main initialization to incorporate our enhanced components
document.addEventListener('DOMContentLoaded', async () => {
  // Initialize background effect
  VANTA.DOTS({
    el: '#background',
    mouseControls: true,
    touchControls: true,
    gyroControls: false,
    minHeight: 200,
    minWidth: 200,
    scale: 1,
    scaleMobile: 1,
    color: 0x8c67ff,
    color2: 0x4f46e5,
    backgroundColor: 0x121212,
    size: 3,
    spacing: 25,
    showLines: false
  });
  
  // Fetch configuration
  await fetchConfig();
  
  // Initialize all components with enhanced versions
  initNav();
  initQuotes();
  initPomodoro();
  initTasks();
  initCafe(); // Enhanced cafe map functionality
  initGames();
  initSessions();
  initPlanner(); // Enhanced planner functionality
  initChat();
  
  // Add responsive improvements
  makeResponsive();
});

// Add some additional responsive improvements
function makeResponsive() {
  // Handle mobile screens better
  function adjustForScreenSize() {
    const isMobile = window.innerWidth < 768;
    
    // Adjust map height based on screen size
    const mapEl = document.getElementById('map');
    if (mapEl) {
      mapEl.style.height = isMobile ? '350px' : '500px';
    }
    
    // Adjust review form layout
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
      reviewForm.style.display = isMobile ? 'block' : 'grid';
    }
    
    // Force map to redraw if it exists
    if (window.leafletMap) {
      setTimeout(() => window.leafletMap.invalidateSize(), 100);
    }
  }
  
  // Call immediately and on resize
  adjustForScreenSize();
  window.addEventListener('resize', adjustForScreenSize);
  
  // Improve touch handling for draggable items
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  if (isTouchDevice) {
    document.documentElement.classList.add('touch-device');
    
    // Add hint for touch users on task cards
    const taskBoard = document.getElementById('tasksBoard');
    if (taskBoard) {
      const hint = document.createElement('div');
      hint.style.cssText = 'font-size:0.8rem;color:var(--txt-2);margin-bottom:10px;text-align:center;';
      hint.textContent = 'Tap tasks to see options';
      taskBoard.parentNode.insertBefore(hint, taskBoard);
    }
  }
}

// Add better error handling for the app overall
window.addEventListener('error', function(e) {
  console.error("Application error:", e);
  
  // Don't show errors for expected issues
  if (e.message && (
      e.message.includes('ResizeObserver loop') || 
      e.message.includes('Script error') ||
      e.message.includes('Uncaught'))) {
    return;
  }
  
  // Show a user-friendly error message
  const errorDiv = document.createElement('div');
  errorDiv.style.cssText = 'position:fixed;bottom:20px;left:20px;background:rgba(255,100,100,0.9);color:white;' +
                          'padding:10px 20px;border-radius:4px;font-size:14px;z-index:10000;max-width:80%;' +
                          'box-shadow:0 4px 12px rgba(0,0,0,0.3);';
  errorDiv.innerHTML = 'Something went wrong. <button id="errorDismiss" style="background:rgba(255,255,255,0.3);border:none;color:white;padding:3px 8px;border-radius:3px;cursor:pointer;margin-left:10px;">Dismiss</button>';
  document.body.appendChild(errorDiv);
  
  document.getElementById('errorDismiss').addEventListener('click', function() {
    errorDiv.remove();
  });
  
  // Auto-remove after 8 seconds
  setTimeout(() => {
    if (document.body.contains(errorDiv)) {
      errorDiv.remove();
    }
  }, 8000);
});

// Add this to ensure Leaflet loads properly
document.addEventListener('DOMContentLoaded', function() {
  // Ensure Leaflet has loaded
  if (typeof L === 'undefined') {
    // Try to load Leaflet dynamically if not available
    const leafletCss = document.createElement('link');
    leafletCss.rel = 'stylesheet';
    leafletCss.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(leafletCss);
    
    const leafletScript = document.createElement('script');
    leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    document.head.appendChild(leafletScript);
    
    leafletScript.onload = function() {
      console.log('Leaflet loaded dynamically');
      // Initialize cafe maps after Leaflet loads
      if (typeof initCafe === 'function') {
        initCafe();
      }
    };
  }
  
  // Add marker clustering library
  if (typeof L !== 'undefined' && typeof L.markerClusterGroup === 'undefined') {
    const clusterScript = document.createElement('script');
    clusterScript.src = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js';
    document.head.appendChild(clusterScript);
    
    const clusterCss = document.createElement('link');
    clusterCss.rel = 'stylesheet';
    clusterCss.href = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css';
    document.head.appendChild(clusterCss);
    
    const clusterDefaultCss = document.createElement('link');
    clusterDefaultCss.rel = 'stylesheet';
    clusterDefaultCss.href = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css';
    document.head.appendChild(clusterDefaultCss);
  }
});

    // QUOTES
    const quotesList = ["Start where you are.","Progress over perfection.","One step at a time.","Dream, believe, do.","Focus and win.","Every day is a second chance.","Small progress is progress.","Stay positive.","Believe you can.","Do it now.","Keep pushing.","Consistency is key.","Success is a journey.","You got this.","Make today count."];
    function renderQuotes(){
      const c=document.getElementById('quotes');c.innerHTML='';
      quotesList.sort(()=>0.5-Math.random()).slice(0,3).forEach(q=>{
        const d=document.createElement('div');d.className='card';d.textContent=`"${q}"`;c.append(d);
      });
    }
    function initQuotes(){
      renderQuotes();
      document.getElementById('refreshQuotes').onclick=renderQuotes;
    }

    // POMODORO
    let pomTime=25*60, pomInterval, pomRunning=false;
    function updatePom(){
      const m=String(Math.floor(pomTime/60)).padStart(2,'0'),
            s=String(pomTime%60).padStart(2,'0');
      document.getElementById('timerDisplay').textContent=`${m}:${s}`;
      document.title=`(${m}:${s}) StudyBuddy`;
    }
    function initPomodoro(){
      updatePom();
      document.getElementById('startTimer').onclick=()=>{
        if(pomRunning) return;
        pomRunning=true;
        pomInterval=setInterval(()=>{
          if(pomTime>0){pomTime--;updatePom();}
          else{clearInterval(pomInterval);pomRunning=false;confetti({particleCount:100,spread:70,origin:{y:0.6}});alert('Done!');document.title='StudyBuddy';}
        },1000);
      };
      document.getElementById('pauseTimer').onclick=()=>{clearInterval(pomInterval);pomRunning=false;};
      document.getElementById('resetTimer').onclick=()=>{clearInterval(pomInterval);pomRunning=false;pomTime=25*60;updatePom();};
    }

    // TASKS
    function getTasks(){
      let raw;
      try{ raw=JSON.parse(localStorage.getItem('sb-tasks')); }
      catch(e){ raw=null; console.warn("Invalid tasks data",e); }
      let t;
      if(Array.isArray(raw)){
        console.log("Legacy task-array found, migrating");
        t={todo:raw, inprogress:[], completed:[]};
      } else if(raw && typeof raw==='object'){
        t=raw;
      } else {
        t={todo:[],inprogress:[],completed:[]};
      }
      t.todo  = Array.isArray(t.todo) ? t.todo : [];
      t.inprogress = Array.isArray(t.inprogress) ? t.inprogress : [];
      t.completed  = Array.isArray(t.completed) ? t.completed : [];
      console.log("Loaded tasks:", t);
      return t;
    }
    function saveTasks(t){
      console.log("Saving tasks:", t);
      localStorage.setItem('sb-tasks',JSON.stringify(t));
    }
    function renderTasks(){
      const all=getTasks();
      ['todo','inprogress','completed'].forEach(status=>{
        const col=document.querySelector(`.column[data-status="${status}"]`);
        const title=col.querySelector('h3').textContent;
        col.innerHTML=`<h3>${title}</h3>`;
        all[status].forEach((txt,i)=>{
          const task=document.createElement('div');task.className='task';
          task.innerHTML=`
            <span>${txt}</span>
            <div class="task-buttons">
              ${status==='todo'?`<button data-action="start" data-index="${i}" class="btn btn-small btn-primary">Start</button>`:''}
              ${status==='inprogress'?`<button data-action="complete" data-index="${i}" class="btn btn-small btn-primary">Complete</button>`:''}
              <button data-action="delete" data-status="${status}" data-index="${i}" class="btn btn-small btn-secondary">×</button>
            </div>
          `;
          col.append(task);
        });
      });
    }
    function initTasks(){
      console.log("initTasks()");
      document.getElementById('newTaskForm').addEventListener('submit',e=>{
        e.preventDefault();
        const v=document.getElementById('newTaskInput').value.trim();
        console.log("Adding task:",v);
        if(!v) return;
        const all=getTasks();
        all.todo.push(v);
        saveTasks(all);
        renderTasks();
        e.target.reset();
      });
      document.getElementById('tasksBoard').addEventListener('click',e=>{
        const btn=e.target.closest('button[data-action]');
        if(!btn) return;
        const action=btn.dataset.action;
        const all=getTasks();
        console.log("Task action:",action,btn.dataset);
        if(action==='delete'){
          all[btn.dataset.status].splice(+btn.dataset.index,1);
        }
        if(action==='start'){
          const [t]=all.todo.splice(+btn.dataset.index,1);
          all.inprogress.push(t);
        }
        if(action==='complete'){
          const [t]=all.inprogress.splice(+btn.dataset.index,1);
          all.completed.push(t);
          confetti({particleCount:100,spread:70,origin:{y:0.6}});
          document.getElementById('celebrationPopup').style.display='block';
          setTimeout(()=>document.getElementById('celebrationPopup').style.display='none',3000);
        }
        saveTasks(all);
        renderTasks();
      });
      renderTasks();
      document.getElementById('closeCelebration').onclick=()=>{
        document.getElementById('celebrationPopup').style.display='none';
      };
    }
    
  
    // on DOMContentLoaded include initCafe
    document.addEventListener('DOMContentLoaded', function() {
      initCafe();
    });
    function startMap(pos){
      console.log("startMap at",pos);
      const mp=new google.maps.Map(document.getElementById('map'),{center:pos,zoom:14});
      new google.maps.Marker({map:mp,position:pos,title:'You'});
      const svc=new google.maps.places.PlacesService(mp);
      svc.nearbySearch({location:pos,radius:1500,type:['cafe']},(res,st)=>{
        console.log("PlacesService:",st,res);
        if(st==='OK')res.forEach(p=>new google.maps.Marker({map:mp,position:p.geometry.location,title:p.name}));
      });
    }
// Replace the entire initCafe function with this improved version
// Enhanced Cafe Map with Real Cafes and Better Performance
// Fixed Cafe Map Implementation with REAL cafe data only - No simulated cafes
// DIRECT REPLACEMENT FOR CAFE MAP IMPLEMENTATION
function initCafe() {
  console.log("Initializing cafe map with direct implementation");
  
  // Cache DOM elements
  const mapContainer = document.getElementById('map');
  const cafeList = document.getElementById('cafeList');
  const reviewForm = document.getElementById('reviewForm');
  const reviewName = document.getElementById('reviewName');
  
  // Map globals
  let map, cafeMarkers = [], allCafes = [];
  
  // Make sure map container exists
  if (!mapContainer) {
    console.error("Map container not found!");
    return;
  }
  
  // Make map container bigger
  mapContainer.style.height = '600px';
  
  // Clear any existing map
  if (window.leafletMap) {
    window.leafletMap.remove();
    window.leafletMap = null;
  }
  
  // Show loading indicator
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'map-loading';
  loadingDiv.innerHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;background:rgba(30,30,30,0.8);padding:15px 25px;border-radius:8px;text-align:center;">Loading map...</div>';
  mapContainer.appendChild(loadingDiv);
  
  // Get user location
  navigator.geolocation.getCurrentPosition(
    // Success callback
    position => {
      setupMap(position.coords.latitude, position.coords.longitude);
    },
    // Error callback
    error => {
      console.warn("Geolocation error:", error);
      // Default to a central location
      setupMap(40.7128, -74.0060); // New York
    },
    { timeout: 10000 }
  );
  
  // Set up the map
  function setupMap(lat, lng) {
    console.log("Setting up map at:", lat, lng);
    
    try {
      // Initialize the map
      map = L.map('map', {
        center: [lat, lng],
        zoom: 14,
        zoomControl: true
      });
      
      window.leafletMap = map;
      
      // Add a tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);
      
      // Add user location marker - using SIMPLE CIRCLE
      const userCircle = L.circle([lat, lng], {
        radius: 300,
        color: '#4f46e5',
        fillColor: '#4f46e5',
        fillOpacity: 0.4
      }).addTo(map);
      
      userCircle.bindPopup("You are here").openPopup();
      
      // Add search radius visualization
      const searchRadius = L.circle([lat, lng], {
        radius: 2000,
        color: '#8c67ff',
        fillColor: '#8c67ff',
        fillOpacity: 0.05,
        weight: 1
      }).addTo(map);
      
      // Add simple filter control
      const filterControl = L.Control.extend({
        options: { position: 'topright' },
        onAdd: function() {
          const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control filter-control');
          container.innerHTML = `
            <div style="background:#1e1e1e;padding:8px;border-radius:4px;">
              <label style="display:block;margin-bottom:5px;font-size:12px;color:#b0b0b0;">Filter By</label>
              <select id="cafe-filter" style="width:100%;padding:5px;background:#2d2d2d;color:#fafafa;border:1px solid rgba(255,255,255,0.1);border-radius:3px;">
                <option value="all">All Places</option>
                <option value="cafe">Cafés</option>
                <option value="library">Libraries</option>
                <option value="restaurant">Restaurants</option>
              </select>
            </div>
          `;
          
          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.disableScrollPropagation(container);
          
          return container;
        }
      });
      
      // Add control to map
      map.addControl(new filterControl());
      
      // Fetch real cafes
      fetchCafes(lat, lng, 2000);
      
      // Add reload button
      const reloadBtn = document.createElement('button');
      reloadBtn.style.cssText = `
        position: absolute;
        bottom: 10px;
        right: 10px;
        z-index: 999;
        background: #8c67ff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
      `;
      reloadBtn.textContent = "Reload Map";
      reloadBtn.onclick = function() {
        window.location.reload();
      };
      mapContainer.appendChild(reloadBtn);
      
      // Add event listener for filter control
      setTimeout(() => {
        const filterSelect = document.getElementById('cafe-filter');
        if (filterSelect) {
          filterSelect.addEventListener('change', function() {
            const value = this.value;
            cafeMarkers.forEach(marker => {
              if (value === 'all' || marker.options.cafeType === value) {
                marker.setOpacity(1);
              } else {
                marker.setOpacity(0.3);
              }
            });
          });
        }
      }, 300);
      
    } catch (err) {
      console.error("Map setup error:", err);
      mapContainer.innerHTML = `
        <div style="text-align:center;padding:20px;background:#222;color:white;border-radius:8px;">
          <h3>Map Error</h3>
          <p>There was a problem loading the map. Please try reloading the page.</p>
          <button onclick="window.location.reload()" style="background:#8c67ff;color:white;border:none;padding:8px 16px;border-radius:4px;margin-top:10px;cursor:pointer;">
            Reload Page
          </button>
        </div>
      `;
    }
  }
  
  // Fetch cafes using OpenStreetMap's Overpass API
  function fetchCafes(lat, lng, radius = 2000) {
    // Show loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'cafes-loading';
    loadingDiv.innerHTML = `
      <div style="position:absolute;top:60px;right:10px;z-index:1000;background:rgba(30,30,30,0.8);
           padding:8px 12px;border-radius:4px;font-size:12px;color:#fafafa;">
        Finding cafes...
      </div>
    `;
    mapContainer.appendChild(loadingDiv);
    
    // Create query for OpenStreetMap
    const query = `
      [out:json][timeout:25];
      (
        node["amenity"="cafe"](around:${radius},${lat},${lng});
        node["amenity"="library"](around:${radius},${lat},${lng});
        node["shop"="coffee"](around:${radius},${lat},${lng});
        node["amenity"="restaurant"]["cuisine"="coffee_shop"](around:${radius},${lat},${lng});
      );
      out body;
    `;
    
    // Use fetch to get data
    fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: 'data=' + encodeURIComponent(query)
    })
    .then(response => response.json())
    .then(data => {
      // Remove loading indicator
      document.getElementById('cafes-loading')?.remove();
      document.getElementById('map-loading')?.remove();
      
      if (data && data.elements && data.elements.length > 0) {
        console.log(`Found ${data.elements.length} cafes`);
        
        // Process cafe data
        processCafes(data.elements);
      } else {
        console.log("No cafes found");
        mapContainer.insertAdjacentHTML('beforeend', `
          <div style="position:absolute;bottom:50px;left:50%;transform:translateX(-50%);z-index:999;background:rgba(30,30,30,0.8);
               color:white;padding:10px 20px;border-radius:4px;text-align:center;">
            No cafes found in this area. Try a different location.
          </div>
        `);
      }
    })
    .catch(error => {
      console.error("Fetch error:", error);
      document.getElementById('cafes-loading')?.remove();
      document.getElementById('map-loading')?.remove();
      
      // Show error message
      mapContainer.insertAdjacentHTML('beforeend', `
        <div style="position:absolute;bottom:50px;left:50%;transform:translateX(-50%);z-index:999;background:rgba(255,0,0,0.8);
             color:white;padding:10px 20px;border-radius:4px;text-align:center;">
          Error fetching cafe data. Please reload and try again.
        </div>
      `);
    });
  }
  
  // Process cafe data and add to map
  function processCafes(elements) {
    // Filter only nodes with tags
    const validNodes = elements.filter(el => el.type === 'node' && el.tags);
    
    if (validNodes.length === 0) {
      console.log("No valid cafes found");
      return;
    }
    
    // Define colors for different place types
    const colors = {
      cafe: '#8c67ff',
      library: '#4f46e5',
      restaurant: '#f59e0b',
      default: '#8c67ff'
    };
    
    // Process each valid node
    validNodes.forEach(node => {
      // Determine place type
      let placeType = 'default';
      
      if (node.tags.amenity === 'cafe' || node.tags.shop === 'coffee') {
        placeType = 'cafe';
      } else if (node.tags.amenity === 'library') {
        placeType = 'library';
      } else if (node.tags.amenity === 'restaurant') {
        placeType = 'restaurant';
      }
      
      // Get place name
      const placeName = node.tags.name || `Cafe #${node.id.toString().slice(-4)}`;
      
      // Create cafe object
      const place = {
        id: node.id,
        name: placeName,
        lat: node.lat,
        lng: node.lon,
        type: placeType,
        address: formatAddress(node.tags)
      };
      
      // Add to cafes array
      allCafes.push(place);
      
      // Create marker - using circleMarker for reliability
      const marker = L.circleMarker([place.lat, place.lng], {
        radius: 8,
        color: colors[placeType],
        fillColor: colors[placeType],
        fillOpacity: 0.8,
        weight: 2,
        cafeType: placeType
      }).addTo(map);
      
      // Create popup content
      const popupContent = `
        <div style="width:200px;">
          <h3 style="margin:0 0 8px;color:${colors[placeType]};font-size:16px;">${place.name}</h3>
          <div style="margin:5px 0;font-size:12px;">
            <strong>Type:</strong> ${placeType === 'cafe' ? 'Café' : (placeType === 'library' ? 'Library' : 'Restaurant')}
          </div>
          ${place.address !== 'Address not available' ? `
            <div style="margin:5px 0;font-size:12px;">
              <strong>Address:</strong> ${place.address}
            </div>
          ` : ''}
          <button onclick="selectCafeForReview('${place.name.replace(/'/g, "\\'")}')" 
            style="width:100%;margin-top:8px;background:${colors[placeType]};color:white;border:none;padding:6px;border-radius:4px;cursor:pointer;">
            Add Review
          </button>
        </div>
      `;
      
      // Add popup
      marker.bindPopup(popupContent);
      
      // Add to markers array
      cafeMarkers.push(marker);
    });
    
    // Update cafe list for the review form
    updateCafeList();
  }
  
  // Format address from OSM tags
  function formatAddress(tags) {
    const parts = [];
    
    if (tags['addr:housenumber']) parts.push(tags['addr:housenumber']);
    if (tags['addr:street']) parts.push(tags['addr:street']);
    if (tags['addr:city']) parts.push(tags['addr:city']);
    if (tags['addr:postcode']) parts.push(tags['addr:postcode']);
    
    return parts.join(', ') || 'Address not available';
  }
  
  // Update cafe list for dropdown
  function updateCafeList() {
    if (!cafeList) return;
    
    // Clear existing options
    cafeList.innerHTML = '';
    
    // Sort cafes alphabetically
    const sortedCafes = [...allCafes].sort((a, b) => a.name.localeCompare(b.name));
    
    // Add to datalist
    sortedCafes.forEach(cafe => {
      const option = document.createElement('option');
      option.value = cafe.name;
      cafeList.appendChild(option);
    });
  }
  
  // Global cafe selection function
  window.selectCafeForReview = function(cafeName) {
    if (reviewName) {
      reviewName.value = cafeName;
      
      // Scroll to review form
      reviewForm.scrollIntoView({ behavior: 'smooth' });
      
      // Focus rating dropdown
      setTimeout(() => {
        document.getElementById('reviewRating')?.focus();
      }, 300);
    }
  };
  
  // Fix review form submission
  if (reviewForm) {
    // Clear existing handlers
    const oldSubmit = reviewForm.onsubmit;
    reviewForm.onsubmit = null;
    
    // Add new submit handler
    reviewForm.addEventListener('submit', function(e) {
      e.preventDefault();
      console.log("Review form submitted");
      
      // Get form values
      const name = reviewName?.value || '';
      const rating = document.getElementById('reviewRating')?.value || '';
      const category = document.getElementById('reviewCategory')?.value || '';
      const text = document.getElementById('reviewText')?.value || '';
      
      console.log("Review values:", {name, rating, category, text});
      
      // Only validate the ones that exist to avoid errors
      if (!name.trim()) {
        alert("Please enter or select a cafe name");
        return;
      }
      
      if (!rating) {
        alert("Please select a rating");
        return;
      }
      
      if (!category) {
        alert("Please select a category");
        return;
      }
      
      if (!text.trim()) {
        alert("Please enter a review");
        return;
      }
      
      // Get existing reviews
      let reviews = [];
      try {
        reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
      } catch (e) {
        console.error("Error parsing reviews:", e);
        reviews = [];
      }
      
      // Add new review
      reviews.push({
        name: name.trim(),
        rating: parseInt(rating),
        category: category,
        text: text.trim(),
        date: new Date().toISOString().split('T')[0]
      });
      
      // Save to localStorage
      localStorage.setItem('sb-reviews', JSON.stringify(reviews));
      
      // Reset form
      this.reset();
      
      // Show success message
      alert("Review added successfully!");
      
      // Update reviews display if function exists
      if (typeof renderReviews === 'function') {
        renderReviews();
      }
    });
  }
}

// Call this function instead of the original initCafe
document.addEventListener('DOMContentLoaded', function() {
  // Ensure Leaflet is loaded
  if (typeof L === 'undefined') {
    // Load Leaflet CSS
    const leafletCSS = document.createElement('link');
    leafletCSS.rel = 'stylesheet';
    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(leafletCSS);
    
    // Load Leaflet JS
    const leafletScript = document.createElement('script');
    leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    leafletScript.onload = function() {
      console.log("Leaflet loaded, initializing cafe map");
      initCafe();
    };
    document.head.appendChild(leafletScript);
  } else {
    initCafe();
  }
});

// Add this function to make "selectCafeForReview" globally available
window.selectCafeForReview = function(cafeName) {
  const reviewName = document.getElementById('reviewName');
  const reviewForm = document.getElementById('reviewForm');
  
  if (reviewName && reviewForm) {
    reviewName.value = cafeName;
    reviewForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => {
      document.getElementById('reviewRating').focus();
    }, 500);
  }
};

    // GAMES
    function initGames(){
      const sel=document.getElementById('gameSelect');
      const games=[
      ['Wordle Clone', 'https://wordlegame.org/'],
    ['Hangman',      'https://hangmanwordgame.com/'],
      ['Flappy Bird',         'https://flappybird.io/'],
      ['Minesweeper',         'https://kamoroso94.github.io/minesweeper/'],      // :contentReference[oaicite:0]{index=0}
      ['Sudoku',           'https://sudoku.com/'],
      ['Connect Four',        'https://torikul007.github.io/Connect_Four/']       // :contentReference[oaicite:1]{index=1}
      ];
      games.forEach(g=>{
        const o=document.createElement('option');
        o.value=g[1]; o.textContent=g[0];
        sel.append(o);
      });
      sel.onchange=()=>document.getElementById('gameFrame').src=sel.value;
      sel.dispatchEvent(new Event('change'));
    }

    // SESSIONS
    function initSessions(){
      const getS=()=>JSON.parse(localStorage.getItem('sb-sessions')||'[]');
      const saveS=a=>localStorage.setItem('sb-sessions',JSON.stringify(a));
      const renderS=()=>{
        const ul=document.getElementById('sessionList'),a=getS();
        ul.innerHTML='';
        if(!a.length){ul.innerHTML='<li class="card">No sessions.</li>';return;}
        a.forEach((s,i)=>{
          const li=document.createElement('li');li.className='card';li.style.marginBottom='.6rem';
          li.innerHTML=`<strong>${s.topic}</strong> ${s.date} — ${s.duration} min
            <button class="btn btn-small btn-secondary" onclick="(()=>{
              const arr=getS();arr.splice(${i},1);saveS(arr);renderS();
            })()">Delete</button>`;
          ul.append(li);
        });
      };
      document.getElementById('sessionForm').addEventListener('submit',e=>{
        e.preventDefault();
        const arr=getS();
        arr.push({
          topic:document.getElementById('sessionTopic').value,
          date:document.getElementById('sessionDate').value,
          duration:+document.getElementById('sessionDuration').value
        });
        saveS(arr);renderS();e.target.reset();
      });
      renderS();
    }

    // PLANNER
// PLANNER - Enhanced with better formatting
// Enhanced Planner with beautiful formatting
// DIRECT REPLACEMENT FOR PLANNER IMPLEMENTATION
function initPlanner() {
  console.log("Initializing enhanced planner");
  
  // Helper functions to get and save plans
  const getP = () => JSON.parse(localStorage.getItem('sb-plans') || '[]');
  const saveP = a => localStorage.setItem('sb-plans', JSON.stringify(a));
  
  // Render plans with improved UI
  const renderP = () => {
    const wrap = document.getElementById('planList');
    if (!wrap) return;
    
    const plans = getP();
    wrap.innerHTML = '';
    
    // Sort plans by date
    plans.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    plans.forEach((p, i) => {
      const c = document.createElement('div');
      c.className = 'card';
      
      // Format date nicely
      const formattedDate = new Date(p.date).toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'short',
        day: 'numeric'
      });
      
      // Associate emojis with categories
      const categoryEmojis = {
        'Homework': '📝',
        'Reading': '📚',
        'Project': '🛠️',
        'Review': '🔍',
        'Exam': '📊',
        'Essay': '✍️',
        'Presentation': '🎯',
        'Research': '🔬',
        'Lab': '🧪',
        'Other': '📌'
      };
      
      const emoji = categoryEmojis[p.category] || '📌';
      
      c.innerHTML = `
        <h4 style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <span style="font-size:1.4em;">${emoji}</span>
          <span>${p.title}</span>
        </h4>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <small style="background:rgba(140,103,255,0.2); padding:3px 10px; border-radius:12px;">
            ${p.category}
          </small>
          <small style="color:var(--txt-2);">
            <span style="margin-right:5px;">📅</span>${formattedDate}
          </small>
        </div>
        <p style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px; margin-top:5px;">${p.desc}</p>
        <button class="delete-plan" data-index="${i}" style="position:absolute;top:10px;right:10px;background:none;border:none;color:var(--ac-warn);font-weight:bold;font-size:1.2rem;cursor:pointer;">×</button>
      `;
      wrap.append(c);
    });
    
    wrap.querySelectorAll('.delete-plan').forEach(btn => {
      btn.onclick = () => {
        const arr = getP();
        arr.splice(+btn.dataset.index, 1);
        saveP(arr);
        renderP();
      };
    });
  };
  
  // Set up planner form
  const plannerForm = document.getElementById('plannerForm');
  if (plannerForm) {
    // Remove any existing handlers
    plannerForm.onsubmit = null;
    
    // Add new submit handler
    plannerForm.addEventListener('submit', e => {
      e.preventDefault();
      
      const title = document.getElementById('planTitle')?.value?.trim() || '';
      const category = document.getElementById('planCat')?.value || '';
      const desc = document.getElementById('planDesc')?.value?.trim() || '';
      const date = document.getElementById('planDate')?.value || '';
      
      console.log("Plan values:", {title, category, desc, date});
      
      // Basic validation
      if (!title) {
        alert("Please enter a title");
        return;
      }
      
      if (!category) {
        alert("Please select a category");
        return;
      }
      
      if (!date) {
        alert("Please select a date");
        return;
      }
      
      const arr = getP();
      arr.push({
        title: title,
        category: category,
        desc: desc,
        date: date
      });
      
      saveP(arr);
      renderP();
      e.target.reset();
      
      // Show success message
      alert("Task added successfully!");
    });
  }
  
  // Enhanced study plan generation
  const planStudyBtn = document.getElementById('planStudy');
  if (planStudyBtn) {
    planStudyBtn.onclick = async () => {
      const tasks = getP();
      const plannerAdvice = document.getElementById('plannerAdvice');
      if (!plannerAdvice) return;
      
      if (!tasks.length) {
        plannerAdvice.innerHTML = "<div style='text-align:center;padding:20px;'>Please add some tasks first.</div>";
        return;
      }
      
      // Show loading state
      plannerAdvice.innerHTML = `
        <div style='text-align:center;padding:20px;'>
          <div style='display:inline-block;width:30px;height:30px;border:3px solid rgba(140,103,255,0.3);
            border-radius:50%;border-top-color:var(--ac-1);animation:spin 1s linear infinite;'></div>
          <p style='margin-top:10px;'>Generating your personalized study plan...</p>
        </div>
        <style>
          @keyframes spin { to { transform: rotate(360deg); } }
        </style>
      `;
      
      // Sort tasks by date
      tasks.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      const today = new Date();
      const formattedToday = today.toISOString().split('T')[0];
      
      // Create a detailed request for better response
      const msg = `I have these academic tasks:\n${tasks.map(t => 
        `- ${t.title} (${t.category}), due ${t.date}: ${t.desc}`
      ).join('\n')}\n\nToday is ${formattedToday}. Please give me a detailed day-by-day study plan that's optimized for productivity and learning. For each day, suggest specific time blocks, study techniques, and breaks. Use emojis and clear formatting.`;
      
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({message: msg})
        });
        
        const data = await res.json();
        let studyPlan = data.reply || 'No advice available.';
        
        // Create a beautifully styled container for the plan
        const styledPlan = document.createElement('div');
        styledPlan.style.cssText = 'max-height:500px;overflow-y:auto;padding:20px;background:var(--bg-2);border-radius:var(--rad-m);margin-top:20px;border:1px solid rgba(255,255,255,0.05);box-shadow:var(--shadow-s);';
        
        // Add CSS styles for the plan
        const styleElement = document.createElement('style');
        styleElement.textContent = `
          .study-plan-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--ac-1);
            font-size: 1.5rem;
          }
          
          .day-header {
            margin-top: 20px;
            margin-bottom: 15px;
            color: var(--ac-1);
            border-bottom: 1px solid var(--ac-1);
            padding-bottom: 5px;
            font-size: 1.2rem;
          }
          
          .time-block {
            background: rgba(140,103,255,0.2);
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: bold;
            margin-right: 5px;
            font-size: 0.9rem;
          }
          
          .task-item {
            display: flex;
            margin: 8px 0;
            line-height: 1.5;
          }
          
          .bullet {
            margin-right: 10px;
            color: var(--ac-1);
          }
          
          .study-plan-content strong {
            color: var(--ac-1);
          }
          
          .study-tip {
            background: rgba(255,111,145,0.1);
            padding: 10px 15px;
            border-radius: var(--rad-s);
            margin: 12px 0;
            border-left: 3px solid var(--ac-3);
          }
          
          .tip-label {
            color: var(--ac-3);
            font-weight: bold;
          }
          
          .download-button {
            display: block;
            margin: 20px auto 10px;
            background: var(--ac-1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--rad-s);
            cursor: pointer;
            transition: all 0.2s ease;
          }
          
          .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          }
        `;
        styledPlan.appendChild(styleElement);
        
        // Add title
        const title = document.createElement('h2');
        title.className = 'study-plan-title';
        title.innerHTML = '✨ Your Personalized Study Plan ✨';
        styledPlan.appendChild(title);
        
        // Create content container with enhanced formatting
        const content = document.createElement('div');
        content.className = 'study-plan-content';
        
        // Process and enhance the study plan text with formatting
        let enhancedPlan = studyPlan
          // Format day headers
          .replace(/(?:^|\n)(?:\*\*)?(?:📅\s*)?(?:Day \d+:)?\s*([A-Za-z]+day),?\s*([A-Za-z]+ \d+(?:st|nd|rd|th)?)(?:\*\*)?/g, 
            '<div class="day-header"><h3>📅 $1, $2</h3></div>')
          
          // Format time blocks
          .replace(/(\d{1,2}:\d{2}\s*(?:AM|PM|am|pm)\s*[-–—]\s*\d{1,2}:\d{2}\s*(?:AM|PM|am|pm))/g, 
            '<span class="time-block">⏰ $1</span>')
          
          // Format task names
          .replace(/(?:\*\*)([^*]+?)(?:\*\*)/g, '<strong>$1</strong>')
          
          // Format bullet points
          .replace(/^\s*[-•*]\s+(.+)$/gm, '<div class="task-item"><span class="bullet">•</span><span>$1</span></div>')
          
          // Format technique suggestions
          .replace(/(Technique|Tip|Method|Strategy):\s*([^.!?]+[.!?])/g, 
            '<div class="study-tip"><span class="tip-label">$1:</span> $2</div>');
        
        content.innerHTML = enhancedPlan;
        styledPlan.appendChild(content);
        
        // Add download button
        const downloadButton = document.createElement('button');
        downloadButton.className = 'download-button';
        downloadButton.innerHTML = '📥 Download Study Plan';
        downloadButton.onclick = function() {
          // Clean up the plan text
          const planText = studyPlan
            .replace(/\*\*/g, '')
            .replace(/\[/g, '')
            .replace(/\]/g, '');
          
          // Create and download a text file
          const blob = new Blob(['# My StudyBuddy Plan\n\n' + planText], {type: 'text/plain'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'StudyPlan.txt';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };
        styledPlan.appendChild(downloadButton);
        
        // Add the styled plan to the page
        plannerAdvice.innerHTML = '';
        plannerAdvice.appendChild(styledPlan);
        
      } catch (error) {
        console.error("Plan generation error:", error);
        plannerAdvice.innerHTML = `
          <div style="padding:15px;background:rgba(255,100,100,0.1);border-radius:var(--rad-s);color:#ff6464;">
            <p>😔 Sorry, there was an error generating your study plan. Please try again later.</p>
            <button onclick="document.getElementById('planStudy').click()" 
                    style="background:rgba(255,255,255,0.2);border:none;color:white;padding:5px 15px;border-radius:4px;margin-top:10px;cursor:pointer;">
              Try Again
            </button>
          </div>`;
      }
    };
  }
  
  // Add category options programmatically
  const categorySelect = document.getElementById('planCat');
  if (categorySelect && categorySelect.options.length <= 2) {
    const categories = ['Homework', 'Reading', 'Project', 'Review', 'Exam', 'Essay', 'Presentation', 'Research', 'Lab', 'Other'];
    categorySelect.innerHTML = '<option value="">Category…</option>';
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
    });
  }
  
  // Add custom CSS for better styling
  const styleElement = document.createElement('style');
  styleElement.textContent = `
    /* Add styling for the planner */
    #planList .card {
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      margin-bottom: 1rem;
    }
    
    #planList .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, var(--ac-1), var(--ac-3));
      border-radius: var(--rad-s) 0 0 var(--rad-s);
    }
    
    #planList .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-l);
    }
    
    #plannerForm {
      background: var(--bg-3);
      padding: 1.5rem;
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    #planStudy {
      background: linear-gradient(135deg, var(--ac-1), var(--ac-2));
      padding: 0.8rem 1.6rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }
    
    #planStudy:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(140, 103, 255, 0.3);
    }
  `;
  document.head.appendChild(styleElement);
  
  // Initialize UI
  renderP();
}

// Call the planner initialization
document.addEventListener('DOMContentLoaded', function() {
  // Initialize enhanced planner
  initPlanner();
});

// Complete Integration and Fixes
// This script should be loaded after the original StudyBuddy scripts
// It will fix both the review form validation and maps functionality

document.addEventListener('DOMContentLoaded', function() {
  console.log("StudyBuddy enhancements loading...");
  
  // Add Leaflet CSS if not already present
  if (!document.querySelector('link[href*="leaflet.css"]')) {
    const leafletCSS = document.createElement('link');
    leafletCSS.rel = 'stylesheet';
    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(leafletCSS);
  }
  
  // Add global CSS fixes
  const globalStyles = document.createElement('style');
  globalStyles.textContent = `
    /* Map fixes */
    #map {
      width: 100%;
      height: 600px !important; /* Force taller map */
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-s);
      position: relative;
      z-index: 1;
    }
    
    /* Leaflet customizations */
    .leaflet-container {
      background: #1e1e1e;
      font-family: 'Inter', sans-serif;
    }
    
    .leaflet-popup-content-wrapper {
      background: var(--bg-2);
      color: var(--txt-1);
      border-radius: var(--rad-m);
      padding: 0;
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .leaflet-popup-tip {
      background: var(--bg-2);
      box-shadow: var(--shadow-s);
    }
    
    .leaflet-popup-content {
      margin: 8px;
      width: auto !important;
    }
    
    /* Form fixes */
    #reviewForm {
      background: var(--bg-3);
      padding: 1.5rem;
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    /* Make loading indicators consistent */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(140, 103, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--ac-1);
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Improved visibility for required fields */
    #reviewName, #reviewRating, #reviewCategory, #reviewText {
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    #reviewName:required, #reviewRating:required, #reviewCategory:required, #reviewText:required {
      border-left: 3px solid var(--ac-1);
    }
    
    /* Form labels for better clarity */
    .form-label {
      display: block;
      margin-bottom: 0.3rem;
      color: var(--txt-2);
      font-size: 0.9rem;
    }
  `;
  document.head.appendChild(globalStyles);
  
  // Fix review form - this is the main issue you reported
  function fixReviewForm() {
    const reviewForm = document.getElementById('reviewForm');
    if (!reviewForm) {
      console.log("Review form not found");
      return;
    }
    
    console.log("Fixing review form");
    
    // Add labels for better clarity
    const nameInput = document.getElementById('reviewName');
    const ratingInput = document.getElementById('reviewRating');
    const categoryInput = document.getElementById('reviewCategory');
    const textInput = document.getElementById('reviewText');
    
    if (nameInput) {
      const label = document.createElement('label');
      label.className = 'form-label';
      label.htmlFor = 'reviewName';
      label.textContent = 'Café Name';
      nameInput.parentNode.insertBefore(label, nameInput);
    }
    
    if (ratingInput) {
      const label = document.createElement('label');
      label.className = 'form-label';
      label.htmlFor = 'reviewRating';
      label.textContent = 'Rating';
      ratingInput.parentNode.insertBefore(label, ratingInput);
    }
    
    if (categoryInput) {
      const label = document.createElement('label');
      label.className = 'form-label';
      label.htmlFor = 'reviewCategory';
      label.textContent = 'Best For';
      categoryInput.parentNode.insertBefore(label, categoryInput);
    }
    
    if (textInput) {
      const label = document.createElement('label');
      label.className = 'form-label';
      label.htmlFor = 'reviewText';
      label.textContent = 'Your Review';
      textInput.parentNode.insertBefore(label, textInput);
    }
    
    // Replace the existing submit handler with a corrected one
    reviewForm.onsubmit = null; // Remove any existing handler
    
    reviewForm.addEventListener('submit', function(e) {
      e.preventDefault();
      console.log("Review form submitted");
      
      // Get form values directly
      const name = nameInput?.value.trim() || '';
      const rating = ratingInput?.value || '';
      const category = categoryInput?.value || '';
      const text = textInput?.value.trim() || '';
      
      console.log("Review values:", {name, rating, category, text});
      
      // Validation messages
      if (!name) {
        alert("Please enter a café name");
        nameInput?.focus();
        return;
      }
      
      if (!rating) {
        alert("Please select a rating");
        ratingInput?.focus();
        return;
      }
      
      if (!category) {
        alert("Please select a category");
        categoryInput?.focus();
        return;
      }
      
      if (!text) {
        alert("Please enter your review");
        textInput?.focus();
        return;
      }
      
      // Save review to localStorage directly rather than calling other functions
      try {
        // Get existing reviews
        let reviews = [];
        try {
          reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
        } catch (e) {
          console.error("Error parsing existing reviews:", e);
          reviews = [];
        }
        
        // Add new review
        reviews.push({
          name: name,
          rating: parseInt(rating),
          category: category,
          text: text,
          date: new Date().toISOString().split('T')[0]
        });
        
        // Save back to localStorage
        localStorage.setItem('sb-reviews', JSON.stringify(reviews));
        console.log("Review saved successfully");
        
        // Reset form
        reviewForm.reset();
        
        // Show success message
        alert("Review added successfully!");
        
        // Refresh reviews display
        if (typeof renderReviews === 'function') {
          renderReviews();
        }
      } catch (error) {
        console.error("Error saving review:", error);
        alert("There was an error saving your review. Please try again.");
      }
    });
    
    console.log("Review form fixed");
  }
  
  // Function to ensure Leaflet loads properly
  function ensureLeaflet() {
    if (typeof L === 'undefined') {
      console.log("Leaflet not defined, loading it now");
      
      // Load Leaflet JS
      const leafletScript = document.createElement('script');
      leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      
      // After Leaflet loads, check if the map is already initialized
      leafletScript.onload = function() {
        console.log("Leaflet loaded");
        
        // If initCafe is defined, but the map isn't showing, try calling it
        if (typeof initCafe === 'function') {
          setTimeout(() => {
            const mapElement = document.getElementById('map');
            if (mapElement && !mapElement.querySelector('.leaflet-container')) {
              console.log("Map container exists but no Leaflet map found, initializing");
              initCafe();
            }
          }, 1000);
        }
      };
      
      document.head.appendChild(leafletScript);
    } else {
      console.log("Leaflet is already defined");
    }
  }
  
  // Add a reload button to the map for easy recovery
  function addMapReloadButton() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) return;
    
    // Check if button already exists
    if (document.getElementById('map-reload-btn')) return;
    
    const reloadBtn = document.createElement('button');
    reloadBtn.id = 'map-reload-btn';
    reloadBtn.style.cssText = `
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 999;
      background: rgba(140, 103, 255, 0.8);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    `;
    reloadBtn.textContent = "Reload Map";
    reloadBtn.onclick = function() {
      location.reload();
    };
    
    mapContainer.appendChild(reloadBtn);
  }
  
  // Wait for everything to load then apply our fixes
  setTimeout(function() {
    // Fix review form
    fixReviewForm();
    
    // Ensure Leaflet is loaded
    ensureLeaflet();
    
    // Add map reload button
    addMapReloadButton();
    
    console.log("StudyBuddy enhancements applied");
  }, 1000);
});
// Script to integrate the enhanced features
document.addEventListener('DOMContentLoaded', function() {
  // Load additional CSS for enhanced features
  const enhancedCSS = document.createElement('style');
  enhancedCSS.textContent = `
    /* Improved map styling */
    #map {
      width: 100%;
      height: 500px;
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-s);
      position: relative;
      z-index: 1;
    }

    /* Custom Leaflet styling */
    .leaflet-container {
      background: #1e1e1e;
      font-family: 'Inter', sans-serif;
    }

    .leaflet-popup-content-wrapper {
      background: var(--bg-2);
      color: var(--txt-1);
      border-radius: var(--rad-m);
      padding: 0;
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .leaflet-popup-tip {
      background: var(--bg-2);
      box-shadow: var(--shadow-s);
    }

    .leaflet-popup-content {
      margin: 8px;
      width: auto !important;
    }

    .leaflet-control-attribution {
      background: rgba(30, 30, 30, 0.7) !important;
      color: var(--txt-2) !important;
      backdrop-filter: blur(5px);
      padding: 3px 8px;
      border-radius: 4px;
    }

    .leaflet-control-attribution a {
      color: var(--ac-1) !important;
    }
    
    /* Enhanced forms */
    #reviewForm, #plannerForm {
      background: var(--bg-3);
      padding: 15px;
      border-radius: var(--rad-m);
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Improved review form layout */
    #reviewForm {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    #reviewForm div:first-child {
      grid-column: span 2;
    }

    #reviewForm textarea {
      grid-column: span 2;
    }

    #reviewForm button {
      grid-column: span 2;
      margin-top: 0.5rem;
    }
    
    /* Add visual flare to study planner */
    #planList .card {
      position: relative;
      overflow: hidden;
    }

    #planList .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, var(--ac-1), var(--ac-3));
      border-radius: var(--rad-s) 0 0 var(--rad-s);
    }

    #planList .card h4 {
      margin-left: 8px;
    }
    
    /* Make loading indicators consistent */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(140, 103, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--ac-1);
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
      #map {
        height: 350px;
      }
      
      #reviewForm {
        display: block;
      }
    }
  `;
  document.head.appendChild(enhancedCSS);
  
  // Load Leaflet CSS if not already loaded
  if (!document.querySelector('link[href*="leaflet.css"]')) {
    const leafletCSS = document.createElement('link');
    leafletCSS.rel = 'stylesheet';
    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(leafletCSS);
  }
  
  // Load Leaflet JS if not already loaded
  if (typeof L === 'undefined') {
    const leafletScript = document.createElement('script');
    leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    leafletScript.onload = function() {
      console.log('Leaflet loaded dynamically');
      // Initialize cafe feature after Leaflet loads
      if (typeof initCafe === 'function') {
        initCafe();
      }
    };
    document.head.appendChild(leafletScript);
  } else {
    // Leaflet already loaded, initialize cafe feature
    if (typeof initCafe === 'function') {
      initCafe();
    }
  }
  
  // Initialize enhanced planner
  if (typeof initPlanner === 'function') {
    initPlanner();
  }
});

// Fix the global selectCafeForReview function if not defined
if (typeof selectCafeForReview === 'undefined') {
  window.selectCafeForReview = function(cafeName) {
    const reviewName = document.getElementById('reviewName');
    const reviewForm = document.getElementById('reviewForm');
    
    if (reviewName && reviewForm) {
      reviewName.value = cafeName;
      reviewForm.scrollIntoView({ behavior: 'smooth' });
      setTimeout(() => {
        document.getElementById('reviewRating')?.focus();
      }, 300);
    }
  };
}

// Add global error handling for map-related issues
window.addEventListener('error', function(e) {
  // Check if error is map related
  if (e.message && (
    e.message.toLowerCase().includes('leaflet') || 
    e.message.toLowerCase().includes('map') || 
    e.message.toLowerCase().includes('marker') || 
    e.message.toLowerCase().includes('layer')
  )) {
    console.error('Map error:', e);
    
    // Get map container
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
      // Show error message
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = 'position:absolute;top:10px;left:10px;z-index:1000;background:rgba(255,100,100,0.9);color:white;padding:10px;border-radius:4px;max-width:80%;';
      errorDiv.innerHTML = `
        Map error occurred. <button id="mapErrorRefresh" style="background:rgba(255,255,255,0.3);border:none;color:white;padding:3px 8px;border-radius:3px;cursor:pointer;margin-left:10px;">Refresh</button>
      `;
      mapContainer.appendChild(errorDiv);
      
      // Add refresh button handler
      document.getElementById('mapErrorRefresh')?.addEventListener('click', function() {
        window.location.reload();
      });
    }
  }
});
// CHAT
    function initChat(){
      const tog=document.getElementById('chatToggle'),
            w=document.getElementById('chatWidget'),
            cl=document.getElementById('chatClose');
      tog.onclick=()=>w.classList.toggle('open');
      cl.onclick=()=>w.classList.remove('open');
      document.getElementById('chatInput').addEventListener('submit',async e=>{
        e.preventDefault();
        const inp=e.target.querySelector('input'),txt=inp.value.trim();
        if(!txt) return;
        addChat('me',txt); inp.value='';
        addChat('bot','...');
        try{
          const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:txt})});
          const d=await res.json();
          const ps=document.querySelectorAll('#chatBody .bot p');
          ps[ps.length-1].textContent=d.reply||"Couldn't process.";
        }catch{
          const ps=document.querySelectorAll('#chatBody .bot p');
          ps[ps.length-1].textContent="Connection error.";
        }
      });
    }
    function addChat(who,txt){
      const b=document.getElementById('chatBody'),d=document.createElement('div');
      d.className='row '+who; d.innerHTML=`<p>${txt}</p>`; b.append(d); b.scrollTop=b.scrollHeight;
    }
  </script>
</body>
</html>
