<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StudyBuddy</title>

  <!-- Original Google API loader -->
  <script src="https://apis.google.com/js/api.js" defer></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Three.js & Vanta.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.dots.min.js" defer></script>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js" defer></script>

  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  defer
></script>

  <style>
    :root {
      --bg-1:#121212; --bg-2:#1e1e1e; --bg-3:#2d2d2d;
      --txt-1:#fafafa; --txt-2:#b0b0b0;
      --ac-1:#8c67ff; --ac-2:#4f46e5; --ac-3:#ff6f91; --ac-warn:#f2c94c;
      --rad-s:6px; --rad-m:12px; --rad-l:20px;
      --shadow-s:0 4px 20px rgba(0,0,0,.15);
      --shadow-l:0 8px 30px rgba(0,0,0,.35);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
    body{background:var(--bg-1);color:var(--txt-1);min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;}
    a{color:var(--ac-1);text-decoration:none;transition:all .2s ease;}a:hover{text-decoration:underline;}
    #background{position:fixed;inset:0;z-index:-1;}
    header{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;padding:1rem 2rem;background:rgba(30,30,30,.85);backdrop-filter:blur(10px);box-shadow:var(--shadow-s);z-index:10;}
    .logo-container{display:flex;align-items:center;gap:.6rem;}
    .logo-icon{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--ac-1),var(--ac-2));display:grid;place-content:center;color:#fff;font-weight:700;}
    .logo{font-size:1.5rem;font-weight:700;background:linear-gradient(90deg,var(--ac-1),var(--ac-3));-webkit-background-clip:text;color:transparent;}
    nav{display:flex;gap:.3rem;flex-wrap:wrap;}
    nav button{background:none;border:none;color:var(--txt-2);padding:.55rem .95rem;border-radius:var(--rad-s);cursor:pointer;transition:all .2s ease;position:relative;}
    nav button:hover, nav button.active{background:rgba(140,103,255,.12);color:var(--txt-1);}
    nav button.active::after{content:'';position:absolute;left:50%;bottom:0;transform:translateX(-50%);width:22px;height:3px;background:var(--ac-1);border-radius:5px;}
    main{flex:1;max-width:1400px;margin:0 auto;padding:2rem;}
    section{display:none;animation:fade .35s ease-in-out;}section.active{display:block;}
    @keyframes fade{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
    h2.section-title{font-size:1.75rem;margin-bottom:1.4rem;}
    .card{background:var(--bg-2);padding:1.25rem;border-radius:var(--rad-m);box-shadow:var(--shadow-s);border:1px solid rgba(255,255,255,.05);transition:all .3s ease;position:relative;}
    .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-l);}
    .btn{display:inline-flex;align-items:center;gap:.45rem;border:none;cursor:pointer;padding:.7rem 1.4rem;font-weight:500;border-radius:var(--rad-s);box-shadow:0 2px 6px rgba(0,0,0,.2);transition:all .2s ease;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.3);}
    .btn-primary{background:var(--ac-1);color:#fff;} .btn-secondary{background:rgba(255,255,255,.1);color:var(--txt-1);} .btn-small{padding:.3rem .6rem;font-size:.8rem;}
    input,textarea,select{background:var(--bg-3);border:1px solid rgba(255,255,255,.1);color:var(--txt-1);padding:.75rem;border-radius:var(--rad-s);width:100%;margin-bottom:1rem;transition:border-color .2s ease;}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--ac-1);}
    /* Quotes */
    #quotes{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem;}
    #quotes .card{font-style:italic;text-align:center;color:var(--txt-2);}
    /* Pomodoro */
    #timerDisplay{font-size:2.5rem;text-align:center;margin:1rem 0;}
    #timerControls{display:flex;justify-content:center;gap:1rem;}
    /* Tasks */
    #tasksBoard{display:flex;gap:1rem;margin-top:1rem;}
    .column{background:var(--bg-2);flex:1;min-width:240px;padding:1rem;border-radius:var(--rad-m);position:relative;}
    .column h3{margin-bottom:.8rem;color:var(--txt-2);}
    .task{background:var(--bg-3);padding:.6rem 1rem;border-radius:var(--rad-s);margin-bottom:.6rem;display:flex;align-items:center;justify-content:space-between;}
    .task-buttons button{margin-left:.5rem;}
    /* Map */
    #map{width:100%;height:350px;border-radius:var(--rad-m);margin-bottom:1rem;}
    /* Reviews */
    .delete-review{position:absolute;top:4px;right:8px;cursor:pointer;color:var(--ac-warn);font-weight:bold;}
    .delete-review:hover{color:var(--ac-3);}
    /* Games */
    #gameSelect{margin-bottom:1rem;}
    /* Make iframe much bigger */
    #gameFrame{width:100%;height:80vh;border:none;border-radius:var(--rad-m);margin-top:1rem;box-shadow:var(--shadow-s);}
    /* Planner */
    #planList .card{margin-bottom:1rem;padding-right:2.5rem;}
    #plannerAdvice{margin-top:1rem;background:var(--bg-3);padding:1rem;border-radius:var(--rad-s);max-height:300px;overflow-y:auto;white-space:pre-wrap;line-height:1.5;}
    .delete-plan{position:absolute;top:10px;right:10px;cursor:pointer;color:var(--ac-warn);font-weight:bold;font-size:1.2rem;}
    .delete-plan:hover{color:var(--ac-3);}
    /* Chat */
    #chatToggle{position:fixed;bottom:1rem;right:1rem;width:56px;height:56px;border-radius:50%;background:var(--ac-1);color:#fff;font-size:1.5rem;border:none;cursor:pointer;box-shadow:var(--shadow-l);z-index:20;transition:transform 0.3s ease,box-shadow 0.3s ease;}
    #chatToggle:hover{transform:scale(1.1);box-shadow:0 10px 40px rgba(140,103,255,.4);}
    #chatWidget{position:fixed;bottom:1.5rem;right:1.5rem;width:340px;height:400px;background:var(--bg-2);border-radius:var(--rad-l);box-shadow:var(--shadow-l);display:flex;flex-direction:column;overflow:hidden;z-index:20;opacity:0;transform:translateY(20px) scale(0.8);pointer-events:none;transition:opacity .3s ease,transform .3s ease;}
    #chatWidget.open{opacity:1;transform:translateY(0) scale(1);pointer-events:all;}
    #chatHeader{background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;border-top-left-radius:var(--rad-l);border-top-right-radius:var(--rad-l);}
    #chatClose{background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;transition:transform .2s ease;}
    #chatClose:hover{transform:rotate(90deg);}
    #chatBody{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.7rem;scroll-behavior:smooth;background:rgba(18,18,18,.3);}
    .row{display:flex;}
    .row.me{justify-content:flex-end;}
    .row p{padding:.75rem 1rem;border-radius:18px;max-width:80%;font-size:.88rem;line-height:1.5;}
    .me p{background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;border-bottom-right-radius:6px;}
    .bot p{background:var(--bg-3);color:var(--txt-1);border-bottom-left-radius:6px;}
    #chatInput{display:flex;border-top:1px solid rgba(255,255,255,.06);}
    #chatInput input{flex:1;border:none;background:var(--bg-3);color:var(--txt-1);padding:.75rem 1rem;border-radius:var(--rad-s);margin:.5rem;outline:none;}
    #chatInput button{width:42px;height:42px;margin:.5rem;border-radius:50%;background:var(--ac-1);border:none;color:#fff;transition:all .2s ease;cursor:pointer;}
    #chatInput button:hover{transform:scale(1.1);background:var(--ac-2);}
    /* Celebration */
    #celebrationPopup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,var(--ac-1),var(--ac-2));color:#fff;padding:2rem;border-radius:var(--rad-l);text-align:center;z-index:100;box-shadow:var(--shadow-l);animation:popIn .5s cubic-bezier(.175,.885,.32,1.275) forwards;}
    #celebrationPopup .emoji{font-size:4rem;margin-bottom:1rem;display:block;}
    #celebrationPopup h2{font-size:2rem;margin-bottom:1rem;}
    #celebrationPopup button{margin-top:1rem;background:rgba(255,255,255,.2);border:none;color:#fff;padding:.5rem 1.5rem;border-radius:var(--rad-s);cursor:pointer;transition:all .2s ease;}
    #celebrationPopup button:hover{background:rgba(255,255,255,.3);}
    @keyframes popIn{0%{transform:translate(-50%,-50%) scale(.8);opacity:0;}100%{transform:translate(-50%,-50%) scale(1);opacity:1;}}
    :root {
      --bg-1: #121212;
      --bg-2: #1e1e1e;
      --bg-3: #2d2d2d;
      --txt-1: #fafafa;
      --txt-2: #b0b0b0;
      --ac-1: #8c67ff;
      --ac-2: #4f46e5;
      --ac-3: #ff6f91;
      --ac-warn: #f2c94c;
      --rad-s: 6px;
      --rad-m: 12px;
      --rad-l: 20px;
      --shadow-s: 0 4px 20px rgba(0, 0, 0, .15);
      --shadow-l: 0 8px 30px rgba(0, 0, 0, .35);
    }
  
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
  
    body {
      background: var(--bg-1);
      color: var(--txt-1);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }
  
    a {
      color: var(--ac-1);
      text-decoration: none;
      transition: all .2s ease;
    }
    a:hover {
      text-decoration: underline;
    }
  
    #background {
      position: fixed;
      inset: 0;
      z-index: -1;
    }
  
    header {
      position: sticky;
      top: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      background: rgba(30, 30, 30, .85);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-s);
      z-index: 10;
    }
  
    .logo-container {
      display: flex;
      align-items: center;
      gap: .6rem;
    }
  
    .logo-icon {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--ac-1), var(--ac-2));
      display: grid;
      place-content: center;
      color: #fff;
      font-weight: 700;
    }
  
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--ac-1), var(--ac-3));
      -webkit-background-clip: text;
      color: transparent;
    }
  
    nav {
      display: flex;
      gap: .3rem;
      flex-wrap: wrap;
    }
  
    nav button {
      background: none;
      border: none;
      color: var(--txt-2);
      padding: .55rem .95rem;
      border-radius: var(--rad-s);
      cursor: pointer;
      transition: all .2s ease;
      position: relative;
    }
    nav button:hover,
    nav button.active {
      background: rgba(140, 103, 255, .12);
      color: var(--txt-1);
    }
    #map {
      width: 100%;
      height: 500px;
      border-radius: var(--rad-m);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-s);
    }
  
    /* Improved cafe review styling */
    #reviewForm {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
  
    #reviewForm textarea {
      grid-column: span 2;
    }
  
    #reviewForm button {
      margin-top: 0.5rem;
    }
  
    /* Search input styling */
    .search-control input {
      background: var(--bg-3);
      color: var(--txt-1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.6rem;
      border-radius: var(--rad-s);
      width: 220px;
      box-shadow: var(--shadow-s);
      margin-bottom: 0 !important;
    }
  
    .search-control input:focus {
      outline: none;
      border-color: var(--ac-1);
    }
  
    /* Loading indicator */
    .loading-indicator span {
      background: rgba(30, 30, 30, 0.8);
      color: var(--txt-1);
      padding: 8px 12px;
      border-radius: var(--rad-s);
      font-size: 0.9rem;
      display: inline-block;
      box-shadow: var(--shadow-s);
    }
  
    /* Marker cluster styling */
    .marker-cluster {
      background-color: rgba(140, 103, 255, 0.6);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
  
    /* Leaflet popup styling */
    .leaflet-popup-content-wrapper {
      background: var(--bg-2);
      color: var(--txt-1);
      border-radius: var(--rad-m);
      padding: 0.5rem;
      box-shadow: var(--shadow-s);
    }
  
    .leaflet-popup-tip {
      background: var(--bg-2);
    }
  
    .leaflet-popup-content {
      margin: 0.5rem;
    }
  
    /* Enhanced review form */
    #cafeReviews {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
  
    .cafe-review-card {
      background: var(--bg-2);
      border-radius: var(--rad-m);
      padding: 1rem;
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }
  
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
  
    .review-body {
      margin-bottom: 0.5rem;
    }
  
    .review-footer {
      font-size: 0.8rem;
      color: var(--txt-2);
    }
    
    /* DataList enhancement */
    #reviewName {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255, 255, 255, 0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 2.5rem;
    }
    nav button.active::after {
      content: '';
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 22px;
      height: 3px;
      background: var(--ac-1);
      border-radius: 5px;
    }
  
    main {
      flex: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
  
    section {
      display: none;
      animation: fade .35s ease-in-out;
    }
    section.active {
      display: block;
    }
  
    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  
    h2.section-title {
      font-size: 1.75rem;
      margin-bottom: 1.4rem;
    }
  
    .card {
      background: var(--bg-2);
      padding: 1.25rem;
      border-radius: var(--rad-m);
      box-shadow: var(--shadow-s);
      border: 1px solid rgba(255, 255, 255, .05);
      transition: all .3s ease;
      position: relative;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-l);
    }
  
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      border: none;
      cursor: pointer;
      padding: .7rem 1.4rem;
      font-weight: 500;
      border-radius: var(--rad-s);
      box-shadow: 0 2px 6px rgba(0, 0, 0, .2);
      transition: all .2s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, .3);
    }
  
    .btn-primary {
      background: var(--ac-1);
      color: #fff;
    }
    .btn-secondary {
      background: rgba(255, 255, 255, .1);
      color: var(--txt-1);
    }
    .btn-small {
      padding: .3rem .6rem;
      font-size: .8rem;
    }
  
    /* Inputs */
    input,
    textarea,
    select {
      background: var(--bg-3);
      border: 1px solid rgba(255, 255, 255, .1);
      color: var(--txt-1);
      padding: .75rem;
      border-radius: var(--rad-s);
      width: 100%;
      margin-bottom: 1rem;
      transition: border-color .2s ease;
    }
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--ac-1);
    }
  
    /* Quotes */
    #quotes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    #quotes .card {
      font-style: italic;
      text-align: center;
      color: var(--txt-2);
    }
  
    /* Pomodoro Timer */
    #timerDisplay {
      font-size: 2.5rem;
      text-align: center;
      margin: 1rem 0;
    }
    #timerControls {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
  
    /* Tasks Board */
    #tasksBoard {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    .column {
      background: var(--bg-2);
      flex: 1;
      min-width: 240px;
      padding: 1rem;
      border-radius: var(--rad-m);
      position: relative;
    }
    .column h3 {
      margin-bottom: .8rem;
      color: var(--txt-2);
    }
    .task {
      background: var(--bg-3);
      padding: .6rem 1rem;
      border-radius: var(--rad-s);
      margin-bottom: .6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .task-buttons button {
      margin-left: .5rem;
    }
  
    /* Map (Leaflet) */
    #map {
      width: 100%;
      height: 350px;
      border-radius: var(--rad-m);
      margin-bottom: 1rem;
    }
  
    /* Reviews */
    .delete-review {
      position: absolute;
      top: 4px;
      right: 8px;
      cursor: pointer;
      color: var(--ac-warn);
      font-weight: bold;
    }
    .delete-review:hover {
      color: var(--ac-3);
    }
  
    /* Games */
    #gameSelect {
      margin-bottom: 1rem;
    }
    #gameFrame {
      width: 100%;
      height: 80vh;
      border: none;
      border-radius: var(--rad-m);
      margin-top: 1rem;
      box-shadow: var(--shadow-s);
    }
  </style>
</head>
<body>
  <div id="background"></div>
  <header>
    <div class="logo-container"><div class="logo-icon">S</div><span class="logo">StudyBuddy</span></div>
    <nav>
      <button class="active" data-target="dashboard">Dashboard</button>
      <button data-target="cafes">Cafés</button>
      <button data-target="games">Play</button>
      <button data-target="sessions">Sessions</button>
      <button data-target="planner">Planner</button>
    </nav>
  </header>

  <main>
    <!-- Dashboard -->
    <section id="dashboard" class="active">
      <h2 class="section-title">Dashboard</h2>
      <div id="quotes"></div>
      <button id="refreshQuotes" class="btn btn-small btn-primary">Refresh Quotes</button>

      <div class="card">
        <h3>Pomodoro Timer</h3>
        <div id="timerDisplay">25:00</div>
        <div id="timerControls">
          <button id="startTimer" class="btn btn-primary">Start</button>
          <button id="pauseTimer" class="btn btn-secondary">Pause</button>
          <button id="resetTimer" class="btn btn-secondary">Reset</button>
        </div>
      </div>

      <div class="card">
        <h3>Tasks</h3>
        <form id="newTaskForm">
          <input id="newTaskInput" type="text" placeholder="New task… (Enter or click Add)" required/>
          <button type="submit" class="btn btn-primary btn-small">Add</button>
        </form>
        <div id="tasksBoard">
          <div class="column" data-status="todo"><h3>To Do</h3></div>
          <div class="column" data-status="inprogress"><h3>In Progress</h3></div>
          <div class="column" data-status="completed"><h3>Completed</h3></div>
        </div>
      </div>
    </section>

    <!-- Cafés -->
<!-- Cafés -->
<section id="cafes">
  <h2 class="section-title">Study Cafés</h2>
  <div id="map"></div>
  
  <div class="card">
    <h3>Add Café Review</h3>
    <form id="reviewForm">
      <div style="position: relative; grid-column: span 2;">
        <input id="reviewName" list="cafeList" type="text" placeholder="Choose a cafe or type a name..." required/>
        <datalist id="cafeList"></datalist>
      </div>
      <select id="reviewRating" required>
        <option value="">Select Rating...</option>
        <option value="1">★ (Poor)</option>
        <option value="2">★★ (Fair)</option>
        <option value="3">★★★ (Good)</option>
        <option value="4">★★★★ (Very Good)</option>
        <option value="5">★★★★★ (Excellent)</option>
      </select>
      <select id="reviewCategory" required>
        <option value="">Best For...</option>
        <option value="studying">Studying</option>
        <option value="reading">Reading</option>
        <option value="meetings">Meetings</option>
        <option value="relaxing">Relaxing</option>
        <option value="food">Food & Drinks</option>
      </select>
      <textarea id="reviewText" rows="3" placeholder="Share your experience... Were the tables good for studying? How was the WiFi? Was it quiet?" required></textarea>
      <button class="btn btn-primary" type="submit">Save Review</button>
    </form>
  </div>
  
  <div id="cafeReviews"></div>
</section>
    <!-- Games -->
    <section id="games">
      <h2 class="section-title">Take a Break</h2>
      <select id="gameSelect"></select>
      <iframe id="gameFrame"></iframe>
    </section>

    <!-- Sessions -->
    <section id="sessions">
      <h2 class="section-title">Study Sessions</h2>
      <div class="card">
        <h3>New Session</h3>
        <form id="sessionForm" class="grid two-col">
          <div><label>Topic</label><input id="sessionTopic" type="text" required/></div>
          <div><label>Date</label><input id="sessionDate" type="date" required/></div>
          <div><label>Duration</label><input id="sessionDuration" type="number" required/></div>
          <div style="grid-column:1/-1;"><button class="btn btn-primary" type="submit">Add</button></div>
        </form>
      </div>
      <ul id="sessionList"></ul>
    </section>

    <!-- Planner -->
    <section id="planner">
      <h2 class="section-title">Study Planner</h2>
      <div class="card">
        <h3>Add Planner Task</h3>
        <form id="plannerForm">
          <input id="planTitle" type="text" placeholder="Title…" required style="width:48%;display:inline-block;margin-right:2%;"/>
          <select id="planCat" style="width:48%;display:inline-block;" required>
            <option value="">Category…</option><option>Homework</option><option>Reading</option><option>Project</option><option>Review</option>
          </select>
          <textarea id="planDesc" rows="2" placeholder="Description…"></textarea>
          <input id="planDate" type="date" required/>
          <button class="btn btn-primary" type="submit">Add Task</button>
        </form>
      </div>
      <div id="planList"></div>
      <button id="planStudy" class="btn btn-primary">Plan My Study</button>
      <div id="plannerAdvice"></div>
    </section>
  </main>

  <!-- Chat -->
  <button id="chatToggle">💬</button>
  <div id="chatWidget">
    <div id="chatHeader">
      StudyBuddy AI
      <button id="chatClose">✕</button>
    </div>
    <div id="chatBody"></div>
    <form id="chatInput">
      <input type="text" placeholder="Ask a question…" autocomplete="off" required/>
      <button type="submit">➤</button>
    </form>
  </div>

  <!-- Celebration -->
  <div id="celebrationPopup">
    <span class="emoji">🎉</span>
    <h2>Great Job!</h2>
    <p>You've completed a task!</p>
    <button id="closeCelebration">Continue</button>
  </div>

  <script>
    let CONFIG = {};
    async function fetchConfig(){
      try {
        console.log("Fetching config…");
        CONFIG = await (await fetch('/api/config')).json();
        console.log("CONFIG:", CONFIG);
      } catch(e){
        console.error("Config fetch failed", e);
      }
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      VANTA.DOTS({
        el:'#background',
        mouseControls:true,touchControls:true,gyroControls:false,
        minHeight:200,minWidth:200,scale:1,scaleMobile:1,
        color:0x8c67ff,color2:0x4f46e5,backgroundColor:0x121212,
        size:3,spacing:25,showLines:false
      });
      await fetchConfig();
      initNav(); initQuotes(); initPomodoro(); initTasks();
      initCafe(); initGames(); initSessions(); initPlanner(); initChat();
    });

    // NAV
    function initNav(){
      document.querySelectorAll('nav button').forEach(btn=>{
        btn.onclick=()=>{
          document.querySelector('nav button.active').classList.remove('active');
          btn.classList.add('active');
          document.querySelector('section.active').classList.remove('active');
          document.getElementById(btn.dataset.target).classList.add('active');
        };
      });
    }

    // QUOTES
    const quotesList = ["Start where you are.","Progress over perfection.","One step at a time.","Dream, believe, do.","Focus and win.","Every day is a second chance.","Small progress is progress.","Stay positive.","Believe you can.","Do it now.","Keep pushing.","Consistency is key.","Success is a journey.","You got this.","Make today count."];
    function renderQuotes(){
      const c=document.getElementById('quotes');c.innerHTML='';
      quotesList.sort(()=>0.5-Math.random()).slice(0,3).forEach(q=>{
        const d=document.createElement('div');d.className='card';d.textContent=`"${q}"`;c.append(d);
      });
    }
    function initQuotes(){
      renderQuotes();
      document.getElementById('refreshQuotes').onclick=renderQuotes;
    }

    // POMODORO
    let pomTime=25*60, pomInterval, pomRunning=false;
    function updatePom(){
      const m=String(Math.floor(pomTime/60)).padStart(2,'0'),
            s=String(pomTime%60).padStart(2,'0');
      document.getElementById('timerDisplay').textContent=`${m}:${s}`;
      document.title=`(${m}:${s}) StudyBuddy`;
    }
    function initPomodoro(){
      updatePom();
      document.getElementById('startTimer').onclick=()=>{
        if(pomRunning) return;
        pomRunning=true;
        pomInterval=setInterval(()=>{
          if(pomTime>0){pomTime--;updatePom();}
          else{clearInterval(pomInterval);pomRunning=false;confetti({particleCount:100,spread:70,origin:{y:0.6}});alert('Done!');document.title='StudyBuddy';}
        },1000);
      };
      document.getElementById('pauseTimer').onclick=()=>{clearInterval(pomInterval);pomRunning=false;};
      document.getElementById('resetTimer').onclick=()=>{clearInterval(pomInterval);pomRunning=false;pomTime=25*60;updatePom();};
    }

    // TASKS
    function getTasks(){
      let raw;
      try{ raw=JSON.parse(localStorage.getItem('sb-tasks')); }
      catch(e){ raw=null; console.warn("Invalid tasks data",e); }
      let t;
      if(Array.isArray(raw)){
        console.log("Legacy task-array found, migrating");
        t={todo:raw, inprogress:[], completed:[]};
      } else if(raw && typeof raw==='object'){
        t=raw;
      } else {
        t={todo:[],inprogress:[],completed:[]};
      }
      t.todo  = Array.isArray(t.todo) ? t.todo : [];
      t.inprogress = Array.isArray(t.inprogress) ? t.inprogress : [];
      t.completed  = Array.isArray(t.completed) ? t.completed : [];
      console.log("Loaded tasks:", t);
      return t;
    }
    function saveTasks(t){
      console.log("Saving tasks:", t);
      localStorage.setItem('sb-tasks',JSON.stringify(t));
    }
    function renderTasks(){
      const all=getTasks();
      ['todo','inprogress','completed'].forEach(status=>{
        const col=document.querySelector(`.column[data-status="${status}"]`);
        const title=col.querySelector('h3').textContent;
        col.innerHTML=`<h3>${title}</h3>`;
        all[status].forEach((txt,i)=>{
          const task=document.createElement('div');task.className='task';
          task.innerHTML=`
            <span>${txt}</span>
            <div class="task-buttons">
              ${status==='todo'?`<button data-action="start" data-index="${i}" class="btn btn-small btn-primary">Start</button>`:''}
              ${status==='inprogress'?`<button data-action="complete" data-index="${i}" class="btn btn-small btn-primary">Complete</button>`:''}
              <button data-action="delete" data-status="${status}" data-index="${i}" class="btn btn-small btn-secondary">×</button>
            </div>
          `;
          col.append(task);
        });
      });
    }
    function initTasks(){
      console.log("initTasks()");
      document.getElementById('newTaskForm').addEventListener('submit',e=>{
        e.preventDefault();
        const v=document.getElementById('newTaskInput').value.trim();
        console.log("Adding task:",v);
        if(!v) return;
        const all=getTasks();
        all.todo.push(v);
        saveTasks(all);
        renderTasks();
        e.target.reset();
      });
      document.getElementById('tasksBoard').addEventListener('click',e=>{
        const btn=e.target.closest('button[data-action]');
        if(!btn) return;
        const action=btn.dataset.action;
        const all=getTasks();
        console.log("Task action:",action,btn.dataset);
        if(action==='delete'){
          all[btn.dataset.status].splice(+btn.dataset.index,1);
        }
        if(action==='start'){
          const [t]=all.todo.splice(+btn.dataset.index,1);
          all.inprogress.push(t);
        }
        if(action==='complete'){
          const [t]=all.inprogress.splice(+btn.dataset.index,1);
          all.completed.push(t);
          confetti({particleCount:100,spread:70,origin:{y:0.6}});
          document.getElementById('celebrationPopup').style.display='block';
          setTimeout(()=>document.getElementById('celebrationPopup').style.display='none',3000);
        }
        saveTasks(all);
        renderTasks();
      });
      renderTasks();
      document.getElementById('closeCelebration').onclick=()=>{
        document.getElementById('celebrationPopup').style.display='none';
      };
    }
    
  
    // on DOMContentLoaded include initCafe
    document.addEventListener('DOMContentLoaded', function() {
      initCafe();
    });
    function startMap(pos){
      console.log("startMap at",pos);
      const mp=new google.maps.Map(document.getElementById('map'),{center:pos,zoom:14});
      new google.maps.Marker({map:mp,position:pos,title:'You'});
      const svc=new google.maps.places.PlacesService(mp);
      svc.nearbySearch({location:pos,radius:1500,type:['cafe']},(res,st)=>{
        console.log("PlacesService:",st,res);
        if(st==='OK')res.forEach(p=>new google.maps.Marker({map:mp,position:p.geometry.location,title:p.name}));
      });
    }

    
    function initCafe() {
      console.log("Initializing enhanced cafe map functionality");
      
      // Cache DOM elements
      const mapContainer = document.getElementById('map');
      const cafeList = document.getElementById('cafeList');
      const reviewForm = document.getElementById('reviewForm');
      const reviewName = document.getElementById('reviewName');
      
      // Map globals
      let map, markerCluster;
      let cafeMarkers = [];
      let allCafes = [];
      
      // Initialize map
      function initializeMap() {
        // Clear any existing map
        if (window.leafletMap) {
          window.leafletMap.remove();
          window.leafletMap = null;
        }
        
        // Make sure map container is properly sized
        mapContainer.style.height = '500px'; // Increased height for better visibility
        
        // Get user location with better error handling
        navigator.geolocation.getCurrentPosition(
          position => setupMap(position.coords.latitude, position.coords.longitude),
          error => {
            console.warn("Geolocation failed:", error);
            // Fallback coordinates - Dubai
            setupMap(25.276987, 55.296249);
          },
          { timeout: 10000, enableHighAccuracy: true }
        );
      }
      
      // Set up the map with the given coordinates
      function setupMap(lat, lng) {
        console.log("Setting up map at:", lat, lng);
        
        // Initialize the map
        map = L.map('map', {
          center: [lat, lng],
          zoom: 14,
          zoomControl: true,
          attributionControl: false,
          minZoom: 10,
          maxZoom: 19
        });
        window.leafletMap = map;
        
        // Add a nice-looking tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          subdomains: 'abcd',
          maxZoom: 19
        }).addTo(map);
        
        // Add attribution in a better position
        L.control.attribution({
          position: 'bottomright'
        }).addTo(map);
        
        // Add scale control
        L.control.scale({
          imperial: false,
          position: 'bottomleft'
        }).addTo(map);
        
        // Current location marker with circle
        let userMarker = L.marker([lat, lng], {
          title: 'Your Location',
          icon: createCustomIcon('📍', '#4f46e5')
        }).addTo(map);
        
        // Add circle around user location (1.5km radius)
        let locationCircle = L.circle([lat, lng], {
          radius: 1500,
          color: '#8c67ff',
          fillColor: '#8c67ff',
          fillOpacity: 0.1,
          opacity: 0.3
        }).addTo(map);
        
        // Add cafe markers using multiple sources
        fetchCafes(lat, lng);
        
        // Force a resize to ensure proper rendering
        setTimeout(() => map.invalidateSize(), 100);
    
        // Add search box
        addSearchBox();
      }
      
      // Create custom icon for markers
      function createCustomIcon(emoji, color, size = 32) {
        return L.divIcon({
          html: `<div style="background-color: ${color}; color: white; width: ${size}px; height: ${size}px; 
                 border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                 box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${emoji}</div>`,
          className: '',
          iconSize: [size, size],
          iconAnchor: [size/2, size/2]
        });
      }
      
      // Fetch cafes from multiple sources for better coverage
      function fetchCafes(lat, lng) {
        // Show loading indicator
        const loadingIndicator = L.control({position: 'topright'});
        loadingIndicator.onAdd = function() {
          const div = L.DomUtil.create('div', 'loading-indicator');
          div.innerHTML = '<span style="background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 4px; font-size: 14px;">Loading cafes...</span>';
          return div;
        };
        loadingIndicator.addTo(map);
        
        // Clear existing markers
        cafeMarkers.forEach(marker => map.removeLayer(marker));
        cafeMarkers = [];
        allCafes = [];
        
        // Initialize progress tracking
        let sourcesCompleted = 0;
        const totalSources = 3; // Overpass, Foursquare, Google (simulated)
        
        function updateProgress() {
          sourcesCompleted++;
          if (sourcesCompleted === totalSources) {
            // All sources loaded
            map.removeControl(loadingIndicator);
            
            // If we have too few cafes, expand search radius
            if (allCafes.length < 5) {
              console.log("Few cafes found, expanding search radius");
              // This would normally call a function with a larger radius
              // For this example, we'll just add some simulated cafes
              addSimulatedCafes(lat, lng, 10);
            }
            
            updateCafeList();
            
            // Add marker clustering if we have many cafes
            if (allCafes.length > 10) {
              addMarkerClustering();
            }
          }
        }
        
        // 1. Fetch from Overpass API (OSM)
        const overpassRadius = 2000; // 2km radius
        const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];(node["amenity"="cafe"](around:${overpassRadius},${lat},${lng});node["shop"="coffee"](around:${overpassRadius},${lat},${lng}););out body;`;
        
        fetch(overpassUrl)
          .then(res => res.json())
          .then(data => {
            console.log("Overpass data:", data);
            const cafes = data.elements || [];
            
            cafes.forEach(cafe => {
              if (!cafe.tags) return;
              
              const name = cafe.tags.name || 'Unnamed Cafe';
              const cafeType = cafe.tags.amenity === 'cafe' ? 'Cafe' : 'Coffee Shop';
              
              // Create cafe object
              const cafeObj = {
                id: `osm-${cafe.id}`,
                name: name,
                lat: cafe.lat,
                lng: cafe.lon,
                type: cafeType,
                address: cafe.tags['addr:street'] || '',
                wifi: cafe.tags.internet_access === 'wlan' ? 'Yes' : 'Unknown',
                power: cafe.tags.power_supply === 'yes' ? 'Yes' : 'Unknown',
                hours: cafe.tags.opening_hours || 'Not specified',
                source: 'OpenStreetMap'
              };
              
              allCafes.push(cafeObj);
              addCafeMarker(cafeObj);
            });
            
            updateProgress();
          })
          .catch(err => {
            console.error("Overpass API error:", err);
            updateProgress();
          });
        
        // 2. Simulated Foursquare API (as we don't have actual API keys)
        setTimeout(() => {
          console.log("Simulating Foursquare data");
          // Simulate some additional cafes
          addSimulatedCafes(lat, lng, 5, 'Foursquare');
          updateProgress();
        }, 1000);
        
        // 3. Simulated Google Places API (as we don't have actual API keys)
        setTimeout(() => {
          console.log("Simulating Google Places data");
          // Simulate some additional cafes
          addSimulatedCafes(lat, lng, 8, 'Google Places');
          updateProgress();
        }, 1500);
      }
      
      // Add a single cafe marker to the map
      function addCafeMarker(cafe) {
        // Create popup content
        const popupContent = `
          <div style="width: 220px;">
            <h3 style="margin: 0 0 5px 0; color: #8c67ff;">${cafe.name}</h3>
            <p style="margin: 0 0 5px 0; color: #666; font-size: 12px;">${cafe.type} • ${cafe.source}</p>
            ${cafe.address ? `<p style="margin: 0 0 8px 0; font-size: 13px;">${cafe.address}</p>` : ''}
            ${cafe.hours ? `<p style="margin: 0 0 8px 0; font-size: 12px;">Hours: ${cafe.hours}</p>` : ''}
            <div style="display: flex; gap: 10px; font-size: 12px; margin-bottom: 8px;">
              <span>WiFi: ${cafe.wifi}</span>
              <span>Power: ${cafe.power}</span>
            </div>
            <div style="display: flex; gap: 5px;">
              <a href="https://www.google.com/maps/dir/?api=1&destination=${cafe.lat},${cafe.lng}" 
                 target="_blank" 
                 style="text-decoration: none; background: #4f46e5; color: white; padding: 6px 10px; border-radius: 4px; font-size: 12px;">
                Directions
              </a>
              <button onclick="selectCafeForReview('${cafe.name.replace(/'/g, "\\'")}')" 
                      style="background: #8c67ff; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                Review
              </button>
            </div>
          </div>
        `;
        
        // Create marker
        const marker = L.marker([cafe.lat, cafe.lng], {
          title: cafe.name,
          icon: createCustomIcon('☕', '#8c67ff')
        }).addTo(map);
        
        // Add popup
        marker.bindPopup(popupContent);
        
        // Add to markers array
        cafeMarkers.push(marker);
        
        return marker;
      }
      
      // Add simulated cafes for demo purposes
      function addSimulatedCafes(centerLat, centerLng, count, source = 'Simulated') {
        for (let i = 0; i < count; i++) {
          // Generate random position within ~1.5km
          const lat = centerLat + (Math.random() - 0.5) * 0.03;
          const lng = centerLng + (Math.random() - 0.5) * 0.03;
          
          // Random cafe names
          const cafeNames = [
            'Brew Haven', 'Coffee Culture', 'The Daily Grind', 'Espresso Express',
            'Bean & Gone', 'The Roasted Bean', 'Caffeine Fix', 'Latte Lounge',
            'The Coffee House', 'Java Junction', 'Mocha Magic', 'Study Cafe',
            'Focus Brew', 'The Book Cafe', 'Student Corner', 'Academic Cafe'
          ];
          
          const cafeTypes = ['Cafe', 'Coffee Shop', 'Study Space', 'Bakery & Cafe'];
          const wifiOptions = ['Yes', 'Yes (Free)', 'Yes (Password Required)', 'Unknown'];
          const powerOptions = ['Yes', 'Limited', 'Unknown'];
          const hours = ['7 AM - 10 PM', '8 AM - 9 PM', '6 AM - 11 PM', '24/7', 'Not specified'];
          
          // Create cafe object
          const cafeObj = {
            id: `sim-${source}-${i}`,
            name: cafeNames[Math.floor(Math.random() * cafeNames.length)],
            lat: lat,
            lng: lng,
            type: cafeTypes[Math.floor(Math.random() * cafeTypes.length)],
            address: `${Math.floor(Math.random() * 100) + 1} Main St`,
            wifi: wifiOptions[Math.floor(Math.random() * wifiOptions.length)],
            power: powerOptions[Math.floor(Math.random() * powerOptions.length)],
            hours: hours[Math.floor(Math.random() * hours.length)],
            source: source
          };
          
          // Check if a cafe with similar name and location already exists
          const isDuplicate = allCafes.some(c => 
            Math.abs(c.lat - cafeObj.lat) < 0.0005 && 
            Math.abs(c.lng - cafeObj.lng) < 0.0005
          );
          
          if (!isDuplicate) {
            allCafes.push(cafeObj);
            addCafeMarker(cafeObj);
          }
        }
      }
      
      // Add marker clustering for better performance with many markers
      function addMarkerClustering() {
        // Create marker cluster group
        const markers = L.markerClusterGroup({
          showCoverageOnHover: false,
          maxClusterRadius: 50,
          iconCreateFunction: function(cluster) {
            return L.divIcon({
              html: `<div style="background-color: #8c67ff; color: white; width: 40px; height: 40px; 
                     border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                     box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${cluster.getChildCount()}</div>`,
              className: '',
              iconSize: [40, 40]
            });
          }
        });
        
        // Add all markers to the cluster
        cafeMarkers.forEach(marker => {
          map.removeLayer(marker);
          markers.addLayer(marker);
        });
        
        // Add the cluster to the map
        map.addLayer(markers);
        markerCluster = markers;
      }
      
      // Add search box to the map
      function addSearchBox() {
        const searchControl = L.control({position: 'topleft'});
        
        searchControl.onAdd = function() {
          const div = L.DomUtil.create('div', 'search-control');
          div.innerHTML = `
            <div style="background: white; padding: 8px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
              <input type="text" id="map-search" placeholder="Search cafes..." 
                     style="width: 200px; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
          `;
          return div;
        };
        
        searchControl.addTo(map);
        
        // Prevent map interactions when using the search box
        const searchInput = document.getElementById('map-search');
        L.DomEvent.disableClickPropagation(searchInput);
        L.DomEvent.disableScrollPropagation(searchInput);
        
        // Add search functionality
        searchInput.addEventListener('input', function() {
          const searchText = this.value.toLowerCase();
          
          cafeMarkers.forEach((marker, i) => {
            const cafe = allCafes[i];
            if (cafe && cafe.name.toLowerCase().includes(searchText)) {
              marker.setOpacity(1);
            } else {
              marker.setOpacity(0.3);
            }
          });
          
          // Update the dropdown list as well
          updateCafeList(searchText);
        });
      }
      
      // Update the cafe list dropdown
      function updateCafeList(searchText = '') {
        // Clear existing options
        cafeList.innerHTML = '';
        
        // Sort cafes alphabetically
        const sortedCafes = [...allCafes].sort((a, b) => a.name.localeCompare(b.name));
        
        // Add options to the datalist
        sortedCafes.forEach(cafe => {
          if (!searchText || cafe.name.toLowerCase().includes(searchText.toLowerCase())) {
            const option = document.createElement('option');
            option.value = cafe.name;
            option.dataset.lat = cafe.lat;
            option.dataset.lng = cafe.lng;
            cafeList.appendChild(option);
          }
        });
        
        // Add support for selecting a cafe from the dropdown
        reviewName.addEventListener('input', function() {
          const selectedCafe = allCafes.find(c => c.name === this.value);
          if (selectedCafe) {
            // Center map on selected cafe
            map.setView([selectedCafe.lat, selectedCafe.lng], 16);
            
            // Find and open the marker popup
            cafeMarkers.forEach(marker => {
              if (marker.getLatLng().lat === selectedCafe.lat && 
                  marker.getLatLng().lng === selectedCafe.lng) {
                marker.openPopup();
              }
            });
          }
        });
      }
      
      // Handle review submissions
      function setupReviewFunctionality() {
        reviewForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          // Get reviews from local storage
          const reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
          
          // Add the new review
          reviews.push({
            name: reviewName.value,
            rating: +document.getElementById('reviewRating').value,
            text: document.getElementById('reviewText').value,
            date: new Date().toISOString().split('T')[0]
          });
          
          // Save back to local storage
          localStorage.setItem('sb-reviews', JSON.stringify(reviews));
          
          // Render the updated reviews
          renderReviews();
          
          // Reset the form
          e.target.reset();
          
          // Show confirmation
          alert('Review added successfully!');
        });
      }
      
      // Add function to select cafe for review (called from popup)
      window.selectCafeForReview = function(cafeName) {
        reviewName.value = cafeName;
        
        // Scroll to the review form
        reviewForm.scrollIntoView({ behavior: 'smooth' });
        
        // Focus on the rating dropdown
        document.getElementById('reviewRating').focus();
      };
      
      // Initialize everything
      initializeMap();
      setupReviewFunctionality();
      renderReviews();
    }
    
    // Render reviews function (improved)
    function renderReviews() {
      const reviewsContainer = document.getElementById('cafeReviews');
      const reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
      
      // Clear existing reviews
      reviewsContainer.innerHTML = '';
      
      if (reviews.length === 0) {
        // Show empty state
        reviewsContainer.innerHTML = `
          <div class="card" style="text-align: center; padding: 2rem;">
            <h3 style="margin-bottom: 1rem; color: var(--txt-2);">No Reviews Yet</h3>
            <p>Visit a café and add your first review!</p>
          </div>
        `;
        return;
      }
      
      // Group reviews by cafe
      const reviewsByPlace = {};
      reviews.forEach(review => {
        if (!reviewsByPlace[review.name]) {
          reviewsByPlace[review.name] = [];
        }
        reviewsByPlace[review.name].push(review);
      });
      
      // Calculate average rating for each cafe
      Object.keys(reviewsByPlace).forEach(cafeName => {
        const cafeReviews = reviewsByPlace[cafeName];
        const averageRating = cafeReviews.reduce((sum, r) => sum + r.rating, 0) / cafeReviews.length;
        
        // Create a card for each cafe
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginBottom = '1rem';
        
        // Generate review HTML
        card.innerHTML = `
          <h3>${cafeName}</h3>
          <div style="color: var(--ac-warn); margin-bottom: 0.5rem; font-size: 1.2rem;">
            ${'★'.repeat(Math.round(averageRating))}${'☆'.repeat(5 - Math.round(averageRating))}
            <span style="font-size: 0.8rem; color: var(--txt-2);">(${cafeReviews.length} review${cafeReviews.length > 1 ? 's' : ''})</span>
          </div>
          <div class="reviews-list">
            ${cafeReviews.map((review, i) => `
              <div class="review" style="margin-bottom: ${i === cafeReviews.length - 1 ? '0' : '1rem'}; position: relative;">
                <div style="color: var(--ac-warn);">${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</div>
                <p style="margin: 0.3rem 0;">${review.text}</p>
                <small style="color: var(--txt-2);">${review.date || 'No date'}</small>
                <button data-cafe="${cafeName}" data-index="${i}" class="btn btn-small btn-secondary delete-review" style="position: absolute; top: 0; right: 0;">×</button>
              </div>
            `).join('')}
          </div>
        `;
        
        reviewsContainer.appendChild(card);
      });
      
      // Add event listeners to delete buttons
      reviewsContainer.querySelectorAll('.delete-review').forEach(btn => {
        btn.addEventListener('click', function() {
          const cafeName = this.dataset.cafe;
          const reviewIndex = parseInt(this.dataset.index);
          
          // Find the index in the original array
          const reviews = JSON.parse(localStorage.getItem('sb-reviews') || '[]');
          
          // Count to find the correct review in the original array
          let count = 0;
          let globalIndex = -1;
          
          for (let i = 0; i < reviews.length; i++) {
            if (reviews[i].name === cafeName) {
              if (count === reviewIndex) {
                globalIndex = i;
                break;
              }
              count++;
            }
          }
          
          if (globalIndex >= 0) {
            // Remove the review
            reviews.splice(globalIndex, 1);
            
            // Save to local storage
            localStorage.setItem('sb-reviews', JSON.stringify(reviews));
            
            // Re-render
            renderReviews();
          }
        });
      });
    }
    // GAMES
    function initGames(){
      const sel=document.getElementById('gameSelect');
      const games=[
      ['Wordle Clone', 'https://wordlegame.org/'],
    ['Hangman',      'https://hangmanwordgame.com/'],
      ['Flappy Bird',         'https://flappybird.io/'],
      ['Minesweeper',         'https://kamoroso94.github.io/minesweeper/'],      // :contentReference[oaicite:0]{index=0}
      ['Sudoku',           'https://sudoku.com/'],
      ['Connect Four',        'https://torikul007.github.io/Connect_Four/']       // :contentReference[oaicite:1]{index=1}
      ];
      games.forEach(g=>{
        const o=document.createElement('option');
        o.value=g[1]; o.textContent=g[0];
        sel.append(o);
      });
      sel.onchange=()=>document.getElementById('gameFrame').src=sel.value;
      sel.dispatchEvent(new Event('change'));
    }

    // SESSIONS
    function initSessions(){
      const getS=()=>JSON.parse(localStorage.getItem('sb-sessions')||'[]');
      const saveS=a=>localStorage.setItem('sb-sessions',JSON.stringify(a));
      const renderS=()=>{
        const ul=document.getElementById('sessionList'),a=getS();
        ul.innerHTML='';
        if(!a.length){ul.innerHTML='<li class="card">No sessions.</li>';return;}
        a.forEach((s,i)=>{
          const li=document.createElement('li');li.className='card';li.style.marginBottom='.6rem';
          li.innerHTML=`<strong>${s.topic}</strong> ${s.date} — ${s.duration} min
            <button class="btn btn-small btn-secondary" onclick="(()=>{
              const arr=getS();arr.splice(${i},1);saveS(arr);renderS();
            })()">Delete</button>`;
          ul.append(li);
        });
      };
      document.getElementById('sessionForm').addEventListener('submit',e=>{
        e.preventDefault();
        const arr=getS();
        arr.push({
          topic:document.getElementById('sessionTopic').value,
          date:document.getElementById('sessionDate').value,
          duration:+document.getElementById('sessionDuration').value
        });
        saveS(arr);renderS();e.target.reset();
      });
      renderS();
    }

    // PLANNER
    function initPlanner(){
      const getP=()=>JSON.parse(localStorage.getItem('sb-plans')||'[]');
      const saveP=a=>localStorage.setItem('sb-plans',JSON.stringify(a));
      const renderP=()=>{
        const wrap=document.getElementById('planList'),a=getP();
        wrap.innerHTML='';
        a.forEach((p,i)=>{
          const c=document.createElement('div');c.className='card';
          c.innerHTML=`<h4>${p.title}</h4><small>${p.category} — ${p.date}</small><p>${p.desc}</p>
                       <button class="btn btn-small btn-secondary delete-plan" data-index="${i}">×</button>`;
          wrap.append(c);
        });
        wrap.querySelectorAll('.delete-plan').forEach(btn=>{
          btn.onclick=()=>{
            const arr=getP();arr.splice(+btn.dataset.index,1);
            saveP(arr);renderP();
          };
        });
      };
      document.getElementById('plannerForm').addEventListener('submit',e=>{
        e.preventDefault();
        const arr=getP();
        arr.push({
          title:document.getElementById('planTitle').value,
          category:document.getElementById('planCat').value,
          desc:document.getElementById('planDesc').value,
          date:document.getElementById('planDate').value
        });
        saveP(arr);renderP();e.target.reset();
      });
      document.getElementById('planStudy').onclick=async()=>{
        const tasks=getP();
        if(!tasks.length){
          document.getElementById('plannerAdvice').textContent="Please add some tasks first.";
          return;
        }
        document.getElementById('plannerAdvice').textContent="Generating study plan…";
        const msg=`I have these tasks:\n${tasks.map(t=>`- ${t.title} (${t.category}), due ${t.date}: ${t.desc}`).join('\n')}\n\nPlease give me a day-by-day schedule.`;
        try{
          const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
          const d=await res.json();
          let out=d.reply||'No advice.';
          out=out.replace(/\b(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday):/g,m=>`\n\n📅 ${m}`);
          out=out.replace(/^\s*[-*]\s+/gm,'• ');
          document.getElementById('plannerAdvice').textContent=out;
        }catch{
          document.getElementById('plannerAdvice').textContent="Error—please try again.";
        }
      };
      renderP();
    }

    // CHAT
    function initChat(){
      const tog=document.getElementById('chatToggle'),
            w=document.getElementById('chatWidget'),
            cl=document.getElementById('chatClose');
      tog.onclick=()=>w.classList.toggle('open');
      cl.onclick=()=>w.classList.remove('open');
      document.getElementById('chatInput').addEventListener('submit',async e=>{
        e.preventDefault();
        const inp=e.target.querySelector('input'),txt=inp.value.trim();
        if(!txt) return;
        addChat('me',txt); inp.value='';
        addChat('bot','...');
        try{
          const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:txt})});
          const d=await res.json();
          const ps=document.querySelectorAll('#chatBody .bot p');
          ps[ps.length-1].textContent=d.reply||"Couldn't process.";
        }catch{
          const ps=document.querySelectorAll('#chatBody .bot p');
          ps[ps.length-1].textContent="Connection error.";
        }
      });
    }
    function addChat(who,txt){
      const b=document.getElementById('chatBody'),d=document.createElement('div');
      d.className='row '+who; d.innerHTML=`<p>${txt}</p>`; b.append(d); b.scrollTop=b.scrollHeight;
    }
  </script>
</body>
</html>
